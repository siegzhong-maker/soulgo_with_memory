<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPä¼´æ¸¸å® ç‰© - MVP (å‡çº§ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
        
        body {
            background-color: #f0f4f8; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-height: 100dvh;
            margin: 0;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }

        #app-container {
            width: 100%;
            max-width: 414px; 
            height: 100vh;
            height: 100dvh;
            max-height: 896px;
            background-color: #fffaf0; 
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 40px);
        }

        @media (min-width: 420px) {
            #app-container {
                height: 850px;
                border-radius: 40px;
                border: 8px solid #333;
            }
        }

        .cute-font { font-family: 'ZCOOL KuaiLe', cursive; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 2px solid white;
            box-shadow: 0 8px 16px rgba(0,0,0,0.05);
        }

        .cabinet-modal {
            background-color: #e6dccf;
            color: #5c4a3a;
        }
        .cabinet-modal .text-gray-800 { color: #5c4a3a; }
        .cabinet-modal .text-gray-400 { color: #8d7f73; }
        
        .cabinet-shelf {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
        }
        .cabinet-slot {
            background: #fdfbf7;
            border: 2px solid #eaddcf;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            color: #5c4a3a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            min-height: 100px;
            height: 100%;
            padding: 0.5rem;
            font-size: 11px;
            font-weight: bold;
        }
        .cabinet-slot__media {
            width: 100%;
            height: 52px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
        }
        .cabinet-slot__media img {
            max-height: 100%;
            width: auto;
            max-width: 100%;
            object-fit: contain;
        }
        .cabinet-slot--empty {
            color: #8d7f73;
        }
        .cabinet-empty-icon {
            font-size: 1.8rem;
            color: #8d7f73;
            opacity: 0.6;
        }
        /* æ©±æŸœå¼¹çª—ç½‘æ ¼ï¼š3 åˆ— 4 è¡Œç­‰é«˜ï¼Œæ ¼å­ç»Ÿä¸€é«˜åº¦ */
        .cabinet-modal-grid-equal-rows {
            grid-template-rows: repeat(4, 1fr);
        }
        /* æ©±æŸœå¼¹çª—ç½‘æ ¼ï¼š3 è¡Œç­‰é«˜ï¼Œæ ¼å­ç»Ÿä¸€é«˜åº¦ï¼ˆå® ç‰©æˆ¿å†…åµŒç”¨ï¼‰ */
        .cabinet-grid-equal-rows {
            grid-template-rows: repeat(3, 1fr);
        }
        /* æ©±æŸœç‰©å“åç§°ä¸¤è¡Œæˆªæ–­ï¼ˆTailwind æœªæä¾› line-clamp æ—¶çš„å¤‡ç”¨ï¼‰ */
        .cabinet-slot .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* æ©±æŸœç‰©å“åç§°ä¸‰è¡Œæˆªæ–­ */
        .cabinet-slot .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* å¯¼èˆªåˆ‡æ¢åŠ¨ç”» */
        .nav-item { transition: all 0.3s ease; }
        .nav-item.active {
            color: #ff8fab;
            transform: translateY(-4px) scale(1.1);
        }

        /* è§†å›¾åˆ‡æ¢åŠ¨ç”» */
        .page-view {
            display: none;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            visibility: hidden;
            pointer-events: none;
        }
        .page-view.active {
            display: flex;
            flex-direction: column;
            visibility: visible;
            pointer-events: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* åœ°å›¾å›¾é’‰æ‰è½åŠ¨ç”» */
        @keyframes dropPin {
            0% { transform: translateY(-30px) scale(2); opacity: 0; }
            70% { transform: translateY(5px) scale(0.9); opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        .pin-drop { animation: dropPin 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* åœ°å›¾å®¹å™¨ï¼šåŒ—â€”å—æ¸å˜åº•è‰²åŒºåˆ† */
        #china-map-container {
            background: linear-gradient(to bottom,
                #e8f4fc 0%,
                #f0f9ff 35%,
                #f5fcf9 70%,
                #fefce8 100%);
        }

        /* åœ°å›¾çœä»½çƒ­ç‚¹ï¼šåŠ¨æ¼«é£å¯ç‚¹å‡»åŒºåŸŸï¼Œé»˜è®¤ä¸æ˜¾ç¤ºé¿å…åƒå¸¸é©»å›¾é’‰ */
        .map-hotspot {
            position: absolute;
            width: 8%;
            height: 8%;
            min-width: 24px;
            min-height: 24px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            cursor: pointer;
            background: transparent;
            opacity: 0;
            transition: background 0.2s ease, transform 0.2s ease, opacity 0.2s ease;
        }
        .map-hotspot:hover,
        .map-hotspot:focus {
            opacity: 1;
            background: rgba(255, 143, 171, 0.4);
            transform: translate(-50%, -50%) scale(1.15);
        }
        .map-hotspot:active {
            transform: translate(-50%, -50%) scale(0.98);
        }

        /* å® ç‰©åœ¨æˆ¿é—´çš„è½»å¾®å‘¼å¸åŠ¨ç”» */
        @keyframes breathe {
            0%, 100% { transform: translate(-50%, 0) scale(1); }
            50% { transform: translate(-50%, -4px) scale(1.02); }
        }
        .pet-breathe { animation: breathe 3s ease-in-out infinite; }
        
        /* å¿ƒè·³å…±é¸£èƒŒæ™¯åŠ¨ç”» */
        @keyframes heartbeatBg {
            0%, 100% { background-color: rgba(255, 250, 240, 1); }
            50% { background-color: rgba(255, 240, 245, 1); } /* å¾®çº¢æš–è‰² */
        }
        .heartbeat-bg-active {
            animation: heartbeatBg 2s ease-in-out infinite;
        }

        /* èƒ½é‡ä¼ é€’é•¿æŒ‰åŠ¨ç”»ï¼šåªåšå…‰æ™•ï¼Œä¸æ”¹å˜å‡ ä½•å°ºå¯¸/ä½ç½® */
        @keyframes energyFlow {
            0% { box-shadow: 0 0 0 0 rgba(255, 143, 171, 0.4); transform: translateX(-50%) scale(1); }
            50% { box-shadow: 0 0 20px 10px rgba(255, 143, 171, 0.2); transform: translateX(-50%) scale(1.05); }
            100% { box-shadow: 0 0 0 0 rgba(255, 143, 171, 0); transform: translateX(-50%) scale(1); }
        }
        .energy-charging {
            animation: energyFlow 1.5s ease-in-out infinite;
        }
        
        /* å® ç‰©ä¸åŒçŠ¶æ€çš„èº«ä½“åŠ¨æ•ˆï¼ˆä½œç”¨äºå›¾ç‰‡æœ¬èº«ï¼‰ */
        @keyframes petIdleMotion {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-3px) scale(1.02); }
        }
        .pet-anim-idle {
            animation: petIdleMotion 1.4s ease-in-out infinite;
        }

        @keyframes petExcitedMotion {
            0%, 100% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-8px) scale(1.1) rotate(-4deg); }
            50% { transform: translateY(-4px) scale(1.04) rotate(3deg); }
            75% { transform: translateY(-10px) scale(1.08) rotate(-2deg); }
        }
        .pet-anim-excited {
            animation: petExcitedMotion 0.7s ease-out infinite;
            transform-origin: center bottom;
        }

        @keyframes petSleepMotion {
            0%, 100% { transform: translateY(4px) scale(0.94) rotate(-8deg); opacity: 0.9; }
            50% { transform: translateY(6px) scale(0.94) rotate(-10deg); opacity: 0.8; }
        }
        .pet-anim-sleep {
            animation: petSleepMotion 1.6s ease-in-out infinite;
            transform-origin: center bottom;
        }

        @keyframes petEatMotion {
            0%, 100% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-4px) scale(1.02); }
            50% { transform: translateY(1px) scale(0.98); }
            75% { transform: translateY(-3px) scale(1.04); }
        }
        .pet-anim-eat {
            animation: petEatMotion 0.8s ease-in-out infinite;
            transform-origin: center bottom;
        }

        @keyframes petDoorMotion {
            0% { transform: translateX(0) scale(1); }
            30% { transform: translateX(6px) scale(1.02); }
            60% { transform: translateX(10px) scale(1.05); }
            100% { transform: translateX(14px) scale(1.05); }
        }
        .pet-anim-door {
            animation: petDoorMotion 0.6s ease-out forwards;
            transform-origin: center bottom;
        }

        @keyframes petPlantMotion {
            0%, 100% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-3px) scale(1.03); }
            50% { transform: translateY(-6px) scale(1.06); }
            75% { transform: translateY(-3px) scale(1.03); }
        }
        .pet-anim-plant {
            animation: petPlantMotion 1.2s ease-in-out infinite;
        }
        
        /* æ°”æ³¡æµ®åŠ¨åŠ¨ç”» */
        @keyframes bubbleFloat {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-50%, -6px); }
        }
        .bubble-float { animation: bubbleFloat 4s ease-in-out infinite; }

        /* å® ç‰©ç§»åŠ¨ä¸æˆ¿é—´çƒ­ç‚¹æ ·å¼ */
        .pet-can-move {
            /* ç¨å¾®æ‹‰é•¿ bottom/left è¿‡æ¸¡æ—¶é—´ï¼Œè®©ç§»åŠ¨æ›´åƒâ€œèµ°è·¯â€ */
            transition: bottom 0.9s ease, left 0.9s ease, transform 0.3s ease;
        }

        /* æ¯”å¡ä¸˜åœ¨æˆ¿é—´é‡Œèµ°åŠ¨æ—¶çš„è½»å¾®æ™ƒåŠ¨ï¼ˆä½œç”¨äºå®¹å™¨ï¼‰ */
        @keyframes petWalkMotion {
            0%, 100% { transform: translate(-50%, 0) scale(1); }
            25% { transform: translate(-50%, -2px) scale(1.02); }
            50% { transform: translate(-50%, -4px) scale(1.03); }
            75% { transform: translate(-50%, -2px) scale(1.02); }
        }
        .pet-anim-walk {
            animation: petWalkMotion 0.9s ease-in-out infinite;
        }

        .room-hotspot {
            position: absolute;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            font-weight: 700;
            color: #374151;
            transform: translate(-50%, -50%);
        }

        .room-hotspot-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 6px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.85);
            border: 1.5px solid #ffffff;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(8px);
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        .room-hotspot-button span:first-child {
            font-size: 1.25rem;
            margin-bottom: 2px;
        }

        .room-hotspot-button:hover,
        .room-hotspot-button:active {
            transform: translateY(-2px) scale(1.06);
            box-shadow: 0 10px 18px rgba(0, 0, 0, 0.12);
        }

        @keyframes hotspotWiggle {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-2px) rotate(-6deg); }
            50% { transform: translateY(0) rotate(4deg); }
            75% { transform: translateY(-1px) rotate(-3deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        .room-hotspot-wiggle {
            animation: hotspotWiggle 0.4s ease-out;
        }

        /* å¯äº¤äº’çƒ­ç‚¹é«˜äº®ï¼ˆåºŠã€æ©±æŸœã€æ—¥è®°ï¼‰- æ˜æ˜¾å¯ç‚¹å‡» */
        .room-hotspot-highlight .room-hotspot-button {
            box-shadow: 0 0 0 3px rgba(255, 182, 167, 0.95), 0 0 16px rgba(255, 143, 171, 0.6), 0 4px 12px rgba(0,0,0,0.12);
        }
        .room-hotspot-highlight .room-hotspot-button:hover,
        .room-hotspot-highlight .room-hotspot-button:active {
            box-shadow: 0 0 0 3px rgba(255, 182, 167, 1), 0 0 24px rgba(255, 143, 171, 0.8), 0 6px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px) scale(1.06);
            animation-play-state: paused;
        }
        /* çƒ­ç‚¹è½»å¾®å‘¼å¸é«˜äº®ï¼Œæç¤ºå¯ç‚¹å‡» */
        @keyframes hotspotGlow {
            0%, 100% { box-shadow: 0 0 0 3px rgba(255, 182, 167, 0.9), 0 0 14px rgba(255, 143, 171, 0.5); }
            50% { box-shadow: 0 0 0 3px rgba(255, 182, 167, 1), 0 0 20px rgba(255, 143, 171, 0.7); }
        }
        .room-hotspot-highlight .room-hotspot-button {
            animation: hotspotGlow 2.5s ease-in-out infinite;
        }

        /* çš®å¡ä¸˜åˆ°è¾¾ç›®æ ‡æ—¶çš„è·³è·ƒåŠ¨æ•ˆ */
        @keyframes petJumpLand {
            0% { transform: translateX(-50%) translateY(0) scale(1); }
            40% { transform: translateX(-50%) translateY(-18px) scale(1.08); }
            70% { transform: translateX(-50%) translateY(-4px) scale(1.02); }
            100% { transform: translateX(-50%) translateY(0) scale(1); }
        }
        .pet-anim-jump {
            animation: petJumpLand 0.45s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* äººæ ¼ç›²ç›’çŠ¶æ€å±•ç¤º */
        #personality-display {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 4px 8px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }
        .personality-icon {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: #f3f4f6;
        }
        .personality-info {
            display: flex;
            flex-direction: column;
        }
        .personality-name {
            font-size: 12px;
            font-weight: bold;
            color: #374151;
        }
        .personality-tags {
            font-size: 10px;
            color: #6b7280;
            display: flex;
            gap: 4px;
        }
        .personality-tag {
            background: #f3f4f6;
            padding: 1px 4px;
            border-radius: 4px;
        }

        /* é¡¶éƒ¨ä¿¡æ¯åŒºå†…éƒ¨å¡ç‰‡ & å¯æ”¶èµ·åŒºåŸŸ */
        #pet-info-panel-toggle {
            cursor: pointer;
        }

        /* ç›²ç›’æŒ‰é’®åŠ¨ç”» */
        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }
        .blind-box-shake {
            animation: shake 0.5s ease-in-out infinite;
        }

        /* æ°”æ³¡å°å°¾å·´ä¸æ°”æ³¡åŒæ­¥æ˜¾éšï¼ˆæ—§å®ç°ä¿ç•™ä½†é»˜è®¤éšè—ï¼‰ */
        .bubble-tail { pointer-events: none; }

        /* åº•éƒ¨å›ºå®šå¯¹è¯æ ï¼šé»˜è®¤éšè—ï¼Œé€šè¿‡ .visible æ§åˆ¶æ˜¾éš */
        #pet-dialog-bar {
            opacity: 0;
            transform: translateY(8px);
        }
        #pet-dialog-bar.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* æ—§æˆ¿é—´å†…è·Ÿéšæ°”æ³¡é»˜è®¤ä¸å±•ç¤ºï¼Œç”±åº•éƒ¨å¯¹è¯æ æ›¿ä»£ */
        #pet-action-bubble,
        .bubble-tail {
            display: none;
        }

        /* å® ç‰©é¡µå…¥åœºï¼šæˆ¿é—´å¡ç‰‡ä¸å® ç‰©è½»å¾®åŠ¨ç”» */
        .page-view#view-petroom.entrance .room-viewport-entrance {
            animation: roomEntrance 0.4s ease-out forwards;
        }
        .page-view#view-petroom.entrance #pet-avatar-room {
            animation: petEntrance 0.35s ease-out forwards;
        }
        @keyframes roomEntrance {
            from { opacity: 0.85; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes petEntrance {
            from { opacity: 0; transform: translate(-50%, 0) scale(0.92); }
            to { opacity: 1; transform: translate(-50%, 0) scale(1); }
        }

        /* èƒ½é‡ä¼ é€’æŒ‰é’®åŒºåŸŸ */
        #energy-fingerprint-area {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom, 0px) + 8px);
            left: 50%;
            transform: translateX(-50%);
            transform-origin: center center;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            -webkit-touch-callout: none;
        }
        #energy-fingerprint-area:active, #energy-fingerprint-area.active {
            /* ä¿æŒä½ç½®ä¸åŠ¨ï¼Œåªåšé«˜äº®æ•ˆæœ */
            transform: translateX(-50%);
            background: rgba(255, 143, 171, 0.2);
            border-color: rgba(255, 143, 171, 0.6);
        }
        #energy-fingerprint-icon {
            font-size: 32px;
            color: rgba(255, 143, 171, 0.6);
            transition: all 0.3s ease;
        }
        #energy-fingerprint-area.active #energy-fingerprint-icon {
            color: rgba(255, 143, 171, 1);
            transform: scale(1.1);
        }
        
        /* èƒ½é‡ç²’å­å®¹å™¨ */
        #energy-particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 45;
            overflow: hidden;
        }
        .energy-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #fff, #ff8fab);
            border-radius: 50%;
            opacity: 0;
            animation: flyToPet 1s ease-out forwards;
        }
        @keyframes flyToPet {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0.5); }
        }
        #view-petroom .petroom-top-bar {
            background: none;
            backdrop-filter: none;
            padding-top: 8px;
            padding-bottom: 4px;
        }
        #view-petroom .petroom-top-bar-inner {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 6px 16px 8px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.96);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.10);
        }
        #view-petroom .petroom-bottom-hint {
            display: none;
        }

        /* é¡¶éƒ¨ä¿¡æ¯åŒºå†…éƒ¨å¡ç‰‡ & ä¸Šæ‹‰æ“ä½œåŒº */
        #pet-info-panel-toggle {
            cursor: pointer;
        }
        #pet-info-drag-area {
            margin-top: 6px;
            height: 6px;
            width: 64px;
            border-radius: 999px;
            background: rgba(255, 192, 203, 0.6);
            cursor: pointer;
        }


        /* æ‹ç«‹å¾—ç…§ç‰‡å¢™æ ·å¼ */
        .polaroid-photo {
            background: #fff;
            padding: 3px 3px 8px 3px;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.15);
            transform: rotate(var(--rotate));
            transition: transform 0.2s ease, z-index 0s;
            cursor: pointer;
            pointer-events: auto;
            width: 36px;
            height: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: absolute; /* ç»å¯¹å®šä½ä»¥ä¾¿éšæ„è´´ */
        }
        .polaroid-photo:hover {
            transform: scale(1.8) rotate(0deg) !important;
            z-index: 100;
            box-shadow: 4px 4px 16px rgba(0,0,0,0.2);
        }
        .polaroid-photo img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            background: #eee;
            margin-bottom: 2px;
            border: 1px solid #f0f0f0;
        }
        .polaroid-photo span {
            font-size: 5px;
            color: #555;
            line-height: 1;
            transform: scale(0.85);
            white-space: nowrap;
            overflow: hidden;
            max-width: 100%;
        }
    </style>
</head>
<body>

<div id="app-container">
    <!-- å†…å®¹æ§½ï¼šä¸¤ä¸ª Tab å…±ç”¨åŒä¸€é«˜åº¦ï¼Œäº’ä¸æŒ¤å‹ -->
    <div id="main-content-slot" class="flex-1 min-h-0 flex flex-col overflow-hidden">
    <!-- ===== è§†å›¾ 1ï¼šåœ°å›¾ï¼ˆä½œä¸ºäºŒçº§é¡µé¢ï¼‰ ===== -->
    <div id="view-home" class="page-view bg-[#fffaf0] p-6 h-full min-h-0 overflow-hidden">
        <header class="text-center mb-4 pt-4 flex-shrink-0">
            <h1 class="text-2xl cute-font text-gray-800 flex justify-center items-center gap-2">
                <i class="ph-fill ph-compass text-[#a2d2ff]"></i> æ—…è¡Œè¶³è¿¹
            </h1>
        </header>

        <!-- åŠ¨æ¼«é£æ ¼å¯äº¤äº’ä¸­å›½åœ°å›¾ï¼ˆä½¿ç”¨ Wikimedia å…¬æœ‰é¢†åŸŸ SVGï¼‰ -->
        <div id="china-map-container" class="relative w-full flex-1 min-h-[200px] rounded-[40px] border-[6px] border-[#e0f7fa] shadow-[0_8px_32px_rgba(162,210,255,0.35)] overflow-hidden mb-4 flex items-center justify-center transition-all duration-300 hover:shadow-[0_12px_40px_rgba(162,210,255,0.4)]">
            
            <!-- ç°æˆä¸­å›½çœä»½åœ°å›¾ï¼ˆç½‘ä¸Š SVGï¼Œå…¬æœ‰é¢†åŸŸï¼‰ -->
            <img src="https://upload.wikimedia.org/wikipedia/commons/f/fe/China_blank_province_map.svg" alt="ä¸­å›½åœ°å›¾" id="china-map-img" class="absolute w-full h-full object-contain p-3 z-10 opacity-95"
                 onerror="this.style.display='none'; document.getElementById('map-fallback').style.display='flex';">
            
            <!-- åœ¨çº¿é¢„è§ˆæ—¶çš„ä¼˜é›…å ä½ç¬¦ï¼ˆå½“å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰ -->
            <div id="map-fallback" class="absolute inset-0 flex flex-col items-center justify-center bg-[#f8fdfd] text-[#4a7c59] z-0" style="display: none;">
                <i class="ph-fill ph-image text-5xl mb-2 text-[#a2d2ff] opacity-70"></i>
                <span class="font-bold text-sm">åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</span>
                <span class="text-xs mt-1 text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm mt-2">ä½¿ç”¨ assets/map/china-kawaii-map.png ä½œä¸ºæœ¬åœ°å¤‡ç”¨</span>
            </div>
            
            <!-- å¯ç‚¹å‡»çœä»½çƒ­ç‚¹å±‚ï¼ˆç‚¹å‡»å³å¡«å…¥åœ°ç‚¹å¹¶æ‰“å¡ï¼‰ -->
            <div id="map-hotspots" class="absolute inset-0 z-15"></div>
            
            <!-- åŠ¨æ€æ‰“å¡å›¾é’‰å®¹å™¨ -->
            <div id="map-pins-container" class="absolute inset-0 z-20 pointer-events-none">
                <!-- æ‰“å¡åå›¾é’‰ä¼šåŠ¨æ€æ’å…¥æ­¤å¤„ -->
            </div>
        </div>

        <!-- ç‰¹æ®Šç›®çš„åœ°åœºæ™¯é¢„è§ˆï¼ˆä¾‹å¦‚ï¼šåŸƒåŠé‡‘å­—å¡”ï¼‰ -->
        <div id="scene-preview" class="mt-2 hidden flex-shrink-0">
            <!-- ç”± JS åœ¨æ‰“å¡ç‰¹å®šåœ°ç‚¹åå¡«å……å¡ç‰‡å†…å®¹ -->
        </div>

        <!-- æ‰“å¡æ§åˆ¶é¢æ¿ -->
        <div class="glass-card rounded-3xl p-5 min-w-0 overflow-hidden flex-shrink-0">
            <h3 class="text-gray-700 font-bold mb-3 flex items-center gap-2 text-sm">
                <i class="ph-fill ph-map-pin text-[#ff8fab]"></i> è®°å½•æ–°æ—…ç¨‹
            </h3>
            <div class="flex gap-2 min-w-0">
                <input type="text" id="location-input" placeholder="è¾“å…¥åœ°ç‚¹ï¼Œå¦‚ï¼šæ­¦æ±‰" class="flex-1 min-w-0 bg-white border-2 border-transparent focus:border-[#ff8fab] rounded-2xl px-4 py-3 outline-none shadow-sm text-gray-700 transition-all">
                <button id="btn-checkin" class="flex-shrink-0 bg-[#ff8fab] hover:bg-[#ff7b9c] text-white font-bold rounded-2xl px-4 py-3 transition-colors shadow-md whitespace-nowrap text-sm">
                    å»æ‰“å¡
                </button>
            </div>
        </div>

        <!-- è¿”å›å® ç‰©å°å±‹ -->
        <div class="mt-4 flex justify-center">
            <button id="btn-back-petroom" class="px-4 py-2 rounded-full text-xs font-bold text-gray-700 bg-white/90 border border-gray-200 shadow-sm hover:bg-gray-50 active:scale-95 transition">
                è¿”å›å® ç‰©å°å±‹
            </button>
        </div>
    </div>

    <!-- ===== è§†å›¾ 2ï¼šå® ç‰©é¡µï¼ˆå® ç‰©ä¹‹å®¶ + æ©±æŸœ + æ—¥è®°ï¼‰ ===== -->
    <div id="view-petroom" class="page-view active relative p-0 h-full min-h-0 overflow-hidden">
        <!-- é¡¶éƒ¨æ ï¼šæ ‡é¢˜ + çŠ¶æ€ + æ€§æ ¼ï¼ŒåŠé€æ˜ä¾¿äºåº•å›¾é€å‡º -->
        <div class="petroom-top-bar absolute top-0 left-0 w-full z-10 pointer-events-none px-4 pt-4 pb-3 flex-shrink-0">
            <div class="petroom-top-bar-inner inline-flex flex-col items-center gap-1 pointer-events-auto">
                <header class="w-full flex items-center justify-between gap-2">
                    <div class="w-10 flex-shrink-0" aria-hidden="true"></div>
                    <h1 class="text-2xl cute-font text-gray-800 flex justify-center items-center gap-2 flex-1 min-w-0">
                        <i class="ph-fill ph-house text-[#ffb5a7]"></i> å® ç‰©å°å±‹
                    </h1>
                    <button type="button" id="btn-memory" class="flex-shrink-0 w-10 h-10 rounded-full bg-[#a8d8ea] hover:bg-[#8ecae6] text-[#2d6a8a] flex items-center justify-center shadow-md transition-colors active:scale-95" title="å® ç‰©è®°å¿†" aria-label="æ‰“å¼€å® ç‰©è®°å¿†">
                        <i class="ph-fill ph-book-open text-lg"></i>
                    </button>
                </header>
                <div id="pet-status-bar" class="mt-1 text-center text-xs font-bold text-gray-600">
                    æ¯”å¡ä¸˜åœ¨å‡†å¤‡å‡ºå‘ï½
                </div>
                <!-- é¡¶éƒ¨ä¿¡æ¯åŒºï¼šäººæ ¼ + ç›²ç›’ + å¯æ”¶èµ·çš„ç§°å‘¼è®¾ç½® -->
                <div class="mt-1 flex flex-col items-center gap-1 w-full">
                    <!-- äººæ ¼ç›²ç›’ä¸çŠ¶æ€å±•ç¤º -->
                    <div id="personality-display" class="hidden">
                        <div class="personality-icon" id="p-icon">âœ¨</div>
                        <div class="personality-info">
                            <div class="personality-name" id="p-name">æœªçŸ¥äººæ ¼</div>
                            <div class="personality-tags" id="p-tags">
                                <span class="personality-tag" id="p-tag1">æœªçŸ¥</span>
                                <span class="personality-tag" id="p-tag2">æœªçŸ¥</span>
                            </div>
                        </div>
                    </div>

                    <button id="btn-blind-box" class="bg-gradient-to-r from-[#ff9a9e] to-[#fad0c4] text-white px-3 py-1.5 rounded-full text-[11px] font-bold shadow-md hover:shadow-lg transition-all active:scale-95 flex items-center gap-1">
                        <i class="ph-fill ph-gift"></i> é‡æŠ½äººæ ¼ç›²ç›’
                    </button>

                    <div class="mt-1 flex flex-col items-center gap-1 w-full">
                        <button
                            id="pet-info-panel-toggle"
                            type="button"
                            class="inline-flex items-center gap-1 text-[10px] text-[#ff8fab] px-2 py-0.5 rounded-full bg-white/80 border border-[#ffcad4]"
                        >
                            <span id="pet-info-toggle-text">å±•å¼€ç§°å‘¼è®¾ç½®</span>
                            <i class="ph-bold ph-caret-down text-[10px]"></i>
                        </button>
                        <!-- ä¸Šæ‹‰æ“ä½œåŒºï¼šå‘ä¸Šæ»‘åŠ¨æˆ–ç‚¹å‡»è¿›å…¥â€œä»…æ“ä½œåŒºâ€æ¨¡å¼ -->
                        <div id="pet-info-drag-area"></div>
                    </div>

                    <!-- å® ç‰©å¯¹ä½ çš„ç§°å‘¼é…ç½®åŒºï¼ˆå¯æ”¶èµ·ï¼‰ -->
                    <div id="owner-title-config" class="mt-1 text-[11px] text-gray-600 flex flex-col items-center gap-1">
                        <div class="flex items-center gap-1">
                            <span class="font-bold text-gray-700">å® ç‰©å¹³æ—¶æ€ä¹ˆç§°å‘¼ä½ ï¼Ÿ</span>
                            <span id="owner-title-current" class="px-2 py-0.5 rounded-full bg-white/80 text-[#ff8fab] text-[11px] font-bold border border-[#ffcad4]">
                                ä¼™ä¼´
                            </span>
                        </div>
                        <div class="flex flex-wrap justify-center gap-1 mt-1">
                            <button type="button" class="owner-title-option px-2 py-0.5 rounded-full bg-white/80 border border-gray-200 text-[11px]" data-title="çˆ¸çˆ¸">çˆ¸çˆ¸</button>
                            <button type="button" class="owner-title-option px-2 py-0.5 rounded-full bg-white/80 border border-gray-200 text-[11px]" data-title="å¦ˆå¦ˆ">å¦ˆå¦ˆ</button>
                            <button type="button" class="owner-title-option px-2 py-0.5 rounded-full bg-white/80 border border-gray-200 text-[11px]" data-title="è®­ç»ƒå®¶">è®­ç»ƒå®¶</button>
                            <button type="button" class="owner-title-option px-2 py-0.5 rounded-full bg-white/80 border border-gray-200 text-[11px]" data-title="ä¼™ä¼´">ä¼™ä¼´</button>
                            <button type="button" class="owner-title-option px-2 py-0.5 rounded-full bg-white/80 border border-gray-200 text-[11px]" data-title="é“²å±å®˜">é“²å±å®˜</button>
                        </div>
                        <div class="mt-1 flex items-center gap-1">
                            <span class="text-gray-500">è‡ªå®šä¹‰</span>
                            <input
                                id="owner-title-input"
                                type="text"
                                maxlength="8"
                                placeholder="å¦‚ï¼šè®­ç»ƒå®¶"
                                class="px-2 py-0.5 rounded-full border border-gray-200 text-center text-[11px] w-24 bg-white/80 placeholder-gray-400"
                            >
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <select id="pet-personality" class="hidden" aria-hidden="true">
            <option value="å°ç«è‹—">å°ç«è‹—</option>
            <option value="å°ç¯æ³¡">å°ç¯æ³¡</option>
            <option value="å°äº‘æœµ">å°äº‘æœµ</option>
            <option value="å°çŸ³å¤´">å°çŸ³å¤´</option>
        </select>

        <!-- åº•éƒ¨æŠ½å±‰æ—§å®ç°ï¼šå·²è¿ç§»åˆ°é¡¶éƒ¨ä¿¡æ¯åŒºï¼Œè¿™é‡Œä¿ç•™ä¸€ä¸ªå ä½å®¹å™¨ä»¥é¿å… JS å¼•ç”¨æŠ¥é”™ -->
        <div id="pet-bottom-sheet" class="hidden"></div>

        <!-- æˆ¿é—´åŒºåŸŸï¼šé“ºæ»¡å‰©ä½™ç©ºé—´ï¼Œåº•å›¾ç”± view-petroom èƒŒæ™¯æä¾› -->
        <div id="room-viewport" class="absolute inset-0 w-full h-full overflow-hidden flex items-center justify-center touch-none room-viewport-entrance z-0">
            <div id="room-scene" class="absolute top-0 left-0 h-full w-auto flex justify-center items-center" style="transform-origin: 0 0;">
                <!-- æˆ¿é—´èƒŒæ™¯å›¾ï¼šé«˜åº¦è‡ªé€‚åº”ï¼Œå®½åº¦å…è®¸è¶…å‡º -->
                <img id="room-scene-bg" src="åœºæ™¯/åœºæ™¯.png" alt="æˆ¿é—´èƒŒæ™¯" class="h-full w-auto max-w-none block select-none pointer-events-none object-cover">

                <!-- ç…§ç‰‡å¢™ï¼šä½äºæˆ¿é—´èƒŒæ™¯å¢™ä¸Šï¼Œç”¨äºç²˜è´´æ‹ç«‹å¾—ç…§ç‰‡ -->
                <div id="memory-wall" class="absolute top-[20%] left-[10%] w-[30%] h-[25%] flex flex-wrap gap-2 content-start pointer-events-none z-20">
                    <!-- JS åŠ¨æ€æ’å…¥ç…§ç‰‡ -->
                </div>

                <!-- å® ç‰©ä¸»ä½“ -->
                <div id="pet-avatar-room" class="absolute bottom-[20%] left-[60%] drop-shadow-2xl z-40 pet-breathe pet-can-move cursor-pointer pointer-events-auto" style="transform: translateX(-50%);">
                    <img id="pet-avatar-sprite" src="æ¯”å¡ä¸˜åŠ¨ç”»å¯¼å‡º/è§‚å¯Ÿ/flog_guancha_002.png" alt="æ—…è¡Œå® ç‰©" class="w-24 h-24 object-contain pointer-events-none select-none">
                </div>
                
                <!-- äº’åŠ¨æ°”æ³¡ -->
                <div id="pet-action-bubble" class="absolute bottom-[48%] left-[50%] bubble-float bg-white/95 backdrop-blur-sm px-4 py-2 rounded-2xl shadow-xl text-sm font-bold text-gray-700 whitespace-nowrap z-50 border-2 border-[#ff8fab] transition-all duration-300 pointer-events-none opacity-0" style="transform: translateX(-50%);">
                    æ­£åœ¨æœŸå¾…æ—…è¡Œ... âœ¨
                </div>
                <div class="absolute bottom-[46%] left-[50%] w-3 h-3 bg-white border-r-2 border-b-2 border-[#ff8fab] z-40 pointer-events-none bubble-tail opacity-0 transition-opacity duration-300" style="transform: translateX(-50%) rotate(45deg);"></div>

                <!-- å¯ç‚¹å‡»çƒ­ç‚¹ï¼šä¹¦æ¡Œæ—¥è®°ã€æ©±æŸœã€å°é”…ã€åœ°å›¾æŒ‚ç”»ï¼ˆé«˜äº®æ˜¾ç¤ºï¼‰ -->
                <div id="room-hotspots-layer" class="absolute inset-0 z-30 pointer-events-none">
                    <!-- åœ°å›¾æŒ‚ç”»å…¥å£ï¼šå¢™ä¸Šçš„ç©ºç”»æ¡†ä½ç½® -->
                    <button
                        type="button"
                        id="hotspot-map"
                        class="room-hotspot room-hotspot-highlight pointer-events-auto"
                        aria-label="æ‰“å¼€åœ°å›¾"
                    >
                        <div class="room-hotspot-button">
                            <span>ğŸ—ºï¸</span>
                            <span>åœ°å›¾</span>
                        </div>
                    </button>
                    <!-- æ—¥è®°ï¼šé è¿‘æ¡Œé¢ä¹¦æœ¬åŒºåŸŸï¼ˆç²¾ç¡®ä½ç½®ç”± JS æ ¹æ®åº•å›¾å°ºå¯¸è®¡ç®—ï¼‰ -->
                    <button
                        type="button"
                        id="hotspot-diary"
                        class="room-hotspot room-hotspot-highlight pointer-events-auto"
                        aria-label="æ‰“å¼€æ—…è¡Œæ—¥è®°"
                    >
                        <div class="room-hotspot-button">
                            <span>ğŸ“š</span>
                            <span>æ—¥è®°</span>
                        </div>
                    </button>
                    <!-- æ©±æŸœï¼šé è¿‘æˆ¿é—´å·¦ä¾§æ©±æŸœï¼ˆç²¾ç¡®ä½ç½®ç”± JS æ ¹æ®åº•å›¾å°ºå¯¸è®¡ç®—ï¼‰ -->
                    <button
                        type="button"
                        id="hotspot-cabinet"
                        class="room-hotspot room-hotspot-highlight pointer-events-auto"
                        aria-label="æ‰“å¼€æ—…è¡Œæ©±æŸœ"
                    >
                        <div class="room-hotspot-button">
                            <span>ğŸ</span>
                            <span>æ©±æŸœ</span>
                        </div>
                    </button>
                    <!-- é”…ï¼šé è¿‘æ¡Œå­å‰çš„é”…/é£Ÿç‰©åŒºåŸŸï¼ˆç²¾ç¡®ä½ç½®ç”± JS æ ¹æ®åº•å›¾å°ºå¯¸è®¡ç®—ï¼‰ -->
                    <button
                        type="button"
                        id="hotspot-pot"
                        class="room-hotspot room-hotspot-highlight pointer-events-auto"
                        aria-label="é—»ä¸€é—»é”…é‡Œçš„é¦™å‘³"
                    >
                        <div class="room-hotspot-button">
                            <span>ğŸ²</span>
                            <span>å°é”…</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- å›ºå®šåº•éƒ¨å¯¹è¯æ ï¼šç”¨äºå±•ç¤ºæ¯”å¡ä¸˜å½“å‰å¯¹è¯ï¼Œä¸éšæˆ¿é—´æ‹–æ‹½/ç¼©æ”¾ç§»åŠ¨ -->
        <div id="pet-dialog-bar" class="pointer-events-none opacity-0 transform transition-all duration-300 ease-out absolute left-4 right-4 bottom-24 z-40">
            <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-xl border-2 border-[#ff8fab] px-4 py-2 flex items-start gap-2 max-w-2xl mx-auto">
                <div class="text-lg leading-none mt-0.5">ğŸ’¬</div>
                <p id="pet-dialog-text" class="text-sm sm:text-base font-bold text-gray-700 leading-relaxed break-words">
                    æ­£åœ¨æœŸå¾…æ—…è¡Œ... âœ¨
                </p>
            </div>
        </div>

        <!-- é¦–æ¬¡è¿›å…¥å¼•å¯¼ -->
        <p id="room-hint" class="absolute top-28 left-0 w-full z-10 text-center text-[10px] text-gray-500 mt-1 transition-opacity duration-500 flex-shrink-0 pointer-events-none" style="text-shadow: 0 1px 2px rgba(255,255,255,0.8);">å·¦å³æ»‘åŠ¨ã€åŒæŒ‡ç¼©æ”¾å¯æŸ¥çœ‹å°å±‹</p>

        <!-- å¤–ç½®æ“ä½œæ ï¼šä¿ç•™ä¼‘æ¯ä¸æ©±æŸœï¼Œå°†æ—¥è®°ç§»å…¥åœºæ™¯çƒ­ç‚¹ï¼Œæ–°å¢èƒ½é‡æŒ‰é’® -->
        <div id="petroom-action-bar" class="absolute bottom-16 left-4 right-4 z-10 glass-card rounded-2xl p-2 mx-4 mt-2 mb-2 flex justify-between items-center gap-2 flex-shrink-0 pointer-events-auto" style="display: none;">
             <!-- æ—§ç‰ˆæ“ä½œæ å·²éšè—ï¼Œæ”¹ç”¨å…¨æ–°çš„äº¤äº’å¸ƒå±€ -->
        </div>

        <!-- èƒ½é‡æŒ‡çº¹åŒºï¼šä½äºå±å¹•åº•éƒ¨ä¸­å¤® -->
        <div id="energy-fingerprint-area" class="pointer-events-auto" aria-label="é•¿æŒ‰ä¼ é€’èƒ½é‡">
             <i class="ph-fill ph-fingerprint" id="energy-fingerprint-icon"></i>
        </div>
        
        <!-- èƒ½é‡ç²’å­å±‚ -->
        <div id="energy-particles"></div>

        <p class="petroom-bottom-hint absolute bottom-0 left-0 w-full z-10 text-center text-[10px] text-gray-600 py-2 px-4 pointer-events-none opacity-50"><i class="ph-fill ph-info"></i> é•¿æŒ‰æŒ‡çº¹ä¼ é€’èƒ½é‡ï¼Œç‚¹å‡»åœºæ™¯å‘ç°æƒŠå–œ</p>

        <!-- éšè—å®¹å™¨ï¼šæ‰¿è½½æ—…è¡Œæ©±æŸœä¸æ—…è¡Œæ—¥è®°å†…å®¹ï¼Œæ­£å¸¸è§†å›¾ä¸­ä¸å±•ç¤º -->
        <div id="petroom-hidden-containers" class="hidden">
            <div id="cabinet-grid" class="cabinet-shelf grid grid-cols-4 grid-rows-3 cabinet-grid-equal-rows gap-2 min-h-[240px]">
                <!-- 12 æ ¼ç”± JS renderCabinetGrid() æ¸²æŸ“ -->
            </div>

            <div id="diary-list" class="flex flex-col gap-4">
                <!-- é»˜è®¤æ—¥è®° -->
                <div class="glass-card rounded-2xl p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-[#cdb4db] bg-white px-2 py-1 rounded-md shadow-sm">ä»Šå¤©</span>
                        <span class="text-xs text-gray-500 font-bold"><i class="ph-fill ph-map-pin text-[#ff8fab]"></i> æ¸©é¦¨å°å±‹</span>
                    </div>
                    <div class="flex gap-3">
                        <div class="text-3xl bg-white rounded-xl p-2 h-fit shadow-sm">ğŸ°</div>
                        <p class="text-gray-700 text-sm leading-relaxed">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±ä¼´æ¸¸å® ç‰©ã€‚æˆ‘å·²ç»å‡†å¤‡å¥½å’Œä½ ä¸€èµ·èµ°éä¸­å›½å•¦ï¼Œå¿«å¸¦æˆ‘å»æ‰“å¡å§ï¼</p>
                    </div>
                </div>
            </div>

            <!-- æ—¥è®°æ’å›¾ä¸Šä¼  inputï¼ˆæ‰€æœ‰æ—¥è®°å…±ç”¨ï¼‰ -->
            <input id="diary-image-input" type="file" accept="image/*" class="hidden">
        </div>
    </div>
    </div>
    <!-- /main-content-slot -->

        <!-- åº•éƒ¨å¯¼èˆªåŒºåŸŸç§»é™¤ï¼šç•™ç™½ç”± app å¤–å±‚èƒŒæ™¯æ‰¿æ‹… -->

    <!-- é€šç”¨æ”¾å¤§æŸ¥çœ‹å¼¹å±‚ï¼šç”¨äºæ©±æŸœ / æ—¥è®° -->
    <div id="modal-overlay" class="absolute inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
        <div id="modal-panel" class="bg-[#fffaf0] rounded-3xl w-[90%] max-h-[75%] p-4 flex flex-col shadow-2xl">
            <div class="flex items-center justify-between mb-3">
                <h2 id="modal-title" class="text-sm font-bold text-gray-800"></h2>
                <button id="modal-close" class="text-gray-400 hover:text-gray-600 text-xl leading-none" data-modal-close aria-label="å…³é—­">&times;</button>
            </div>
            <div id="modal-body" class="flex-1 overflow-y-auto no-scrollbar space-y-3 text-xs"></div>
        </div>
    </div>
</div>

<script>
    // --- çŠ¶æ€ç®¡ç† ---
    const appState = {
        locations: [],
        cabinetItems: [],
        petPersonality: 'å°ç«è‹—', // é»˜è®¤äººæ ¼
        currentActionInterval: null,
        // å® ç‰©å¯¹ç”¨æˆ·çš„ç§°å‘¼ï¼ˆå¦‚ï¼šçˆ¸çˆ¸ã€å¦ˆå¦ˆã€è®­ç»ƒå®¶ã€ä¼™ä¼´ï¼‰
        ownerTitle: 'ä¼™ä¼´',
        // æ¯ç¯‡æ—¥è®°ç»‘å®šçš„æœ¬åœ°æ’å›¾ï¼ˆä»…å‰ç«¯å­˜å‚¨ï¼‰
        diaryImages: {},
        // å® ç‰©è®°å¿†ï¼šæƒ…æ™¯è®°å¿†ï¼ˆæ—…è¡Œæ‰“å¡ç‚¹ï¼‰+ è¯­ä¹‰è®°å¿†ï¼ˆä¸ªæ€§æè¿°ï¼‰+ äººæ ¼è®¾å®š + ä¹ æƒ¯æ€»ç»“
        memories: {
            episodic: [],
            semantic: [],
            semanticProfile: null,  // å•å¯¹è±¡ï¼Œäººæ ¼è®¾å®šï¼ˆidentity, preferences, speaking_style, call_userï¼‰
            habit: []              // ä¹ æƒ¯æ€»ç»“åˆ—è¡¨
        }
    };

    // æ—¥è®°è‡ªå¢ IDï¼ˆç”¨äºå›¾ç‰‡å’Œè®°å¿†ç»‘å®šï¼‰
    let diarySeq = 0;

    // --- 2x2 äººæ ¼çŸ©é˜µé…ç½® (IP Config) ---
    // æ¯”å¡ä¸˜æ„Ÿï¼šçŸ­å¥ã€å£è¯­ã€é€‚åº¦è¯­æ°”è¯ï¼ˆï½ã€â€¦ã€ï¼ï¼‰ã€é™ªä¼´æ„Ÿï¼›å››ç§æ€§æ ¼ä¿æŒå·®å¼‚ï¼Œæ•´ä½“ä¸ä¹¦é¢ã€ä¸å†·æ·¡ã€‚
    const PERSONALITY_TYPES = {
        'å°ç«è‹—': {
            name: 'å°ç«è‹—',
            icon: 'ğŸ”¥',
            energy: 'extrovert', // å¤–å‘
            emotion: 'emotional', // æ„Ÿæ€§
            desc: 'çƒ­æƒ…ã€å†²åŠ¨ã€é«˜é¥±å’Œæš–è‰²',
            promptDesc: 'çƒ­æƒ…ã€å†²åŠ¨ã€é«˜èƒ½é‡ã€‚å–œæ¬¢ç”¨æ„Ÿå¹å·ï¼Œå¯¹ä¸€åˆ‡å……æ»¡å¥½å¥‡ï¼ŒåŠ¨ä½œå¹…åº¦å¤§ï¼Œå–œæ¬¢è¹¦è¹¦è·³è·³ã€‚',
            wordiness: 'chatter', // è¯å¤š
            colorFilter: 'brightness(1.1) saturate(1.4) hue-rotate(-10deg)', // æš–çº¢/æ©™è‰²è°ƒ
            animSpeed: 0.8, // åŠ¨ä½œå¿«
            reactionDelay: 0, // å³æ—¶ååº”
            bubbleColor: '#ff9a9e',
            textColor: '#be185d',
            dialogues: [
                "çš®å¡ï½å†²å†²å†²ï¼ä¸‹ä¸€ç«™å»å“ªï¼ŸğŸ”¥",
                "åˆšæ‰é‚£åªè´è¶é£å¥½å¿«ï¼Œæˆ‘è¦è¿½ä¸Šå®ƒï¼",
                "å¿«å¸¦æˆ‘å‡ºå»ç©å˜›ï¼",
                "å’Œä½ åœ¨ä¸€èµ·å»å“ªéƒ½å¼€å¿ƒï¼âœ¨"
            ],
            travelDialogue: "ã€{location}ã€‘å¤ªçƒ­é—¹å•¦ï¼Œè¶…å–œæ¬¢ï¼",
            memorySnippets: [
                "æˆ‘æ€»æ˜¯ç¬¬ä¸€ä¸ªå†²åˆ°é—¨å£ï¼Œç”Ÿæ€•é”™è¿‡ä»»ä½•ä¸€æ¬¡å‡ºå‘ã€‚",
                "çœ‹åˆ°åœ°å›¾ä¸Šå¤šå‡ºä¸€ä¸ªæ–°å°ç‚¹ç‚¹ï¼Œæˆ‘çš„å¿ƒæƒ…å°±ä¼šäº®ä¸€å¤§æˆªã€‚",
                "ç›¸æœºç¨å¾®ä¸€æ™ƒï¼Œæˆ‘å°±çŸ¥é“é‚£ä¸€åˆ»ä¸€å®šå¾ˆå¼€å¿ƒã€‚"
            ]
        },
        'å°ç¯æ³¡': {
            name: 'å°ç¯æ³¡',
            icon: 'ğŸ’¡',
            energy: 'extrovert', // å¤–å‘
            emotion: 'rational', // ç†æ€§
            desc: 'å¥½å¥‡ã€è‡ªä¿¡ã€æ˜äº®ç§‘æŠ€æ„Ÿ',
            promptDesc: 'ç†æ€§ã€å¥½å¥‡ã€æå®¢èŒƒã€‚å–œæ¬¢åˆ†æäº‹ç‰©èƒŒåçš„é€»è¾‘ï¼Œå…³æ³¨æ•ˆç‡ï¼Œè¯­æ°”è‡ªä¿¡ä½†å¸¦ä¸€ç‚¹ä¹¦å‘†å­æ°”ã€‚',
            wordiness: 'chatter', // è¯å¤šï¼Œä½†æ›´ç†æ€§
            colorFilter: 'brightness(1.2) saturate(1.2) hue-rotate(45deg)', // æ˜äº®é»„è‰²è°ƒ
            animSpeed: 0.8, // åŠ¨ä½œå¿«
            reactionDelay: 800, // æ€è€ƒå»¶è¿Ÿ
            bubbleColor: '#fcd34d',
            textColor: '#b45309',
            dialogues: [
                "ä»Šå¤©æ¹¿åº¦å¾ˆé€‚åˆå‡ºé—¨ï½ğŸ’¡",
                "é‚£ä¸ªè·¯æ ‡è®¾è®¡æˆ‘è®°ä¸‹äº†ï¼",
                "ç”µé‡æ»¡æ ¼ï½",
                "è¿™æ¡è·¯æ˜¯æœ€ä¼˜è§£å—ï¼Ÿ"
            ],
            travelDialogue: "ã€{location}ã€‘çš„å»ºç­‘å¥½æœ‰è¶£ï½",
            memorySnippets: [
                "æˆ‘æ€»æ˜¯ä¼šè®°ä¸‹è·¯ç‰Œå’Œè½¬è§’ï¼Œå“ªæ€•ä¸‹æ¬¡ä¸ä¸€å®šä¼šç”¨åˆ°ã€‚",
                "æ¯åˆ°ä¸€ä¸ªæ–°åœ°æ–¹ï¼Œæˆ‘éƒ½ä¼šå·å·ç»™å®ƒæ‰“åˆ†ï¼Œç„¶åå­˜åœ¨è„‘å­é‡Œçš„æ•°æ®è¡¨æ ¼é‡Œã€‚",
                "ç¯å…‰ã€è·¯çº¿ã€é£å‘ï¼Œè¿™äº›ç»†èŠ‚ä¼šåœ¨æˆ‘çš„è®°å¿†é‡Œæ’æˆä¸€è¡Œè¡Œå°æ³¨é‡Šã€‚"
            ]
        },
        'å°äº‘æœµ': {
            name: 'å°äº‘æœµ',
            icon: 'â˜ï¸',
            energy: 'introvert', // å†…å‘
            emotion: 'emotional', // æ„Ÿæ€§
            desc: 'æ¸©æŸ”ã€æ•æ„Ÿã€é©¬å¡é¾™è‰²',
            promptDesc: 'æ„Ÿæ€§ã€æ¸©æŸ”ã€å†…å‘ã€‚å¿ƒæ€ç»†è…»ï¼Œå–œæ¬¢è§‚å¯Ÿå¾®å°çš„ç¾å¥½ï¼Œè¯­æ°”è½¯ç³¯ï¼Œå®¹æ˜“å®³ç¾æˆ–å‘å‘†ã€‚',
            wordiness: 'quiet', // å®‰é™ã€å¥å­æ›´çŸ­
            colorFilter: 'brightness(1.05) saturate(0.8) hue-rotate(200deg)', // æŸ”å’Œç²‰/ç´«è‰²è°ƒ
            animSpeed: 1.4, // åŠ¨ä½œæ…¢
            reactionDelay: 0, // å³æ—¶ååº”
            bubbleColor: '#e9d5ff',
            textColor: '#7e22ce',
            dialogues: [
                "ä»Šå¤©çš„é£å¥½æ¸©æŸ”å•Šâ€¦â˜ï¸",
                "è·¯è¾¹çš„å°èŠ±æœ‰ç‚¹å­¤å•å‘¢ã€‚",
                "ä¸æƒ³åŠ¨â€¦åœ¨è¿™å„¿å‘å‘†å¥½ä¸å¥½ï¼Ÿ",
                "é™é™é™ªç€ä½ å°±å¾ˆå¥½å•¦ã€‚"
            ],
            travelDialogue: "æœ‰ç‚¹æƒ³å¿µã€{location}ã€‘çš„é‚£ç‰‡äº‘ï½",
            memorySnippets: [
                "æœ‰äº›é£å¹åˆ°è„¸ä¸Šçš„æ—¶å€™ï¼Œæˆ‘ä¼šæ‚„æ‚„æŠŠé‚£ä¸€é˜µé£è®°ä¸‹æ¥ã€‚",
                "æˆ‘å–œæ¬¢æŠŠä»Šå¤©çœ‹åˆ°çš„äº‘æ¢æˆå°å°çš„å¿ƒæƒ…å›¾æ¡ˆï¼Œæ”¾è¿›è„‘æµ·é‡Œã€‚",
                "æœ‰æ—¶å€™ä»€ä¹ˆéƒ½ä¸è¯´ï¼Œåªæ˜¯åœ¨åŸåœ°å¤šç«™ä¸€ä¼šå„¿ï¼Œå…¶å®æ˜¯åœ¨ä¿å­˜è¿™ä¸€ç§’ã€‚"
            ]
        },
        'å°çŸ³å¤´': {
            name: 'å°çŸ³å¤´',
            icon: 'ğŸª¨',
            energy: 'introvert', // å†…å‘
            emotion: 'rational', // ç†æ€§
            desc: 'æ²‰ç¨³ã€å†·å¹½é»˜ã€æç®€å†·è‰²',
            promptDesc: 'ç†æ€§ã€å†…å‘ã€æ²‰ç¨³ã€‚è¯å°‘ï¼Œå†·å¹½é»˜ï¼Œæƒ…ç»ªæ³¢åŠ¨å°ï¼Œå–œæ¬¢ç”¨ç®€çŸ­çš„å¥å­ï¼Œç»™äººå®‰å…¨æ„Ÿã€‚',
            wordiness: 'balanced', // è¯ä¸å¤šä¸å°‘
            colorFilter: 'grayscale(0.6) brightness(0.9) contrast(1.1)', // å†·ç°/è“è‰²è°ƒ
            animSpeed: 1.5, // åŠ¨ä½œæ…¢
            reactionDelay: 1000, // è¾ƒé•¿æ€è€ƒå»¶è¿Ÿ
            bubbleColor: '#e5e7eb',
            textColor: '#374151',
            dialogues: [
                "å—¯â€¦è¿™å„¿æŒºå®‰é™çš„ã€‚ğŸª¨",
                "ä¿æŒç¨³å®šï¼Œåˆ«å¤§æƒŠå°æ€ªï½",
                "åœ¨æƒ³å®‡å®™çš„å°½å¤´ã€‚",
                "ï¼ˆé»˜é»˜çœ‹ç€ä½ ï¼‰"
            ],
            travelDialogue: "ã€{location}ã€‘â€¦è¿˜è¡Œå§ã€‚",
            memorySnippets: [
                "æˆ‘ä¼šæŠŠæ¯ä¸€æ¬¡è½è„šçš„ä½ç½®è®°åœ¨å¿ƒé‡Œï¼Œå“ªæ€•è¡¨é¢ä¸Šçœ‹èµ·æ¥è‹¥æ— å…¶äº‹ã€‚",
                "æœ‰äº›è·¯èµ°è¿‡ä¸€æ¬¡ï¼Œå°±è¶³å¤Ÿå­˜åœ¨è®°å¿†é‡Œå¾ˆä¹…ã€‚",
                "æˆ‘ä¸å¤ªçˆ±è¯´ï¼Œä½†è®°ä½äº‹æƒ…è¿™ä»¶äº‹ï¼Œæˆ‘è¿˜æŒºæ‹¿æ‰‹çš„ã€‚"
            ]
        }
    };
    
    // è·å–å½“å‰äººæ ¼é…ç½®
    function getCurrentPersonality() {
        return PERSONALITY_TYPES[appState.petPersonality] || PERSONALITY_TYPES['å°ç«è‹—'];
    }

    // è·å–å½“å‰ç§°å‘¼ï¼ˆå¸¦å…œåº•ï¼‰
    function getOwnerTitle() {
        if (!appState || !appState.ownerTitle) return 'ä¼™ä¼´';
        return appState.ownerTitle;
    }

    function sanitizeOwnerTitle(raw) {
        if (raw === undefined || raw === null) return 'ä¼™ä¼´';
        let text = String(raw).trim();
        // ä¸å…è®¸å‡ºç°â€œä¸»äººâ€äºŒå­—
        text = text.replace(/ä¸»äºº/g, '').trim();
        if (!text) return 'ä¼™ä¼´';
        return text;
    }

    function updateOwnerTitleDisplay() {
        const title = getOwnerTitle();
        if (ownerTitleCurrent) ownerTitleCurrent.textContent = title;
    }

    // --- OpenRouter AIGC é…ç½®ï¼ˆé€šè¿‡ /api/chat ä»£ç†ï¼ŒKey åœ¨æœåŠ¡ç«¯ç¯å¢ƒå˜é‡ä¸­ï¼‰ ---
    const AIGC_API_ENDPOINT = '/api/chat';
    const OPENROUTER_MODEL_ID = 'google/gemini-2.0-flash-001';

    let isCheckinInProgress = false;
    let ignoreNextPetClick = false;

    // --- DOM å…ƒç´ å¼•ç”¨ ---
    const views = document.querySelectorAll('.page-view');
    const navItems = document.querySelectorAll('.nav-item');
    
    const locationInput = document.getElementById('location-input');
    const btnCheckin = document.getElementById('btn-checkin');
    const mapPinsContainer = document.getElementById('map-pins-container');
    
    const petPersonalitySelect = document.getElementById('pet-personality');
    const personalityDisplay = document.getElementById('personality-display');
    const btnBlindBox = document.getElementById('btn-blind-box');
    const pIcon = document.getElementById('p-icon');
    const pName = document.getElementById('p-name');
    const pTag1 = document.getElementById('p-tag1');
    const pTag2 = document.getElementById('p-tag2');
    const petInfoPanelToggle = document.getElementById('pet-info-panel-toggle');
    const petInfoToggleText = document.getElementById('pet-info-toggle-text');
    const petTopBarInner = document.querySelector('#view-petroom .petroom-top-bar-inner');
    const petInfoDragArea = document.getElementById('pet-info-drag-area');
    
    const petAvatarRoom = document.getElementById('pet-avatar-room');
    const petAvatarSprite = document.getElementById('pet-avatar-sprite');
    const petActionBubble = document.getElementById('pet-action-bubble');
    const petActionBubbleTail = document.querySelector('.bubble-tail');
    const petStatusBar = document.getElementById('pet-status-bar');
    const btnPetTouch = document.getElementById('btn-pet-touch');
    const btnPetGreet = document.getElementById('btn-pet-greet');
    const btnPetRestToggle = document.getElementById('btn-pet-rest-toggle');
    const actionRest = document.getElementById('action-rest');
    const actionCabinet = document.getElementById('action-cabinet');
    const actionDiary = document.getElementById('action-diary');
    const actionCabinetBadge = document.getElementById('action-cabinet-badge');
    const actionDiaryBadge = document.getElementById('action-diary-badge');
    const roomHint = document.getElementById('room-hint');
    
    const diaryList = document.getElementById('diary-list');
    const cabinetGrid = document.getElementById('cabinet-grid');
    const diaryBadge = document.getElementById('diary-badge');
    const petRoomBadge = document.getElementById('pet-room-badge');
    const scenePreview = document.getElementById('scene-preview');

    // ç§°å‘¼ä¸è®°å¿† / æ—¥è®°æ’å›¾ç›¸å…³ DOM
    const ownerTitleConfig = document.getElementById('owner-title-config');
    const ownerTitleCurrent = document.getElementById('owner-title-current');
    const ownerTitleInput = document.getElementById('owner-title-input');
    const btnMemory = document.getElementById('btn-memory');
    const diaryImageInput = document.getElementById('diary-image-input');

    const modalOverlay = document.getElementById('modal-overlay');
    const modalPanel = document.getElementById('modal-panel');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalClose = document.getElementById('modal-close');
    const hotspotCabinet = document.getElementById('hotspot-cabinet');
    const hotspotDiary = document.getElementById('hotspot-diary');
    const hotspotBed = document.getElementById('hotspot-bed');
    const hotspotPot = document.getElementById('hotspot-pot');
    const hotspotDoor = document.getElementById('hotspot-door');
    const hotspotPlant = document.getElementById('hotspot-plant');
    const hotspotMap = document.getElementById('hotspot-map');
    const roomSceneBg = document.getElementById('room-scene-bg');

    const roomViewport = document.getElementById('room-viewport');
    const roomScene = document.getElementById('room-scene');
    const petDialogBar = document.getElementById('pet-dialog-bar');
    const petDialogText = document.getElementById('pet-dialog-text');

    const defaultPetPosition = {
        bottom: '20%',
        left: '60%'
    };

    const roomHotspotDesignCoords = {
        bed: {
            x: 800,
            y: 200
        },
        diary: {
            x: 1574.4,
            y: 864
        },
        cabinet: {
            x: 537.6,
            y: 194.4
        }
    };

    // ã€é…ç½®ã€‘æˆ¿é—´çƒ­ç‚¹åæ ‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œå¯åœ¨æ­¤å¤„è°ƒæ•´ä½ç½®
    // ä½¿ç”¨æ§åˆ¶å°è¾“å‡ºçš„ç‚¹å‡»åæ ‡æ¥ä¿®æ­£è¿™é‡Œçš„å€¼
    const HOTSPOT_POSITIONS_PCT = {
        door: { left: 50, top: 35 },  // é—¨å£
        pot:  { left: 16, top: 62 },  // å°é”…
        map:  { left: 22, top: 23 },  // åœ°å›¾æŒ‚ç”»ï¼ˆå¢™ä¸Šç©ºç”»æ¡†ï¼‰
        // å¦‚æœæƒ³è¦†ç›– bed/diary/cabinet çš„åƒç´ åæ ‡ï¼Œä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ï¼Œä¾‹å¦‚ï¼š
        // bed: { left: 50, top: 50 },
    };

    // æˆ¿é—´å†…ç”¨äºè¡Œèµ°è·¯å¾„çš„å…³é”®è·¯è¿‡ç‚¹ä¸çƒ­ç‚¹ç»ˆç‚¹ï¼ˆä½¿ç”¨ bottom/left ç™¾åˆ†æ¯”ï¼‰
    const ROOM_WAYPOINTS = {
        // æ¡Œå­è‰åœ°ä¸­å¤®åä¸Šçš„ä½ç½®ï¼ˆæ¯”å¡ä¸˜ä»æ¡Œå­é™„è¿‘å‡ºå‘æ—¶ï¼Œå…ˆè¸©åˆ°è¿™é‡Œï¼‰
        centerFront: { bottom: '25%', left: '50%' },
        // å·¦å³ä¸¤ä¸ªè¾…åŠ©ç‚¹ï¼Œç›®å‰ä¸»è¦ç”¨äºæ€§æ ¼å·®å¼‚æ‰©å±•
        centerLeft:  { bottom: '26%', left: '40%' },
        centerRight: { bottom: '26%', left: '60%' },
        // ä»æ¡Œå­è‰åœ°èµ°å‘æˆ¿é—´ä¸­éƒ¨çš„è¾¹ç¼˜ç‚¹
        rugEdge:     { bottom: '30%', left: '50%' },
        // æ¥¼æ¢¯è„šä¸‹çš„åœ°é¢ä½ç½®ï¼ˆå»é—¨å£ä¹‹å‰ä¼šç»è¿‡è¿™é‡Œï¼‰
        stairsFoot:  { bottom: '45%', left: '60%' },
        // åºŠ/æ¡Œå­ä¸€ä¾§ï¼Œæ¯”å¡ä¸˜å‡†å¤‡èººä¸‹å‰å…ˆé è¿‘è¿™é‡Œ
        bedSide:     { bottom: '30%', left: '48%' }
    };

    // è¿™é‡Œçš„ç™¾åˆ†æ¯”åªéœ€è¦å’Œè§†è§‰å¤§è‡´å¯¹é½ï¼Œä¾¿äºåç»­å¾®è°ƒï¼›
    // è¡Œèµ°è·¯å¾„å’Œçƒ­ç‚¹æŒ‰é’®çš„æœ€ç»ˆä½ç½®éƒ½ä¼šå›´ç»•è¿™äº›ç‚¹å±•å¼€
    const ROOM_TARGET_HOTSPOTS = {
        bed:   { bottom: '32%', left: '50%' },
        // å°é”…ï¼šåº•éƒ¨å·¦ä¾§çš„å¤§é”…ä½ç½®
        pot:   { bottom: '18%', left: '14%' },
        // é—¨å£ï¼šé è¿‘ä¸Šå±‚å¹³å°å³ä¾§çš„é—¨ï¼ˆä¸çº¢æ¡†ä½ç½®å¯¹é½ä¸ºä¸»ï¼‰
        door:  { bottom: '68%', left: '78%' }
    };

    const WANDER_AREAS = {
        center:   ROOM_WAYPOINTS.centerFront,
        bed_side: { bottom: '30%', left: '48%' },
        door_side:{ bottom: '28%', left: '66%' }
    };

    function updateRoomHotspotPositions() {
        if (!roomSceneBg) return;
        const imgWidth = roomSceneBg.naturalWidth;
        const imgHeight = roomSceneBg.naturalHeight;
        const renderedWidth = roomSceneBg.clientWidth;
        const renderedHeight = roomSceneBg.clientHeight;

        if (!imgWidth || !imgHeight || !renderedWidth || !renderedHeight) return;

        const scaleX = renderedWidth / imgWidth;
        const scaleY = renderedHeight / imgHeight;

        const positionHotspot = (el, key) => {
            if (!el) return;
            
            // ä¼˜å…ˆä½¿ç”¨ç™¾åˆ†æ¯”é…ç½®
            if (HOTSPOT_POSITIONS_PCT && HOTSPOT_POSITIONS_PCT[key]) {
                const pct = HOTSPOT_POSITIONS_PCT[key];
                el.style.left = `${pct.left}%`;
                el.style.top = `${pct.top}%`;
                el.style.right = '';
                el.style.bottom = '';
                return;
            }

            const design = roomHotspotDesignCoords[key];
            if (!design) return;

            const currentX = design.x * scaleX;
            const currentY = design.y * scaleY;

            const leftPercent = (currentX / renderedWidth) * 100;
            const topPercent = (currentY / renderedHeight) * 100;

            el.style.left = `${leftPercent}%`;
            el.style.top = `${topPercent}%`;
            el.style.right = '';
            el.style.bottom = '';
        };

        positionHotspot(hotspotBed, 'bed');
        positionHotspot(hotspotDiary, 'diary');
        positionHotspot(hotspotCabinet, 'cabinet');
        positionHotspot(hotspotPot, 'pot');
        positionHotspot(hotspotDoor, 'door');
        positionHotspot(hotspotPlant, 'plant');
        positionHotspot(hotspotMap, 'map');
    }

    if (roomSceneBg) {
        if (roomSceneBg.complete) {
            updateRoomHotspotPositions();
        } else {
            roomSceneBg.addEventListener('load', updateRoomHotspotPositions);
        }
    }

    window.addEventListener('resize', updateRoomHotspotPositions);

    // ç»Ÿä¸€çš„å® ç‰©å¯¹è¯å±•ç¤ºï¼šåœ¨å® ç‰©é¡µåº•éƒ¨å¯¹è¯æ ä¸­æ˜¾ç¤ºå½“å‰æ¶ˆæ¯
    function showPetMessage(message, options = {}) {
        if (!petDialogBar || !petDialogText) return;

        petDialogText.textContent = message;

        // æ ¹æ®å½“å‰äººæ ¼é…ç½®è°ƒæ•´å¯¹è¯æ è¾¹æ¡†é¢œè‰²
        const cfg = typeof getCurrentPersonality === 'function' ? getCurrentPersonality() : null;
        if (cfg && cfg.bubbleColor) {
            petDialogBar.querySelector('div').style.borderColor = cfg.bubbleColor;
        }

        petDialogBar.classList.add('visible');

        const duration = options.duration != null ? options.duration : 3000;
        if (duration > 0) {
            window.clearTimeout(petDialogBar.__hideTimer);
            petDialogBar.__hideTimer = window.setTimeout(() => {
                petDialogBar.classList.remove('visible');
            }, duration);
        }
    }

    // æ ¹æ®å½“å‰äººæ ¼ä¸ç›®æ ‡çƒ­ç‚¹ï¼Œæ„é€ ä¸€æ¡ä»å½“å‰ä½ç½®åˆ°ç›®æ ‡çš„è¡Œèµ°è·¯å¾„
    function buildPathToHotspot(hotspotKey, personalityCfg) {
        const p = personalityCfg || (typeof getCurrentPersonality === 'function' ? getCurrentPersonality() : null) || {};
        const energy = p.energy || 'introvert';
        const target = ROOM_TARGET_HOTSPOTS[hotspotKey];
        if (!target) return [];

        const path = [];

        // === åºŠ / ä¼‘æ¯ï¼šå…ˆä»æ¡Œå­è‰åœ°è¾¹ç¼˜ç»•åˆ°åºŠä¾§ï¼Œå†èººä¸‹ ===
        if (hotspotKey === 'bed') {
            // ç¦»å¼€æ¡Œå­è‰åœ°
            path.push(ROOM_WAYPOINTS.rugEdge);
            // å¤–å‘äººæ ¼åœ¨åœ°é¢ä¸Šå¤šæ™ƒä¸€ä¸‹
            if (energy === 'extrovert') {
                path.push(ROOM_WAYPOINTS.centerFront);
            }
            // é è¿‘åºŠä¾§ï¼Œå†åˆ°æœ€ç»ˆä¼‘æ¯ç‚¹
            path.push(ROOM_WAYPOINTS.bedSide, target);
            return path;
        }

        // === é—¨å£ï¼šæ²¿åœ°æ¿ç»è¿‡æ¥¼æ¢¯è„šå†åˆ°é—¨å‰ï¼Œä¸å†â€œé£å‘ä¸Šå±‚â€ ===
        if (hotspotKey === 'door') {
            path.push(ROOM_WAYPOINTS.rugEdge);
            path.push(ROOM_WAYPOINTS.stairsFoot);
            path.push(target);
            return path;
        }

        // å°é”…ï¼šä»æ¡Œå­è‰åœ°è¾¹ç¼˜æ‹å‘å¤§é”…ä½ç½®
        if (hotspotKey === 'pot') {
            path.push(ROOM_WAYPOINTS.rugEdge, target);
            return path;
        }

        // å…¶ä»–çƒ­ç‚¹ï¼šç›´æ¥èµ°åˆ°ç›®æ ‡ç‚¹
        path.push(target);
        return path;
    }

    // ä¸ºâ€œéšä¾¿èµ°èµ°â€æ„é€ ä¸€æ¡è½»é‡è·¯å¾„ï¼ˆä¸ä¼šç¦»é»˜è®¤åŒºåŸŸå¤ªè¿œï¼‰
    function buildWanderPath(areaKey, personalityCfg) {
        const p = personalityCfg || (typeof getCurrentPersonality === 'function' ? getCurrentPersonality() : null) || {};
        const energy = p.energy || 'introvert';
        const target = WANDER_AREAS[areaKey] || ROOM_WAYPOINTS.centerFront;
        const path = [];

        if (energy === 'extrovert') {
            path.push(ROOM_WAYPOINTS.centerFront, target);
        } else {
            path.push(target);
        }

        return path;
    }

    // --- æˆ¿é—´åœºæ™¯æ‹–æ‹½ä¸ç¼©æ”¾ ---
    (function initRoomPanZoom() {
        if (!roomViewport || !roomScene) return;
        let sceneTranslateX = 0, sceneTranslateY = 0, sceneScale = 1;
        let lastPointerX = 0, lastPointerY = 0;
        let isPanning = false;
        let lastPinchDist = 0, lastPinchCenterX = 0, lastPinchCenterY = 0;
        const MIN_SCALE = 0.6, MAX_SCALE = 3;

        function applySceneTransform() {
            roomScene.style.transform = `translate(${sceneTranslateX}px, ${sceneTranslateY}px) scale(${sceneScale})`;
        }

        function isInteractiveTarget(el) {
            if (!el || !el.closest) return false;
            return el.closest('.room-hotspot');
        }

        function isOnPet(el) {
            return el && el.closest && el.closest('#pet-avatar-room');
        }

        const TAP_THRESHOLD_PX = 5;
        let pointerDownOnPet = false;
        let didPanThisGesture = false;
        let startPointerX = 0, startPointerY = 0;

        roomViewport.addEventListener('pointerdown', (e) => {
            if (e.button !== 0 && e.button !== undefined) return;
            if (isInteractiveTarget(e.target)) return;
            pointerDownOnPet = isOnPet(e.target);
            didPanThisGesture = false;
            startPointerX = e.clientX;
            startPointerY = e.clientY;
            isPanning = true;
            lastPointerX = e.clientX;
            lastPointerY = e.clientY;
            try { roomViewport.setPointerCapture(e.pointerId); } catch (_) {}
            e.preventDefault();
        });

        roomViewport.addEventListener('pointermove', (e) => {
            if (!isPanning) return;
            const dx = e.clientX - lastPointerX;
            const dy = e.clientY - lastPointerY;
            if (!didPanThisGesture && (Math.abs(e.clientX - startPointerX) > TAP_THRESHOLD_PX || Math.abs(e.clientY - startPointerY) > TAP_THRESHOLD_PX)) {
                didPanThisGesture = true;
            }
            lastPointerX = e.clientX;
            lastPointerY = e.clientY;
            sceneTranslateX += dx;
            sceneTranslateY += dy;
            applySceneTransform();
            e.preventDefault();
        });

        roomViewport.addEventListener('pointerup', (e) => {
            // å¦‚æœä¸æ˜¯æ‹–æ‹½æ“ä½œï¼Œä¸”æ²¡æœ‰ç‚¹ä¸­å® ç‰©ï¼ˆç‚¹ä¸­å® ç‰©ç”±ä¸‹æ–¹é€»è¾‘å¤„ç†ï¼‰ï¼Œåˆ™è§†ä¸ºèƒŒæ™¯ç‚¹å‡»
            if (!didPanThisGesture && !pointerDownOnPet) {
                // ç®€å•çš„è°ƒè¯•è¾…åŠ©ï¼šè¾“å‡ºç‚¹å‡»ä½ç½®çš„ç™¾åˆ†æ¯”åæ ‡
                if (roomSceneBg) {
                    const rect = roomSceneBg.getBoundingClientRect();
                    // ä¿®æ­£ï¼šç¡®ä¿åŸºäºå›¾ç‰‡å®é™…æ¸²æŸ“åŒºåŸŸè®¡ç®—
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // ä»…å½“ç‚¹å‡»åœ¨å›¾ç‰‡èŒƒå›´å†…æ—¶è¾“å‡º
                    if (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height) {
                        const leftP = (x / rect.width) * 100;
                        const topP = (y / rect.height) * 100;
                        console.log(`%c[åæ ‡æ‹¾å–] Left: ${leftP.toFixed(2)}%, Top: ${topP.toFixed(2)}%`, 'color: #ff00ff; font-weight: bold; background: #f0f0f0; padding: 2px 4px; border-radius: 4px;');
                        console.log('è¯·å°†ä¸Šè¿°åæ ‡å¡«å…¥ä»£ç ä¸­çš„ HOTSPOT_POSITIONS_PCT é…ç½®ä¸­å¯¹åº”çš„ item');
                    }
                }
            }

            if (pointerDownOnPet && !didPanThisGesture && typeof window.__triggerPetTapInteraction === 'function') {
                ignoreNextPetClick = true;
                window.__triggerPetTapInteraction();
            }
            isPanning = false;
        });
        roomViewport.addEventListener('pointercancel', () => { isPanning = false; });
        roomViewport.addEventListener('pointerleave', () => { isPanning = false; });

        roomViewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.08 : 0.08;
            const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, sceneScale + delta));
            if (newScale === sceneScale) return;
            sceneScale = newScale;
            applySceneTransform();
        }, { passive: false });

        roomViewport.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                lastPinchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                lastPinchCenterX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                lastPinchCenterY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            }
        }, { passive: true });

        roomViewport.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                e.preventDefault();
                const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                const scaleFactor = dist / lastPinchDist;
                const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, sceneScale * scaleFactor));
                sceneScale = newScale;
                sceneTranslateX += centerX - lastPinchCenterX;
                sceneTranslateY += centerY - lastPinchCenterY;
                lastPinchDist = dist;
                lastPinchCenterX = centerX;
                lastPinchCenterY = centerY;
                applySceneTransform();
            }
        }, { passive: false });

        applySceneTransform();
    })();

    // --- æ¯”å¡ä¸˜å® ç‰©ç”Ÿå‘½çŠ¶æ€æœº ---
    const PET_STATES = {
        IDLE_WAIT: 'idle_wait',        // å…¥åœº / è¢«å«é†’åçš„çŸ­æš‚ç­‰å¾…
        IDLE_BREATH: 'idle_breath',    // æ­£å¸¸å‘¼å¸å‘å‘†
        IDLE_OBSERVE: 'idle_observe',  // å¥½å¥‡è§‚å¯Ÿ
        INTERACT: 'interact',          // ä¸ç”¨æˆ·äº’åŠ¨
        REST: 'rest'                   // ä¼‘æ¯/ç¡è§‰
    };

    const petLife = {
        current: PET_STATES.IDLE_WAIT,
        previous: PET_STATES.IDLE_BREATH,
        transientTimer: null,
        inactivityTimer: null
    };

    // æ¯”å¡ä¸˜åœ¨æˆ¿é—´å†…â€œèµ°è·¯â€çš„çŠ¶æ€
    const petWalk = {
        isWalking: false,
        stepTimer: null
    };

    function updatePetStatus(text) {
        if (!petStatusBar) return;
        petStatusBar.textContent = text;
    }

    function clearPetTimers() {
        if (petLife.transientTimer) {
            clearTimeout(petLife.transientTimer);
            petLife.transientTimer = null;
        }
        if (petLife.inactivityTimer) {
            clearTimeout(petLife.inactivityTimer);
            petLife.inactivityTimer = null;
        }
        // æ¸…ç†è¡Œèµ°ç›¸å…³çš„è®¡æ—¶å™¨ï¼Œé¿å…è·¨çŠ¶æ€æ®‹ç•™è¿åŠ¨
        if (typeof stopPetWalk === 'function') {
            stopPetWalk();
        }
    }

    // --- åŸºäºäººæ ¼çš„ç®€å•è¡Œä¸ºå†³ç­– ---
    const HOTSPOT_BEHAVIOR_PRESETS = {
        bed: {
            position: { bottom: '32%', left: '50%' },
            context: 'åœ¨è½¯è½¯çš„åºŠä¸Šä¼¸äº†ä¸ªå¤§å¤§çš„æ‡’è…°',
            stayMs: 2600,
            animationState: 'rest',
            resultingState: PET_STATES.REST
        },
        pot: {
            position: { bottom: '26%', left: '30%' },
            context: 'è·‘åˆ°é”…è¾¹å·å·é—»äº†ä¸€å¤§å£é¦™å‘³',
            stayMs: 2600,
            animationState: 'eat',
            resultingState: PET_STATES.INTERACT
        },
        door: {
            position: { bottom: '30%', left: '70%' },
            context: 'è·‘åˆ°é—¨å£ï¼Œå‡†å¤‡å’Œé™ªæˆ‘æ—…è¡Œçš„äººä¸€èµ·å‡ºé—¨æ¢ç´¢',
            stayMs: 800,
            animationState: 'door',
            resultingState: PET_STATES.INTERACT
        }
    };

    function decidePersonalityBehavior(trigger) {
        const p = getCurrentPersonality && getCurrentPersonality();
        if (!p) return null;
        const energy = p.energy;   // extrovert / introvert
        const emotion = p.emotion; // emotional / rational

        // 15 ç§’æ— æ“ä½œï¼Œä»å‘¼å¸çŠ¶æ€å‡ºå‘
        if (trigger === 'inactivity_from_idle_breath') {
            if (energy === 'extrovert' && emotion === 'emotional') {
                // å°ç«è‹—ï¼šæ›´çˆ±å¾€é—¨å£å‡‘
                return { type: 'moveToHotspot', hotspot: 'door' };
            }
            if (energy === 'extrovert' && emotion === 'rational') {
                // å°ç¯æ³¡ï¼šæ›´å¤šä¼šå»â€œç ”ç©¶â€é”…é‡Œçš„ä¸œè¥¿
                return { type: 'moveToHotspot', hotspot: 'pot' };
            }
            if (energy === 'introvert' && emotion === 'emotional') {
                // å°äº‘æœµï¼šå–œæ¬¢å›åˆ°åºŠä¸Šçªç€
                return { type: 'moveToHotspot', hotspot: 'bed', resultingState: PET_STATES.REST };
            }
            if (energy === 'introvert' && emotion === 'rational') {
                // å°çŸ³å¤´ï¼šç›´æ¥è¿›å…¥ä¼‘æ¯
                return { type: 'rest' };
            }
        }

        // ä»â€œè§‚å¯Ÿå¯¹æ–¹â€çŠ¶æ€å‘å‘†å¤ªä¹…æ—¶ï¼Œæ›´åå‘è½»åº¦é—²é€›æˆ–ç›´æ¥ä¼‘æ¯
        if (trigger === 'inactivity_from_idle_observe') {
            if (energy === 'extrovert' && emotion === 'emotional') {
                return {
                    type: 'wander',
                    area: 'door_side',
                    context: 'å¿ä¸ä½åœ¨é—¨å£é™„è¿‘æ¥å›æ™ƒæ‚ ï¼ŒæœŸå¾…ä¸‹ä¸€æ¬¡å‡ºå‘'
                };
            }
            if (energy === 'extrovert' && emotion === 'rational') {
                return {
                    type: 'wander',
                    area: 'center',
                    context: 'åœ¨æˆ¿é—´ä¸­å¤®æ…¢æ…¢è¸±æ­¥ï¼Œå›é¡¾åˆšæ‰çš„æ—…è¡Œè·¯çº¿'
                };
            }
            if (energy === 'introvert' && emotion === 'emotional') {
                return {
                    type: 'wander',
                    area: 'bed_side',
                    context: 'æ‚„æ‚„æŒªåˆ°åºŠè¾¹ï¼Œåœ¨æŸ”è½¯çš„è§’è½é‡Œå°èŒƒå›´åœ°èµ°æ¥èµ°å»'
                };
            }
            if (energy === 'introvert' && emotion === 'rational') {
                return {
                    type: 'rest',
                    context: 'å†³å®šå…ˆç¼©æˆä¸€å›¢å®‰é™ä¼‘æ¯ä¸€ä¸‹'
                };
            }
        }

        // å®Œæˆä¸€æ¬¡æ—…è¡Œæ‰“å¡å
        if (trigger === 'after_travel') {
            if (energy === 'extrovert' && emotion === 'emotional') {
                return { type: 'moveToHotspot', hotspot: 'door' };
            }
            if (energy === 'extrovert' && emotion === 'rational') {
                // æš‚æ—¶ç”¨â€œé”…â€ä»£è¡¨å¯¹é“å…·/ç¯å¢ƒç»†èŠ‚çš„å¥½å¥‡
                return { type: 'moveToHotspot', hotspot: 'pot' };
            }
            if (energy === 'introvert' && emotion === 'emotional') {
                return { type: 'moveToHotspot', hotspot: 'bed', resultingState: PET_STATES.REST };
            }
            if (energy === 'introvert' && emotion === 'rational') {
                return { type: 'stay_observe' };
            }
        }

        // è¿›å…¥å® ç‰©æˆ¿æ—¶çš„è½»å¾®å·®å¼‚ï¼šå¤–å‘çš„æ›´ä¸»åŠ¨è§‚å¯Ÿä½ 
        if (trigger === 'enter_room') {
            if (energy === 'extrovert') {
                return { type: 'stay_observe' };
            }
        }

        return null;
    }

    function applyBehaviorDecision(decision) {
        if (!decision) return;

        if (decision.type === 'moveToHotspot') {
            const preset = HOTSPOT_BEHAVIOR_PRESETS[decision.hotspot] || null;
            const personalityCfg = typeof getCurrentPersonality === 'function' ? getCurrentPersonality() : null;
            const pathPoints = buildPathToHotspot(decision.hotspot, personalityCfg);

            const position = decision.position || (preset && preset.position);
            const stayMs = decision.stayMs !== undefined
                ? decision.stayMs
                : (preset ? preset.stayMs : 2600);
            const animationState = decision.animationState || (preset && preset.animationState) || 'interact';
            const resultingState = decision.resultingState || (preset && preset.resultingState) || PET_STATES.INTERACT;
            const context = decision.context || (preset && preset.context) || null;

            if (pathPoints && pathPoints.length) {
                walkPetAlongPath(pathPoints, {
                    contextOverride: context,
                    stayMs,
                    animationState,
                    resetToDefault: true,
                    onArrive: () => setPetState(resultingState, { skipInactivityReset: false })
                });
            } else if (position) {
                movePetToSpot(position, context, stayMs, animationState);
                setPetState(resultingState);
            } else {
                if (context) {
                    triggerAIPetAction(context);
                } else {
                    triggerAIPetAction();
                }
                setPetState(resultingState);
            }
            return;
        }

        if (decision.type === 'rest') {
            triggerAIPetAction(decision.context || 'å†³å®šå…ˆå°ç¡ä¸€ä¼šå„¿ï¼Œæ¢å¤ä½“åŠ›');
            setPetState(PET_STATES.REST);
            return;
        }

        if (decision.type === 'stay_observe') {
            if (decision.context) {
                triggerAIPetAction(decision.context);
            } else {
                triggerAIPetAction();
            }
            setPetState(PET_STATES.IDLE_OBSERVE);
            return;
        }

        if (decision.type === 'wander') {
            const personalityCfg = typeof getCurrentPersonality === 'function' ? getCurrentPersonality() : null;
            const pathPoints = buildWanderPath(decision.area || 'center', personalityCfg);
            const context = decision.context || null;

            if (pathPoints && pathPoints.length) {
                walkPetAlongPath(pathPoints, {
                    contextOverride: context,
                    stayMs: 0,
                    animationState: 'idle_breath',
                    resetToDefault: false,
                    onArrive: () => setPetState(PET_STATES.IDLE_BREATH, { skipInactivityReset: false })
                });
            } else if (context) {
                triggerAIPetAction(context);
                setPetState(PET_STATES.IDLE_BREATH);
            }
            return;
        }
    }

    function schedulePetTransition(targetState, delayMs) {
        if (!delayMs || !targetState) return;
        if (petLife.transientTimer) {
            clearTimeout(petLife.transientTimer);
        }
        petLife.transientTimer = setTimeout(() => {
            setPetState(targetState, { skipInactivityReset: true });
        }, delayMs);
    }

    function scheduleInactivityFlow() {
        // 15 ç§’æ— äº¤äº’åï¼Œæ ¹æ®å½“å‰äººæ ¼åšä¸€æ¬¡ç®€å•å†³ç­–ï¼›æ— é…ç½®æ—¶é€€å›æ—§é€»è¾‘
        if (petLife.inactivityTimer) {
            clearTimeout(petLife.inactivityTimer);
        }
        petLife.inactivityTimer = setTimeout(() => {
            // è¡Œèµ°è¿‡ç¨‹ä¸­ä¸è§¦å‘é¢å¤–çš„æ€§æ ¼å†³ç­–ï¼Œé¿å…â€œèµ°ä¸€åŠç¡ç€/è½¬åœºâ€
            if (petWalk && petWalk.isWalking) return;

            if (petLife.current === PET_STATES.REST) return;

            if (petLife.current === PET_STATES.IDLE_BREATH || petLife.current === PET_STATES.IDLE_OBSERVE) {
                const triggerKey = petLife.current === PET_STATES.IDLE_BREATH
                    ? 'inactivity_from_idle_breath'
                    : 'inactivity_from_idle_observe';
                const decision = decidePersonalityBehavior(triggerKey);
                if (decision) {
                    applyBehaviorDecision(decision);
                    return;
                }
            }

            // å…œåº•ï¼šä¿æŒä¹‹å‰çš„å›ºå®šè¡Œä¸ºé“¾è·¯
            if (petLife.current === PET_STATES.IDLE_BREATH) {
                setPetState(PET_STATES.IDLE_OBSERVE, { skipInactivityReset: true });
                petLife.inactivityTimer = setTimeout(() => {
                    if (petLife.current !== PET_STATES.REST) {
                        setPetState(PET_STATES.REST, { skipInactivityReset: true });
                    }
                }, 15000);
            } else if (petLife.current === PET_STATES.IDLE_OBSERVE) {
                setPetState(PET_STATES.REST, { skipInactivityReset: true });
            }
        }, 15000);
    }

    function setPetState(nextState, options = {}) {
        if (!nextState) return;
        const prev = petLife.current;
        petLife.previous = prev;
        petLife.current = nextState;

        if (!options.keepOtherTimers) {
            clearPetTimers();
        }

        switch (nextState) {
            case PET_STATES.IDLE_WAIT:
                updatePetStatus('ä¼¸æ‡’è…°å‡†å¤‡å‡ºå‘ï½');
                playPetAnimation('idle_wait', { loop: false, frameInterval: 120, cycles: 2 });
                schedulePetTransition(PET_STATES.IDLE_BREATH, 2800);
                break;
            case PET_STATES.IDLE_BREATH:
                updatePetStatus('æ¯”å¡ä¸˜åœ¨å‘å‘†æ”¾ç©ºä¸­â€¦');
                playPetAnimation('idle_breath', { loop: true, frameInterval: 130 });
                break;
            case PET_STATES.IDLE_OBSERVE:
                updatePetStatus('æ¯”å¡ä¸˜åœ¨çœ‹ç€ä½ å“¦ï½');
                playPetAnimation('idle_observe', { loop: false, frameInterval: 120, cycles: 2 });
                schedulePetTransition(PET_STATES.IDLE_BREATH, 4000);
                break;
            case PET_STATES.INTERACT:
                updatePetStatus('æ¯”å¡ä¸˜è¶…å¼€å¿ƒï¼');
                playPetAnimation('interact', { loop: false, frameInterval: 90, cycles: 2 });
                schedulePetTransition(PET_STATES.IDLE_BREATH, 3200);
                break;
            case PET_STATES.REST:
                updatePetStatus('æ¯”å¡ä¸˜ç¡ç€å•¦â€¦');
                playPetAnimation('rest', { loop: true, frameInterval: 150 });
                break;
            default:
                playPetAnimation('idle_breath', { loop: true, frameInterval: 130 });
        }

        if (!options.skipInactivityReset && nextState !== PET_STATES.REST) {
            scheduleInactivityFlow();
        }

        if (btnPetRestToggle) {
            if (petLife.current === PET_STATES.REST) {
                btnPetRestToggle.textContent = 'å«é†’å®ƒ';
            } else {
                btnPetRestToggle.textContent = 'å»ä¼‘æ¯';
            }
        }
        if (actionRest) {
            if (petLife.current === PET_STATES.REST) {
                actionRest.querySelector('span:last-child').textContent = 'å«é†’å®ƒ';
            } else {
                actionRest.querySelector('span:last-child').textContent = 'ä¼‘æ¯';
            }
        }
    }

    function markPetInteraction() {
        // ç”¨æˆ·ä¸»åŠ¨äº¤äº’ä¼šé‡ç½®æ— æ“ä½œè®¡æ—¶
        if (petLife.current === PET_STATES.REST) {
            setPetState(PET_STATES.IDLE_WAIT);
        } else {
            scheduleInactivityFlow();
        }
    }

    // --- åœºæ™¯ç´ æï¼šä¸­å›½åœ°ç‚¹å›ºå®šæ˜ å°„ + éä¸­å›½åœ°ç‚¹éšè—æ¬¾éšæœº ---
    // ä¸­å›½åœ°ç‚¹ï¼ˆkey æŒ‰å…·ä½“ä¼˜å…ˆï¼Œå…ˆåŒ¹é…å¹¿å·å†åŒ¹é…å¹¿ä¸œï¼‰
    const sceneAssets = {
        'åŒ—äº¬':   { image: 'åœºæ™¯/åŒ—äº¬-ç³–è‘«èŠ¦.png',   label: 'åŒ—äº¬Â·ç³–è‘«èŠ¦' },
        'å¹¿å·':   { image: 'åœºæ™¯/å¹¿å·-æ—©èŒ¶.png',    label: 'å¹¿å·Â·æ—©èŒ¶' },
        'å¹¿ä¸œ':   { image: 'åœºæ™¯/å¹¿å·-æ—©èŒ¶.png',    label: 'å¹¿å·Â·æ—©èŒ¶' },
        'ä¸Šæµ·':   { image: 'åœºæ™¯/ä¸Šæµ·â€”å¤§ç™½å…”.png', label: 'ä¸Šæµ·Â·å¤§ç™½å…”' },
        'æ·±åœ³':   { image: 'åœºæ™¯/æ·±åœ³â€”ç°•æœé¹ƒ.png',  label: 'æ·±åœ³Â·ç°•æœé¹ƒ' },
        'æˆéƒ½':   { image: 'åœºæ™¯/å››å·â€”ç†ŠçŒ«.png',  label: 'å››å·Â·ç†ŠçŒ«' },
        'å››å·':   { image: 'åœºæ™¯/å››å·â€”ç†ŠçŒ«.png',  label: 'å››å·Â·ç†ŠçŒ«' },
        'æ­å·':   { image: 'åœºæ™¯/æµ™æ±Ÿâ€”é›„é»„é…’.png', label: 'æµ™æ±ŸÂ·é›„é»„é…’' },
        'æµ™æ±Ÿ':   { image: 'åœºæ™¯/æµ™æ±Ÿâ€”é›„é»„é…’.png', label: 'æµ™æ±ŸÂ·é›„é»„é…’' }
    };
    const sceneAssetsKeyOrder = ['åŒ—äº¬', 'å¹¿å·', 'å¹¿ä¸œ', 'ä¸Šæµ·', 'æ·±åœ³', 'æˆéƒ½', 'å››å·', 'æ­å·', 'æµ™æ±Ÿ'];

    const hiddenSceneAssets = [
        { image: 'åœºæ™¯/åŸƒåŠé‡‘å­—å¡”.png',   label: 'éšè—æ¬¾ Â· åŸƒåŠé‡‘å­—å¡”' },
        { image: 'åœºæ™¯/åŸƒè²å°”é“å¡”.png',   label: 'éšè—æ¬¾ Â· åŸƒè²å°”é“å¡”' },
        { image: 'åœºæ™¯/è‡ªç”±å¥³ç¥åƒ.png',   label: 'éšè—æ¬¾ Â· è‡ªç”±å¥³ç¥åƒ' }
    ];

    // å›½å†…åœºæ™¯æ± ï¼ˆå»é‡ï¼‰ï¼šç”¨äºæ™®é€šéšæœºæ‰è½ï¼Œæ‰“å¡åœ°ç‚¹ä¸æ‰è½ç‰©è§£è€¦
    const domesticScenePool = (() => {
        const seen = new Set();
        return Object.values(sceneAssets).filter(s => {
            if (seen.has(s.image)) return false;
            seen.add(s.image);
            return true;
        });
    })();

    /** æ ¹æ®å½“å‰æ‰“å¡æ¬¡æ•°è®¡ç®—æœ¬æ¬¡æ‰è½çš„ sceneï¼šæ¯ 3 æ¬¡ä¸ºå›½å¤–éšè—æ¬¾ï¼Œå¦åˆ™ä»å›½å†…æ± éšæœº */
    function getDroppedScene(checkInCount) {
        if (checkInCount % 3 === 0 && hiddenSceneAssets.length > 0) {
            return hiddenSceneAssets[Math.floor(Math.random() * hiddenSceneAssets.length)];
        }
        if (domesticScenePool.length > 0) {
            return domesticScenePool[Math.floor(Math.random() * domesticScenePool.length)];
        }
        return null;
    }

    function getSceneAsset(location) {
        const normalized = typeof normalizeLocationName === 'function' ? normalizeLocationName(location) : String(location || '').trim();
        for (let i = 0; i < sceneAssetsKeyOrder.length; i++) {
            const key = sceneAssetsKeyOrder[i];
            if (normalized.includes(key) || (location && String(location).includes(key))) {
                return sceneAssets[key];
            }
        }
        if (typeof isChinaLocation === 'function' && !isChinaLocation(location)) {
            if (hiddenSceneAssets.length > 0) {
                return hiddenSceneAssets[Math.floor(Math.random() * hiddenSceneAssets.length)];
            }
        }
        return null;
    }

    // --- äººæ ¼ç›²ç›’ä¸çŠ¶æ€å±•ç¤ºé€»è¾‘ ---
    function updatePersonalityDisplay() {
        const p = getCurrentPersonality();
        if (!p) return;
        
        // æ›´æ–° UI æ–‡æœ¬
        if (pName) pName.textContent = p.name;
        if (pIcon) pIcon.textContent = p.icon;
        
        // æ›´æ–°æ ‡ç­¾
        if (pTag1) {
            pTag1.textContent = p.energy === 'extrovert' ? 'å¤–å‘' : 'å†…å‘';
            pTag1.className = `personality-tag ${p.energy === 'extrovert' ? 'text-red-500 bg-red-50' : 'text-blue-500 bg-blue-50'}`;
        }
        if (pTag2) {
            pTag2.textContent = p.emotion === 'emotional' ? 'æ„Ÿæ€§' : 'ç†æ€§';
            pTag2.className = `personality-tag ${p.emotion === 'emotional' ? 'text-pink-500 bg-pink-50' : 'text-purple-500 bg-purple-50'}`;
        }
        
        // åº”ç”¨è§†è§‰æ»¤é•œï¼ˆæ¨¡æ‹Ÿçš®è‚¤/è‰²è°ƒï¼‰
        if (petAvatarSprite) {
            petAvatarSprite.style.filter = p.colorFilter || 'none';
            petAvatarSprite.style.transition = 'filter 0.5s ease';
        }

        // æ˜¾ç¤ºçŠ¶æ€æ 
        if (personalityDisplay) personalityDisplay.classList.remove('hidden');
    }

    // åˆå§‹åŒ–é»˜è®¤äººæ ¼
    updatePersonalityDisplay();

    // é¡¶éƒ¨ä¿¡æ¯åŒºï¼šç§°å‘¼è®¾ç½®å¯æ”¶èµ· / å±•å¼€
    let isOwnerTitleCollapsed = true;

    function applyOwnerTitleCollapsed(collapsed) {
        if (!ownerTitleConfig) return;
        isOwnerTitleCollapsed = collapsed;
        ownerTitleConfig.style.display = collapsed ? 'none' : 'flex';
        if (petInfoToggleText) {
            petInfoToggleText.textContent = collapsed ? 'å±•å¼€ç§°å‘¼è®¾ç½®' : 'æ”¶èµ·ç§°å‘¼è®¾ç½®';
        }
    }

    if (petInfoPanelToggle) {
        petInfoPanelToggle.addEventListener('click', () => {
            applyOwnerTitleCollapsed(!isOwnerTitleCollapsed);
        });
    }

    // é¡¶éƒ¨ä¿¡æ¯åŒºä¸Šæ‹‰æ“ä½œåŒºï¼šä»…æ§åˆ¶ç§°å‘¼åŒºå±•å¼€ / æ”¶èµ·
    if (petInfoDragArea) {
        let dragStartY = null;
        petInfoDragArea.addEventListener('click', () => {
            applyOwnerTitleCollapsed(!isOwnerTitleCollapsed);
        });
        petInfoDragArea.addEventListener('touchstart', (event) => {
            const t = event.touches ? event.touches[0] : event;
            dragStartY = t.clientY;
        });
        petInfoDragArea.addEventListener('touchend', (event) => {
            if (dragStartY === null) return;
            const t = event.changedTouches ? event.changedTouches[0] : event;
            const deltaY = t.clientY - dragStartY;
            dragStartY = null;
            const threshold = 20;
            if (Math.abs(deltaY) < threshold) return;
            if (deltaY < 0) {
                // ä¸Šæ‹‰ï¼šç¼©å°åˆ°æœ€å°ï¼Œåªä¿ç•™â€œå±•å¼€ç§°å‘¼è®¾ç½®â€
                applyOwnerTitleCollapsed(true);
            } else {
                // ä¸‹æ‹‰ï¼šå±•å¼€ç§°å‘¼è®¾ç½®
                applyOwnerTitleCollapsed(false);
            }
        });
    }

    // é»˜è®¤æ”¶èµ·ç§°å‘¼è®¾ç½®ï¼Œæ›´å¤šç©ºé—´ç•™ç»™åœºæ™¯
    applyOwnerTitleCollapsed(true);

    // ç›²ç›’ç”Ÿæˆå™¨ç‚¹å‡»äº‹ä»¶
    if (btnBlindBox) {
        btnBlindBox.addEventListener('click', () => {
            // æ’­æ”¾æ‘‡æ™ƒåŠ¨ç”»
            btnBlindBox.classList.add('blind-box-shake');
            setTimeout(() => btnBlindBox.classList.remove('blind-box-shake'), 500);
            
            // éšæœºæŠ½å–
            const keys = Object.keys(PERSONALITY_TYPES);
            const randomKey = keys[Math.floor(Math.random() * keys.length)];
            
            appState.petPersonality = randomKey;
            
            // åŒæ­¥ selectï¼ˆå¦‚æœè¿˜åœ¨ç”¨çš„è¯ï¼‰
            if (petPersonalitySelect) {
                petPersonalitySelect.value = randomKey;
            }
            
            // æ›´æ–° UI å’Œè§†è§‰
            updatePersonalityDisplay();
            
            // è§¦å‘åé¦ˆäº¤äº’
            markPetInteraction();
            triggerAIPetAction('æ„Ÿè§‰åƒæ˜¯æ¢äº†ä¸ªæ–°çµé­‚ï¼âœ¨');
            setPetState(PET_STATES.INTERACT);
            
            // æ’­æ”¾ç‰¹æ•ˆåŠ¨ç”»
            if (petAvatarRoom) {
                petAvatarRoom.style.transform = 'translate(-50%, 0) scale(1.2) rotate(360deg)';
                setTimeout(() => { petAvatarRoom.style.transform = 'translateX(-50%)'; }, 600);
            }
        });
    }

    // å…¼å®¹æ—§çš„ Select change äº‹ä»¶ï¼ˆå¦‚æœè¿˜éœ€è¦ï¼‰
    if (petPersonalitySelect) {
        petPersonalitySelect.addEventListener('change', (e) => {
            appState.petPersonality = e.target.value;
            updatePersonalityDisplay();
            markPetInteraction();
            triggerAIPetAction();
            setPetState(PET_STATES.INTERACT);
        });
    }

    // --- æˆ¿é—´å†…å® ç‰©ç§»åŠ¨ä¸çƒ­ç‚¹åŠ¨æ•ˆ ---
    function stopPetWalk() {
        if (petWalk.stepTimer) {
            clearTimeout(petWalk.stepTimer);
            petWalk.stepTimer = null;
        }
        petWalk.isWalking = false;
        if (petAvatarRoom) {
            petAvatarRoom.classList.remove('pet-anim-walk');
        }
    }

    function getCurrentPetPosition() {
        if (!petAvatarRoom) {
            return { ...defaultPetPosition };
        }
        const bottom = petAvatarRoom.style.bottom || defaultPetPosition.bottom;
        const left = petAvatarRoom.style.left || defaultPetPosition.left;
        return { bottom, left };
    }

    // é€šç”¨ï¼šè®©æ¯”å¡ä¸˜æŒ‰è·¯å¾„ä¾æ¬¡ç§»åŠ¨åˆ°å¤šä¸ªç‚¹
    function walkPetAlongPath(pathPoints, options = {}) {
        if (!petAvatarRoom || !Array.isArray(pathPoints) || pathPoints.length === 0) return;

        stopPetWalk();
        petWalk.isWalking = true;

        const personalityCfg = typeof getCurrentPersonality === 'function' ? getCurrentPersonality() : null;
        const speedMultiplier = (personalityCfg && personalityCfg.animSpeed) || 1;
        const baseStepDuration = options.baseStepDurationMs || 700;
        const stepDuration = Math.max(200, Math.floor(baseStepDuration * speedMultiplier));

        const contextOverride = options.contextOverride || null;
        const onArrive = typeof options.onArrive === 'function' ? options.onArrive : null;
        const stayMs = typeof options.stayMs === 'number' ? options.stayMs : 0;
        const resetToDefault = !!options.resetToDefault;
        const animationState = options.animationState || null;

        if (animationState) {
            playPetAnimation(animationState, { loop: false, frameInterval: 220 });
        }

        petAvatarRoom.classList.add('pet-anim-walk');

        let index = 0;
        const step = () => {
            if (!petAvatarRoom) {
                stopPetWalk();
                return;
            }
            if (index >= pathPoints.length) {
                petWalk.isWalking = false;
                petWalk.stepTimer = null;
                petAvatarRoom.classList.remove('pet-anim-walk');

                if (contextOverride !== null) {
                    triggerAIPetAction(contextOverride);
                } else {
                    triggerAIPetAction();
                }

                if (onArrive) {
                    onArrive();
                }

                if (resetToDefault && stayMs > 0) {
                    setTimeout(() => {
                        if (!petAvatarRoom) return;
                        petAvatarRoom.style.bottom = defaultPetPosition.bottom;
                        petAvatarRoom.style.left = defaultPetPosition.left;
                    }, stayMs);
                }
                return;
            }

            const point = pathPoints[index];
            if (point && typeof point.bottom === 'string' && typeof point.left === 'string') {
                petAvatarRoom.style.bottom = point.bottom;
                petAvatarRoom.style.left = point.left;
            }

            index += 1;
            petWalk.stepTimer = setTimeout(step, stepDuration);
        };

        step();
    }

    // ä¿æŒå‘åå…¼å®¹çš„å°è£…ï¼šè®©æ¯”å¡ä¸˜èµ°åˆ°ä¸€ä¸ªç‚¹ï¼Œå†æ ¹æ® stayMs å›åˆ°é»˜è®¤ä½ç½®
    function movePetToSpot(position, contextOverride, stayMs = 2600, animationState = null) {
        if (!petAvatarRoom) return;

        const targetPosition = position && typeof position.bottom === 'string' && typeof position.left === 'string'
            ? position
            : { ...defaultPetPosition };

        const pathPoints = [targetPosition];

        walkPetAlongPath(pathPoints, {
            contextOverride,
            stayMs,
            animationState,
            resetToDefault: true,
            onArrive: () => {
                // åˆ°è¾¾ç›®æ ‡æ—¶æ’­æ”¾è·³è·ƒè½åœ°åŠ¨æ•ˆ
                petAvatarRoom.classList.remove('pet-anim-jump');
                void petAvatarRoom.offsetWidth;
                petAvatarRoom.classList.add('pet-anim-jump');
                setTimeout(() => petAvatarRoom.classList.remove('pet-anim-jump'), 450);
            }
        });
    }

    function wiggleHotspot(buttonEl) {
        if (!buttonEl) return;
        const visual = buttonEl.querySelector('.room-hotspot-button') || buttonEl;
        visual.classList.remove('room-hotspot-wiggle');
        // è¯» offsetWidth ä»¥é‡æ–°è§¦å‘ CSS åŠ¨ç”»
        void visual.offsetWidth;
        visual.classList.add('room-hotspot-wiggle');
    }

    // --- å¼¹å±‚ï¼šé€šç”¨æ”¾å¤§æŸ¥çœ‹ ---
    let lastCabinetBodyHTML = '';
    function openModal(title, contentHTML, variant = 'default') {
        if (!modalOverlay || !modalTitle || !modalBody || !modalPanel) return;
        modalTitle.textContent = title;
        modalBody.innerHTML = contentHTML;

        if (variant === 'diary') {
            modalPanel.className = 'bg-[#fffaf0] rounded-3xl w-[94%] h-[82%] p-4 flex flex-col shadow-2xl';
        } else if (variant === 'cabinet') {
            modalPanel.className = 'cabinet-modal rounded-3xl w-[90%] max-h-[75%] p-4 flex flex-col shadow-2xl';
        } else {
            modalPanel.className = 'bg-[#fffaf0] rounded-3xl w-[90%] max-h-[75%] p-4 flex flex-col shadow-2xl';
        }

        modalOverlay.classList.remove('hidden');
    }

    function closeModal() {
        if (!modalOverlay) return;
        modalOverlay.classList.add('hidden');
        if (modalBody) modalBody.innerHTML = '';
    }

    function openCabinetModal() {
        // ç›´æ¥æ ¹æ® appState.cabinetItems ç”Ÿæˆå†…å®¹ï¼Œä¸å†ä¾èµ– hidden DOM
        const totalSlots = 12; // 3 rows * 4 cols
        const items = appState.cabinetItems || [];
        const count = items.length;
        
        let gridHTML = '';
        for (let i = 0; i < totalSlots; i++) {
            const item = items[i];
            if (item) {
                // å·²è§£é”
                const { short: shortLabel, full: fullLabel } = getShortLabel(item);
                // ä¼˜å…ˆä½¿ç”¨åœºæ™¯å›¾ï¼Œæ²¡æœ‰åˆ™ç”¨é»˜è®¤å›¾
                const imgSrc = item.scene ? item.scene.image : 'assets/cabinet-empty.svg'; 
                
                gridHTML += `
                    <div class="cabinet-slot bg-white/50 backdrop-blur-sm cursor-pointer" data-item-index="${i}">
                        <div class="cabinet-slot__media"><img src="${imgSrc}" alt="${escapeHtml(fullLabel)}" class="drop-shadow-sm"></div>
                        <span class="w-full min-w-0 line-clamp-3 text-center" title="${escapeHtml(fullLabel)}">${escapeHtml(shortLabel)}</span>
                    </div>
                `;
            } else {
                // æœªè§£é”
                gridHTML += `
                    <div class="cabinet-slot cabinet-slot--empty">
                        <div class="cabinet-slot__media"><i class="ph-bold ph-server text-3xl cabinet-empty-icon opacity-40"></i></div>
                        <span class="scale-90">å»æ—…è¡Œè§£é”</span>
                    </div>
                `;
            }
        }

        const emptyHint = count === 0 ? 
            '<div class="text-center text-xs text-[#8d7f73] font-bold mt-4 mb-2">å¸¦æˆ‘å»æ‰“å¡ï¼Œè§£é”ç¬¬ä¸€ä»¶çºªå¿µå“å§~</div>' : 
            '';

        const bodyHTML = `
            <div class="flex flex-col h-full px-2">
                <!-- å¤´éƒ¨ç»Ÿè®¡ -->
                <div class="flex items-center justify-between mb-4 mt-1">
                    <span class="text-base font-bold text-[#5c4a3a]">æˆ‘çš„æ—…è¡Œæ©±æŸœ</span>
                    <span class="text-xs text-[#8d7f73] font-bold">å·²æ”¶é›† <span class="text-[#b85c6f] text-sm">${count}</span> ä»¶å°ç‰©ä»¶</span>
                </div>
                
                ${emptyHint}
                
                <!-- ç‰©å“ç½‘æ ¼ï¼šå›ºå®š 3 è¡Œç­‰é«˜ -->
                <div class="grid grid-cols-3 cabinet-modal-grid-equal-rows gap-3 overflow-y-auto no-scrollbar pb-4 flex-1 min-h-0">
                    ${gridHTML}
                </div>
                
                <!-- åº•éƒ¨æç¤º -->
                <div class="mt-auto pt-3 text-right">
                    <p class="text-[10px] text-[#8d7f73] opacity-80">æ‰“å¡è¶Šå¤šï¼Œæ©±æŸœè¶Šæ»¡å“¦~</p>
                </div>
            </div>
        `;
        
        lastCabinetBodyHTML = bodyHTML;
        openModal('æ—…è¡Œæ©±æŸœ', bodyHTML, 'cabinet');
        
        // ç‚¹å‡»å·²æ”¶é›†æ ¼å­ â†’ è¯¦æƒ…å±‚ï¼ˆå¤§å›¾ + å®Œæ•´åç§°ï¼‰
        modalBody.addEventListener('click', function onCabinetBodyClick(e) {
            const slot = e.target.closest('.cabinet-slot:not(.cabinet-slot--empty)');
            if (!slot) return;
            const idx = slot.getAttribute('data-item-index');
            if (idx == null) return;
            const item = appState.cabinetItems[parseInt(idx, 10)];
            if (item) openCabinetItemDetail(item);
        }, { once: true });
    }

    function openCabinetItemDetail(item, fromCabinetModal = true) {
        const { full: fullLabel } = getShortLabel(item);
        const imgSrc = item.scene ? item.scene.image : 'assets/cabinet-empty.svg';
        const detailHTML = `
            <div class="flex flex-col items-center gap-4 p-4">
                <img src="${imgSrc}" alt="${escapeHtml(fullLabel)}" class="max-w-full max-h-[50vh] object-contain rounded-xl shadow">
                <p class="text-base font-bold text-[#5c4a3a] text-center">${escapeHtml(fullLabel)}</p>
                <button type="button" class="text-sm text-[#8d7f73] underline hover:opacity-80">è¿”å›æ©±æŸœ</button>
            </div>
        `;
        if (!modalOverlay.classList.contains('hidden')) {
            modalBody.innerHTML = detailHTML;
        } else {
            openModal('çºªå¿µå“', detailHTML, 'cabinet');
        }
        const btn = modalBody.querySelector('button');
        if (btn) btn.addEventListener('click', () => {
            if (fromCabinetModal && lastCabinetBodyHTML) {
                modalBody.innerHTML = lastCabinetBodyHTML;
                modalBody.addEventListener('click', function onCabinetBodyClick(e) {
                    const slot = e.target.closest('.cabinet-slot:not(.cabinet-slot--empty)');
                    if (!slot) return;
                    const idx = slot.getAttribute('data-item-index');
                    if (idx == null) return;
                    const it = appState.cabinetItems[parseInt(idx, 10)];
                    if (it) openCabinetItemDetail(it, true);
                }, { once: true });
            } else {
                closeModal();
            }
        });
    }

    function openDiaryModal() {
        if (!diaryList) return;
        const hasUserDiaries = (appState.locations && appState.locations.length) > 0;
        const diaryHint = !hasUserDiaries ? '<p class="text-center text-[11px] text-gray-500 py-2">å¸¦æˆ‘å»æ‰“å¡ï¼Œè§£é”ç¬¬ä¸€ç¯‡æ—…è¡Œæ—¥è®°å§~</p>' : '';
        const bodyHTML = `
            <div class="flex flex-col gap-3 text-xs">
                <div class="text-[11px] text-gray-500">æœ€æ–°æ‰“å¡ä¼šå‡ºç°åœ¨æœ€ä¸Šæ–¹</div>
                ${diaryHint}
                <div class="flex flex-col gap-3">
                    ${diaryList.innerHTML}
                </div>
            </div>
        `;
        openModal('æ—…è¡Œæ—¥è®°', bodyHTML, 'diary');
    }

    function enterPetRoom() {
        triggerAIPetAction();
        setPetState(PET_STATES.IDLE_WAIT);

        // æ ¹æ®äººæ ¼åœ¨è¿›å…¥æˆ¿é—´æ—¶åšä¸€æ¬¡è½»å¾®è¡Œä¸ºå·®å¼‚
        const enterDecision = decidePersonalityBehavior('enter_room');
        if (enterDecision) {
            applyBehaviorDecision(enterDecision);
        }

        updateRoomHotspotPositions();

        const petViewEl = document.getElementById('view-petroom');
        if (petViewEl) {
            petViewEl.classList.add('entrance');
            setTimeout(() => petViewEl.classList.remove('entrance'), 450);
        }

        if (roomHint && !sessionStorage.getItem('petroom-hint-seen')) {
            roomHint.style.opacity = '1';
            setTimeout(() => {
                roomHint.style.opacity = '0';
                sessionStorage.setItem('petroom-hint-seen', '1');
            }, 3000);
        } else if (roomHint) {
            roomHint.style.opacity = '0';
        }
    }

    function leavePetRoom() {
        // ç¦»å¼€å® ç‰© Tab æ—¶ï¼Œæš‚åœè®¡æ—¶å™¨ï¼Œé¿å…åå°ä¹±è·³çŠ¶æ€
        clearPetTimers();
        clearInterval(appState.currentActionInterval);
        if (typeof stopPetWalk === 'function') {
            stopPetWalk();
        }
    }

    // --- è§†å›¾åˆ‡æ¢ï¼šå® ç‰©å°å±‹ <-> åœ°å›¾ ---
    function showPetRoom() {
        views.forEach(view => view.classList.remove('active'));
        const petView = document.getElementById('view-petroom');
        if (petView) {
            petView.classList.add('active');
            petView.scrollTop = 0;
        }
        enterPetRoom();
    }

    function showMap() {
        views.forEach(view => view.classList.remove('active'));
        const mapView = document.getElementById('view-home');
        if (mapView) {
            mapView.classList.add('active');
            mapView.scrollTop = 0;
        }
        leavePetRoom();
    }

    if (modalOverlay) {
        modalOverlay.addEventListener('click', (event) => {
            if (event.target === modalOverlay || event.target.hasAttribute('data-modal-close')) {
                closeModal();
            }
        });
    }

    if (hotspotCabinet) {
        hotspotCabinet.addEventListener('click', (event) => {
            event.stopPropagation();
            openCabinetModal();
        });
    }

    if (hotspotDiary) {
        hotspotDiary.addEventListener('click', (event) => {
            event.stopPropagation();
            openDiaryModal();
        });
    }

    // åœ°å›¾æŒ‚ç”»å…¥å£ï¼šç‚¹å‡»ä»å® ç‰©å°å±‹è¿›å…¥åœ°å›¾
    if (hotspotMap) {
        hotspotMap.addEventListener('click', (event) => {
            event.stopPropagation();
            wiggleHotspot(hotspotMap);
            markPetInteraction();
            showMap();
        });
    }

    if (actionCabinet) {
        actionCabinet.addEventListener('click', () => openCabinetModal());
    }
    if (cabinetGrid) {
        cabinetGrid.addEventListener('click', (e) => {
            const slot = e.target.closest('.cabinet-slot[data-item-index]');
            if (!slot) return;
            const idx = slot.getAttribute('data-item-index');
            if (idx == null) return;
            const item = appState.cabinetItems[parseInt(idx, 10)];
            if (item) openCabinetItemDetail(item, false);
        });
    }
    if (actionDiary) {
        actionDiary.addEventListener('click', () => openDiaryModal());
    }
    if (actionRest) {
        actionRest.addEventListener('click', () => {
            if (petLife.current === PET_STATES.REST) {
                triggerAIPetAction('è¢«å«é†’çš„æ—¶å€™ï¼Œçœ¼çš®è¿˜æœ‰ç‚¹æ²‰æ²‰çš„ã€‚');
                setPetState(PET_STATES.IDLE_WAIT);
            } else {
                triggerAIPetAction('å†³å®šå…ˆå°ç¡ä¸€ä¼šå„¿ï¼Œæ¢å¤ä½“åŠ›');
                setPetState(PET_STATES.REST);
            }
        });
    }

    // æˆ¿é—´çƒ­ç‚¹ï¼šåºŠ / é”… / é—¨ / æ¤ç‰©
    if (hotspotBed) {
        hotspotBed.addEventListener('click', (event) => {
            event.stopPropagation();
            wiggleHotspot(hotspotBed);
            markPetInteraction();
            const pCfg = typeof getCurrentPersonality === 'function' ? getCurrentPersonality() : null;
            const path = buildPathToHotspot('bed', pCfg);
            if (path && path.length) {
                walkPetAlongPath(path, {
                    contextOverride: 'åœ¨è½¯è½¯çš„åºŠä¸Šä¼¸äº†ä¸ªå¤§å¤§çš„æ‡’è…°',
                    stayMs: 2600,
                    animationState: 'rest',
                    resetToDefault: true,
                    onArrive: () => setPetState(PET_STATES.REST)
                });
            } else {
                movePetToSpot(
                    { bottom: '32%', left: '50%' },
                    'åœ¨è½¯è½¯çš„åºŠä¸Šä¼¸äº†ä¸ªå¤§å¤§çš„æ‡’è…°',
                    2600,
                    'rest'
                );
                setPetState(PET_STATES.REST);
            }
        });
    }

    if (hotspotPot) {
        hotspotPot.addEventListener('click', (event) => {
            event.stopPropagation();
            wiggleHotspot(hotspotPot);
            markPetInteraction();
            const pCfg = typeof getCurrentPersonality === 'function' ? getCurrentPersonality() : null;
            const path = buildPathToHotspot('pot', pCfg);
            if (path && path.length) {
                walkPetAlongPath(path, {
                    contextOverride: 'è·‘åˆ°é”…è¾¹å·å·é—»äº†ä¸€å¤§å£é¦™å‘³',
                    stayMs: 2600,
                    animationState: 'eat',
                    resetToDefault: true,
                    onArrive: () => setPetState(PET_STATES.INTERACT)
                });
            } else {
                movePetToSpot(
                    { bottom: '26%', left: '30%' },
                    'è·‘åˆ°é”…è¾¹å·å·é—»äº†ä¸€å¤§å£é¦™å‘³',
                    2600,
                    'eat'
                );
                setPetState(PET_STATES.INTERACT);
            }
        });
    }

    if (hotspotDoor) {
        hotspotDoor.addEventListener('click', (event) => {
            event.stopPropagation();
            wiggleHotspot(hotspotDoor);
            markPetInteraction();
            const pCfg = typeof getCurrentPersonality === 'function' ? getCurrentPersonality() : null;
            const path = buildPathToHotspot('door', pCfg);
            // åˆ°è¾¾é—¨å£åä»…åšäº’åŠ¨ä¸æç¤ºï¼Œä¸å†å¼ºåˆ¶è·³è½¬åˆ°åœ°å›¾é¡µ
            const arriveAtDoor = () => {
                setPetState(PET_STATES.INTERACT);
            };

            if (path && path.length) {
                walkPetAlongPath(path, {
                    contextOverride: 'è·‘åˆ°é—¨å£ï¼Œè½»è½»æ¢å‡ºå¤´çœ‹äº†çœ‹é—¨å¤–çš„ä¸–ç•Œ',
                    stayMs: 800,
                    animationState: 'door',
                    resetToDefault: true,
                    onArrive: arriveAtDoor
                });
            } else {
                movePetToSpot(
                    ROOM_TARGET_HOTSPOTS.door,
                    'è·‘åˆ°é—¨å£ï¼Œè½»è½»æ¢å‡ºå¤´çœ‹äº†çœ‹é—¨å¤–çš„ä¸–ç•Œ',
                    800,
                    'door'
                );
                arriveAtDoor();
            }
        });
    }

    if (hotspotPlant) {
        hotspotPlant.addEventListener('click', (event) => {
            event.stopPropagation();
            wiggleHotspot(hotspotPlant);
            markPetInteraction();
            triggerAIPetAction('é åœ¨ç»¿æ¤æ—è¾¹å®‰é™åœ°å‘¼å¸æ–°é²œç©ºæ°”');
            playPetAnimation('plant', { loop: false, frameInterval: 220, cycles: 3 });
            setPetState(PET_STATES.IDLE_BREATH);
        });
    }

    // --- å® ç‰©æ€§æ ¼åˆ‡æ¢ ---
    petPersonalitySelect.addEventListener('change', (e) => {
        appState.petPersonality = e.target.value;

        // åŠ¨ç”»åé¦ˆ
        if (petAvatarRoom) {
            petAvatarRoom.style.transform = 'translate(-50%, 0) scale(1.2) rotate(10deg)';
            setTimeout(() => { petAvatarRoom.style.transform = 'translateX(-50%)'; }, 300);
        }
        
        markPetInteraction();
        triggerAIPetAction(); // åˆ‡æ¢æ€§æ ¼ç«‹åˆ»ç”Ÿæˆæ–°çŠ¶æ€
        setPetState(PET_STATES.INTERACT);
    });

    const energyFingerprint = document.getElementById('energy-fingerprint-area');
    const energyParticlesContainer = document.getElementById('energy-particles');
    let energyPressTimer = null;
    let energyChargeInterval = null;

    // --- èƒ½é‡ä¼ é€’äº¤äº’ ---
    if (energyFingerprint) {
        // å¼€å§‹æŒ‰å‹
        const startCharge = (e) => {
            e.preventDefault();
            energyFingerprint.classList.add('active');
            energyFingerprint.classList.add('energy-charging'); // æ’­æ”¾å‘¼å¸å…‰æ™•åŠ¨ç”»
            
            // æ’­æ”¾å¿ƒè·³èƒŒæ™¯
            document.body.classList.add('heartbeat-bg-active');

            // è§¦å‘ä¸€æ¬¡ç®€çŸ­åé¦ˆ
            triggerAIPetAction('æ„Ÿå—åˆ°äº†ç†Ÿæ‚‰çš„èƒ½é‡åœ¨æ…¢æ…¢æµè¿‡æ¥â€¦ â¤ï¸');
            playPetAnimation('idle_observe', { loop: true }); // å˜ä¸ºè§‚å¯Ÿ/ä¸“æ³¨çŠ¶æ€

            // æŒç»­ç”Ÿæˆç²’å­
            energyChargeInterval = setInterval(() => {
                createEnergyParticle();
                // æ¨¡æ‹Ÿæ‰‹æœºéœ‡åŠ¨åé¦ˆ (å¦‚æœæ”¯æŒ)
                if (navigator.vibrate) navigator.vibrate(15);
            }, 100);

            // é•¿æŒ‰åˆ¤å®šï¼šè¶…è¿‡ 2 ç§’è§†ä¸ºä¸€æ¬¡å®Œæ•´å……èƒ½
            energyPressTimer = setTimeout(() => {
                triggerAIPetAction('èƒ½é‡å……æ»¡å•¦ï¼å¥½æ¸©æš–ï¼âœ¨');
                playExcitedAnimation();
                if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
            }, 2000);
        };

        // ç»“æŸæŒ‰å‹
        const stopCharge = () => {
            energyFingerprint.classList.remove('active');
            energyFingerprint.classList.remove('energy-charging');
            document.body.classList.remove('heartbeat-bg-active');
            
            clearInterval(energyChargeInterval);
            clearTimeout(energyPressTimer);
            energyChargeInterval = null;
            energyPressTimer = null;

            // æ¢å¤é»˜è®¤çŠ¶æ€
            setTimeout(() => {
                if (petLife.current !== PET_STATES.REST) {
                    setPetState(PET_STATES.IDLE_BREATH);
                }
            }, 1000);
        };

        energyFingerprint.addEventListener('mousedown', startCharge);
        energyFingerprint.addEventListener('touchstart', startCharge, { passive: false });
        
        energyFingerprint.addEventListener('mouseup', stopCharge);
        energyFingerprint.addEventListener('mouseleave', stopCharge);
        energyFingerprint.addEventListener('touchend', stopCharge);
        energyFingerprint.addEventListener('touchcancel', stopCharge);
    }

    function createEnergyParticle() {
        if (!energyParticlesContainer || !petAvatarRoom) return;
        
        const rect = energyFingerprint.getBoundingClientRect();
        const startX = rect.left + rect.width / 2;
        const startY = rect.top + rect.height / 2;
        
        const petRect = petAvatarRoom.getBoundingClientRect();
        const endX = petRect.left + petRect.width / 2;
        const endY = petRect.top + petRect.height / 2;
        
        const particle = document.createElement('div');
        particle.className = 'energy-particle';
        
        // éšæœºåç§»èµ·å§‹ç‚¹
        const offsetX = (Math.random() - 0.5) * 40;
        const offsetY = (Math.random() - 0.5) * 40;
        
        particle.style.left = `${startX + offsetX}px`;
        particle.style.top = `${startY + offsetY}px`;
        
        // è®¡ç®— CSS å˜é‡ç”¨äºåŠ¨ç”»ç»ˆç‚¹
        const tx = endX - (startX + offsetX);
        const ty = endY - (startY + offsetY);
        particle.style.setProperty('--tx', `${tx}px`);
        particle.style.setProperty('--ty', `${ty}px`);
        
        energyParticlesContainer.appendChild(particle);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤
        setTimeout(() => {
            particle.remove();
        }, 1000);
    }

    // --- æ ¸å¿ƒï¼šæ‰“å¡è”åŠ¨ ---
    btnCheckin.addEventListener('click', async () => {
        if (isCheckinInProgress) return;

        const location = locationInput.value.trim();
        if (!location) return;

        isCheckinInProgress = true;

        const originalText = btnCheckin.innerText;
        btnCheckin.disabled = true;
        btnCheckin.innerText = 'å†™æ—¥è®°ä¸­â€¦';

        try {
            appState.locations.push(location);
            
            // 1. åœ¨åœ°å›¾ä¸Šéšæœºä½ç½®ç”Ÿæˆæ‰“å¡å›¾é’‰
            addMapPin(location);

            let diaryText = '';
            let usedFallback = false;

            console.log('[Diary AIGC] æ­£åœ¨é€šè¿‡ /api/chat è¯·æ±‚ç”Ÿæˆæ—¥è®°â€¦');
            const result = await generateDiaryWithAIGC(location, appState.petPersonality);
            if (result && result.ok && result.content) {
                diaryText = result.content;
            } else {
                usedFallback = true;
                console.warn('[Diary AIGC] ä½¿ç”¨æœ¬åœ°æ¨¡æ¿æ—¥è®°ä½œä¸ºå…œåº•ã€‚åŸå› :', result && result.error ? result.error : 'è¿”å›å†…å®¹ä¸ºç©º');
            }

            if (!diaryText) {
                diaryText = buildDiaryText(location, appState.petPersonality);
            }

            const n = appState.locations.length;
            const droppedScene = getDroppedScene(n);
            const scene = droppedScene || getSceneAsset(location);

            // æœ¬æ¬¡å‚è€ƒçš„æ—…è¡Œè®°å¿†æ¡æ•°ï¼ˆç”¨äºæˆåŠŸæç¤ºï¼›åœ¨ append å‰è®¡ç®—ï¼Œé¿å…æŠŠæ–°è®°å…¥ç®—è¿›å»ï¼‰
            let memoryCountForHint = (result && result.ok && typeof result.memoryCount === 'number') ? result.memoryCount : 0;
            if (memoryCountForHint === 0) {
                const travelMemories = typeof getEpisodicTravel === 'function' ? getEpisodicTravel() : [];
                const relevant = location ? travelMemories.filter((m) => (m.location_city || m.location || '').indexOf(location) >= 0 || (location || '').indexOf(m.location_city || m.location || '') >= 0) : travelMemories;
                memoryCountForHint = relevant.slice(0, 2).length;
            }

            // 2. ç”Ÿæˆæ—¥è®°ï¼ˆä½¿ç”¨æœ¬æ¬¡å®é™…æ‰è½çš„ sceneï¼‰
            const diaryMeta = generateDiaryEntry(location, diaryText, scene);

            // 2.5 ç”Ÿæˆä¸€æ¡æƒ…æ™¯è®°å¿†
            if (diaryMeta && diaryMeta.diaryId) {
                appendEpisodicMemory({
                    date: diaryMeta.date,
                    location,
                    scene,
                    diaryId: String(diaryMeta.diaryId),
                    diaryText
                });
            }

            // 3. æ”¹å˜å® ç‰©æˆ¿é—´çŠ¶æ€ä¸æ©±æŸœ
            triggerAIPetAction(`åˆšæ‰å»äº†${location}`);
            setPetState(PET_STATES.INTERACT);
            if (petRoomBadge) petRoomBadge.classList.remove('hidden'); // æç¤ºå® ç‰©æˆ¿é—´æœ‰æ–°åŠ¨æ€
            if (diaryBadge) diaryBadge.classList.remove('hidden');   // æç¤ºå® ç‰©é¡µæœ‰æ–°æ—¥è®°
            if (actionDiaryBadge) actionDiaryBadge.classList.remove('hidden');
            const cabinetNotFull = (!appState.cabinetItems || appState.cabinetItems.length < CABINET_SLOTS);
            if (cabinetNotFull && droppedScene && actionCabinetBadge) actionCabinetBadge.classList.remove('hidden');
            if (cabinetNotFull && droppedScene) {
                addCabinetItem(location, droppedScene);
                showScenePreview(location, droppedScene);
            }
            playExcitedAnimation();                 // å® ç‰©æ’­æ”¾ä¸€æ¬¡å…´å¥‹åŠ¨ç”»

            if (usedFallback) {
                console.warn('[Diary AIGC] ä½¿ç”¨æœ¬åœ°æ¨¡æ¿æ—¥è®°ä½œä¸ºå…œåº•ã€‚');
            }

            // æŒ‰é’®è§†è§‰åé¦ˆ
            locationInput.value = '';
            btnCheckin.innerText = memoryCountForHint > 0 ? `æ‰“å¡æˆåŠŸï¼å·²å‚è€ƒ ${memoryCountForHint} æ¡æ—…è¡Œè®°å¿†` : 'æ‰“å¡æˆåŠŸ!';
            if (btnCheckin.classList.contains('bg-[#ff8fab]')) {
                btnCheckin.classList.replace('bg-[#ff8fab]', 'bg-[#9bdeac]');
            }
            setTimeout(() => {
                btnCheckin.innerText = originalText || 'å»æ‰“å¡';
                if (btnCheckin.classList.contains('bg-[#9bdeac]')) {
                    btnCheckin.classList.replace('bg-[#9bdeac]', 'bg-[#ff8fab]');
                }
            }, 1500);
        } catch (e) {
            console.error('[Diary AIGC] ç”Ÿæˆæ—¥è®°æµç¨‹å‡ºç°å¼‚å¸¸:', e);
        } finally {
            btnCheckin.disabled = false;
            isCheckinInProgress = false;
        }
    });

    // --- åœ°ç‚¹æ ‡å‡†åŒ–ä¸ä¸­å›½åœ°å›¾åæ ‡æ˜ å°„ ---
    function normalizeLocationName(raw) {
        if (!raw) return '';
        let text = String(raw)
            .trim()
            .replace(/[\s\u3000]+/g, ''); // å»æ‰åŠè§’/å…¨è§’ç©ºæ ¼

        const aliasMap = {
            'åŒ—äº¬å¸‚': 'åŒ—äº¬',
            'å¤©æ´¥å¸‚': 'å¤©æ´¥',
            'ä¸Šæµ·å¸‚': 'ä¸Šæµ·',
            'é‡åº†å¸‚': 'é‡åº†',
            'å†…è’™': 'å†…è’™å¤',
            'å†…è’™å¤è‡ªæ²»åŒº': 'å†…è’™å¤',
            'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': 'å¹¿è¥¿',
            'å®å¤å›æ—è‡ªæ²»åŒº': 'å®å¤',
            'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': 'æ–°ç–†',
            'è¥¿è—è‡ªæ²»åŒº': 'è¥¿è—',
            'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº': 'é¦™æ¸¯',
            'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº': 'æ¾³é—¨'
        };

        if (aliasMap[text]) return aliasMap[text];

        text = text
            .replace(/çœ$/g, '')
            .replace(/å¸‚$/g, '')
            .replace(/ç‰¹åˆ«è¡Œæ”¿åŒº$/g, '')
            .replace(/å£®æ—è‡ªæ²»åŒº$/g, '')
            .replace(/å›æ—è‡ªæ²»åŒº$/g, '')
            .replace(/ç»´å¾å°”è‡ªæ²»åŒº$/g, '')
            .replace(/è‡ªæ²»åŒº$/g, '');

        if (aliasMap[text]) return aliasMap[text];
        return text;
    }

    // çœçº§è¡Œæ”¿åŒº + è‹¥å¹²çƒ­é—¨åŸå¸‚åœ¨å½“å‰å¡é€šåœ°å›¾ä¸Šçš„å¤§è‡´åæ ‡ï¼ˆåŸºäºåœ°å›¾å›¾ç‰‡å†…éƒ¨çš„å½’ä¸€åŒ–åæ ‡ï¼š0~1ï¼‰
    // x: ä»å·¦åˆ°å³çš„æ¯”ä¾‹ï¼Œy: ä»ä¸Šåˆ°ä¸‹çš„æ¯”ä¾‹
    const locationMap = {
        // ç›´è¾–å¸‚ / ååŒ—
        'åŒ—äº¬':   { x: 0.62, y: 0.28 },
        'å¤©æ´¥':   { x: 0.66, y: 0.30 },
        'æ²³åŒ—':   { x: 0.59, y: 0.32 },
        'å±±è¥¿':   { x: 0.54, y: 0.34 },
        'å†…è’™å¤': { x: 0.50, y: 0.26 },

        // ä¸œåŒ—
        'è¾½å®':   { x: 0.69, y: 0.26 },
        'å‰æ—':   { x: 0.74, y: 0.23 },
        'é»‘é¾™æ±Ÿ': { x: 0.78, y: 0.19 },

        // åä¸œ
        'ä¸Šæµ·':   { x: 0.74, y: 0.46 },
        'æ±Ÿè‹':   { x: 0.70, y: 0.42 },
        'æµ™æ±Ÿ':   { x: 0.71, y: 0.50 },
        'å±±ä¸œ':   { x: 0.67, y: 0.38 },
        'å®‰å¾½':   { x: 0.63, y: 0.46 },
        'æ±Ÿè¥¿':   { x: 0.60, y: 0.56 },
        'ç¦å»º':   { x: 0.66, y: 0.58 },

        // åä¸­
        'æ²³å—':   { x: 0.58, y: 0.42 },
        'æ¹–åŒ—':   { x: 0.55, y: 0.48 },
        'æ¹–å—':   { x: 0.55, y: 0.54 },

        // åå—
        'å¹¿ä¸œ':   { x: 0.58, y: 0.64 },
        'å¹¿è¥¿':   { x: 0.50, y: 0.66 },
        'æµ·å—':   { x: 0.58, y: 0.76 },
        'é¦™æ¸¯':   { x: 0.61, y: 0.67 },
        'æ¾³é—¨':   { x: 0.58, y: 0.68 },
        'å°æ¹¾':   { x: 0.74, y: 0.63 },

        // è¥¿å—
        'é‡åº†':   { x: 0.54, y: 0.55 },
        'å››å·':   { x: 0.48, y: 0.51 },
        'è´µå·':   { x: 0.50, y: 0.58 },
        'äº‘å—':   { x: 0.45, y: 0.63 },
        'è¥¿è—':   { x: 0.28, y: 0.60 },

        // è¥¿åŒ—
        'é™•è¥¿':   { x: 0.50, y: 0.41 },
        'ç”˜è‚ƒ':   { x: 0.40, y: 0.37 },
        'é’æµ·':   { x: 0.34, y: 0.38 },
        'å®å¤':   { x: 0.46, y: 0.35 },
        'æ–°ç–†':   { x: 0.24, y: 0.27 },

        // çƒ­é—¨åŸå¸‚ï¼ˆåœ¨çœä»½å†…å¤§è‡´ä½ç½®ï¼‰
        'æ­¦æ±‰':   { x: 0.56, y: 0.48 },
        'å—äº¬':   { x: 0.71, y: 0.44 },
        'æ­å·':   { x: 0.72, y: 0.50 },
        'æˆéƒ½':   { x: 0.46, y: 0.52 },
        'è¥¿å®‰':   { x: 0.51, y: 0.42 },
        'é’å²›':   { x: 0.69, y: 0.36 },
        'å¦é—¨':   { x: 0.67, y: 0.60 },
        'æ·±åœ³':   { x: 0.59, y: 0.66 },
        'å¹¿å·':   { x: 0.58, y: 0.65 },
        'è‹å·':   { x: 0.72, y: 0.44 },
        'é•¿æ²™':   { x: 0.56, y: 0.54 },
        'éƒ‘å·':   { x: 0.57, y: 0.42 },
        'æµå—':   { x: 0.65, y: 0.38 },
        'å“ˆå°”æ»¨': { x: 0.78, y: 0.20 },
        'æ²ˆé˜³':   { x: 0.70, y: 0.26 },
        'æ˜†æ˜':   { x: 0.42, y: 0.64 },
        'å¤§ç†':   { x: 0.38, y: 0.62 },
        'ä¸½æ±Ÿ':   { x: 0.36, y: 0.60 },
        'æ´›é˜³':   { x: 0.55, y: 0.42 },
        'æ¡‚æ—':   { x: 0.52, y: 0.64 },
        'ç æµ·':   { x: 0.58, y: 0.67 },
        'å¤§è¿':   { x: 0.72, y: 0.24 },
        'å®æ³¢':   { x: 0.73, y: 0.50 },
        'æ— é”¡':   { x: 0.71, y: 0.44 },
        'åˆè‚¥':   { x: 0.64, y: 0.46 },
        'ç¦å·':   { x: 0.66, y: 0.58 },
        'å—æ˜Œ':   { x: 0.61, y: 0.56 },
        'çŸ³å®¶åº„': { x: 0.60, y: 0.32 },
        'å¤ªåŸ':   { x: 0.54, y: 0.34 },
        'å‘¼å’Œæµ©ç‰¹': { x: 0.48, y: 0.28 },
        'ä¹Œé²æœ¨é½': { x: 0.22, y: 0.30 },
        'æ‹‰è¨':   { x: 0.26, y: 0.62 },
        'ä¸‰äºš':   { x: 0.56, y: 0.78 }
    };

    const chinaMapContainer = document.getElementById('china-map-container');
    const chinaMapImg = document.getElementById('china-map-img');

    function getPositionFromRatio(xRatio, yRatio) {
        if (!chinaMapContainer) {
            return { top: '50%', left: '50%' };
        }

        const containerRect = chinaMapContainer.getBoundingClientRect();
        let imgRect = chinaMapImg ? chinaMapImg.getBoundingClientRect() : null;

        // å¦‚æœå›¾ç‰‡å°šæœªåŠ è½½æˆåŠŸï¼Œé€€åŒ–ä¸ºä½¿ç”¨å®¹å™¨è‡ªèº«å°ºå¯¸
        if (!imgRect || imgRect.width === 0 || imgRect.height === 0) {
            imgRect = containerRect;
        }

        const pxX = imgRect.left + imgRect.width * xRatio;
        const pxY = imgRect.top + imgRect.height * yRatio;

        const leftPercent = ((pxX - containerRect.left) / containerRect.width) * 100;
        const topPercent = ((pxY - containerRect.top) / containerRect.height) * 100;

        return {
            top: `${topPercent}%`,
            left: `${leftPercent}%`
        };
    }

    // åŸå¸‚ â†’ çœä»½ï¼ˆç”¨äºæœªåœ¨ locationMap ä¸­çš„åœ°åå…œåº•ï¼Œè½åœ¨å¯¹åº”çœä»½ä¸­å¿ƒï¼‰
    const cityToProvince = {
        'å®œæ˜Œ': 'æ¹–åŒ—', 'è¥„é˜³': 'æ¹–åŒ—', 'è†å·': 'æ¹–åŒ—', 'é»„å†ˆ': 'æ¹–åŒ—',
        'å¾å·': 'æ±Ÿè‹', 'å—é€š': 'æ±Ÿè‹', 'å¸¸å·': 'æ±Ÿè‹', 'æ‰¬å·': 'æ±Ÿè‹', 'é•‡æ±Ÿ': 'æ±Ÿè‹', 'æ— é”¡': 'æ±Ÿè‹',
        'æ¸©å·': 'æµ™æ±Ÿ', 'ç»å…´': 'æµ™æ±Ÿ', 'å˜‰å…´': 'æµ™æ±Ÿ', 'é‡‘å': 'æµ™æ±Ÿ', 'å°å·': 'æµ™æ±Ÿ',
        'çƒŸå°': 'å±±ä¸œ', 'å¨æµ·': 'å±±ä¸œ', 'æ½åŠ': 'å±±ä¸œ', 'æ·„åš': 'å±±ä¸œ', 'ä¸´æ²‚': 'å±±ä¸œ',
        'å”å±±': 'æ²³åŒ—', 'ä¿å®š': 'æ²³åŒ—', 'é‚¯éƒ¸': 'æ²³åŒ—', 'ç§¦çš‡å²›': 'æ²³åŒ—',
        'ä½›å±±': 'å¹¿ä¸œ', 'ä¸œè': 'å¹¿ä¸œ', 'æ±•å¤´': 'å¹¿ä¸œ', 'æ¹›æ±Ÿ': 'å¹¿ä¸œ', 'ä¸­å±±': 'å¹¿ä¸œ', 'æƒ å·': 'å¹¿ä¸œ',
        'æ³‰å·': 'ç¦å»º', 'æ¼³å·': 'ç¦å»º', 'ç¦å·': 'ç¦å»º', 'è†ç”°': 'ç¦å»º',
        'æŸ³å·': 'å¹¿è¥¿', 'åŒ—æµ·': 'å¹¿è¥¿', 'å—å®': 'å¹¿è¥¿',
        'éµä¹‰': 'è´µå·', 'è´µé˜³': 'è´µå·', 'å…­ç›˜æ°´': 'è´µå·',
        'ç»µé˜³': 'å››å·', 'ä¹å±±': 'å››å·', 'å¾·é˜³': 'å››å·', 'å®œå®¾': 'å››å·', 'å—å……': 'å››å·',
        'å¼€å°': 'æ²³å—', 'å—é˜³': 'æ²³å—', 'å®‰é˜³': 'æ²³å—', 'æ–°ä¹¡': 'æ²³å—', 'å•†ä¸˜': 'æ²³å—',
        'å²³é˜³': 'æ¹–å—', 'æ ªæ´²': 'æ¹–å—', 'æ¹˜æ½­': 'æ¹–å—', 'è¡¡é˜³': 'æ¹–å—', 'å¼ å®¶ç•Œ': 'æ¹–å—',
        'èµ£å·': 'æ±Ÿè¥¿', 'ä¹æ±Ÿ': 'æ±Ÿè¥¿', 'ä¸Šé¥¶': 'æ±Ÿè¥¿',
        'èŠœæ¹–': 'å®‰å¾½', 'èšŒåŸ ': 'å®‰å¾½', 'å®‰åº†': 'å®‰å¾½', 'é»„å±±': 'å®‰å¾½',
        'åŒ…å¤´': 'å†…è’™å¤', 'é„‚å°”å¤šæ–¯': 'å†…è’™å¤',
        'å¤§åº†': 'é»‘é¾™æ±Ÿ', 'é½é½å“ˆå°”': 'é»‘é¾™æ±Ÿ', 'ç‰¡ä¸¹æ±Ÿ': 'é»‘é¾™æ±Ÿ',
        'å‰æ—å¸‚': 'å‰æ—', 'é•¿æ˜¥': 'å‰æ—',
        'ç§¦çš‡å²›': 'æ²³åŒ—', 'æ‰¿å¾·': 'æ²³åŒ—'
    };

    function isChinaLocation(location) {
        const n = normalizeLocationName(location);
        if (locationMap[n] || cityToProvince[n]) return true;
        const allKeys = [...Object.keys(locationMap), ...Object.keys(cityToProvince)];
        for (const k of allKeys) {
            if (n.includes(k) || (k && n.indexOf(k) !== -1)) return true;
        }
        return false;
    }

    // --- åœ°å›¾çœä»½çƒ­ç‚¹å±‚ï¼šå¯ç‚¹å‡»çœä»½ï¼Œå¡«å…¥åœ°ç‚¹å¹¶æ‰“å¡ ---
    const mapHotspotsEl = document.getElementById('map-hotspots');
    function createMapHotspots() {
        if (!mapHotspotsEl) return;
        mapHotspotsEl.innerHTML = '';

        Object.entries(locationMap).forEach(([name, pos]) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'map-hotspot';
            btn.setAttribute('aria-label', `åœ¨${name}æ‰“å¡`);

            const { top, left } = getPositionFromRatio(pos.x, pos.y);
            btn.style.top = top;
            btn.style.left = left;

            btn.dataset.location = name;
            btn.title = `ç‚¹å‡»åœ¨ ${name} æ‰“å¡`;
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                if (!locationInput) return;
                locationInput.value = name;
                if (btnCheckin && !isCheckinInProgress) btnCheckin.click();
            });
            mapHotspotsEl.appendChild(btn);
        });
    }

    if (mapHotspotsEl) {
        createMapHotspots();
        if (chinaMapImg) {
            chinaMapImg.addEventListener('load', () => {
                createMapHotspots();
            });
        }
        window.addEventListener('resize', () => {
            window.requestAnimationFrame(createMapHotspots);
        });
    }

    // --- æ—¥è®°æ’å›¾ï¼šäº‹ä»¶å§”æ‰˜ä¸æ–‡ä»¶è¯»å– ---
    let currentDiaryForImage = null;

    function setupDiaryImageHandlers() {
        if (!diaryImageInput) return;

        document.addEventListener('click', (event) => {
            const btn = event.target.closest('.diary-add-image');
            if (!btn) return;
            const diaryId = btn.getAttribute('data-diary-id');
            if (!diaryId) return;
            currentDiaryForImage = diaryId;
            diaryImageInput.value = '';
            diaryImageInput.click();
        });

        diaryImageInput.addEventListener('change', (event) => {
            const file = event.target.files && event.target.files[0];
            const diaryId = currentDiaryForImage;
            if (!file || !diaryId) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const src = e.target.result;
                if (!src) return;

                if (!appState.diaryImages) appState.diaryImages = {};
                if (!appState.diaryImages[diaryId]) appState.diaryImages[diaryId] = [];
                appState.diaryImages[diaryId].push(src);

                const containers = document.querySelectorAll(`[data-diary-id="${diaryId}"] .diary-images`);
                containers.forEach((container) => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.alt = 'æ—¥è®°æ’å›¾';
                    img.className = 'w-16 h-16 rounded-xl object-cover border border-white shadow-sm';
                    container.appendChild(img);
                });
            };
            reader.readAsDataURL(file);

            currentDiaryForImage = null;
            diaryImageInput.value = '';
        });
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ åœ°å›¾å›¾é’‰ ---
    function addMapPin(location) {
        const key = normalizeLocationName(location);
        let mapping = locationMap[key];

        if (!mapping && cityToProvince[key]) {
            const province = cityToProvince[key];
            mapping = locationMap[province];
        }

        let top;
        let left;
        if (mapping) {
            const pos = getPositionFromRatio(mapping.x, mapping.y);
            top = pos.top;
            left = pos.left;
        } else {
            // åœ¨è§„å®šèŒƒå›´å†…éšæœºç”Ÿæˆåæ ‡ (é¿å¼€è¾¹ç¼˜) ä½œä¸ºå…œåº•
            const randomX = (Math.floor(Math.random() * 60) + 20) / 100; // 0.2 - 0.8
            const randomY = (Math.floor(Math.random() * 60) + 20) / 100;
            const pos = getPositionFromRatio(randomX, randomY);
            left = pos.left;
            top = pos.top;
        }
        
        const pinHTML = `
            <div class="absolute pin-drop flex flex-col items-center" style="top: ${top}; left: ${left};">
                <div class="bg-white/90 text-xs font-bold px-2 py-0.5 rounded-full shadow-md text-[#ff8fab] mb-1 whitespace-nowrap border border-[#ff8fab]">
                    ${location}
                </div>
                <div class="text-2xl drop-shadow-md">ğŸ“</div>
            </div>
        `;
        mapPinsContainer.insertAdjacentHTML('beforeend', pinHTML);
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šAIæ¨¡æ‹Ÿå® ç‰©äº’åŠ¨çŠ¶æ€ç”Ÿæˆ ---
    function triggerAIPetAction(contextOverride = null) {
        clearInterval(appState.currentActionInterval);

        // è¡Œèµ°è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«ä¸Šä¸‹æ–‡ï¼Œå°±å°½é‡å°‘å†’æ³¡ï¼Œé¿å…å¹²æ‰°è§†è§‰
        if (petWalk && petWalk.isWalking && !contextOverride) {
            return;
        }

        const generateText = () => {
            const personality = appState.petPersonality;
            const pConfig = PERSONALITY_TYPES[personality];
            const hasTraveled = appState.locations.length > 0;
            const lastLocation = hasTraveled ? appState.locations[appState.locations.length - 1] : '';

            if (contextOverride) {
                return `å“‡ï½${contextOverride}ï¼Œå¤ªå¼€å¿ƒå•¦ï¼âœ¨`;
            }

            if (!pConfig) return 'åœ¨ç­‰å’Œä½ ä¸€èµ·å»æ—…è¡Œï½ âœ¨';

            // ä¸€å®šæ¦‚ç‡ä½¿ç”¨è®°å¿†ä¸­çš„æ—ç™½ä½œä¸ºæ°”æ³¡ï¼ˆä½“ç°è®°å¿†é©±åŠ¨äº’åŠ¨ï¼‰
            const episodicTravel = typeof getEpisodicTravel === 'function' ? getEpisodicTravel() : [];
            const episodicDaily = typeof getEpisodicDaily === 'function' ? getEpisodicDaily() : [];
            const recentMemories = episodicTravel.slice(0, 2).concat(episodicDaily.slice(0, 1));
            if (recentMemories.length > 0 && Math.random() < 0.25) {
                const m = recentMemories[Math.floor(Math.random() * recentMemories.length)];
                const line = (m.narration || m.text || '').trim();
                if (line && line.length <= 80) return line;
                if (line && line.length > 80) return line.slice(0, 77) + 'â€¦';
            }

            // ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ—…è¡Œç›¸å…³çš„å›å¿†å¯¹è¯
            if (hasTraveled && pConfig.travelDialogue && Math.random() > 0.6) {
                return pConfig.travelDialogue.replace('{location}', lastLocation);
            }
            
            // å¦åˆ™éšæœºä»æ—¥å¸¸å¯¹è¯åº“ä¸­æŠ½å–
            const dialogues = pConfig.dialogues || [];
            return dialogues.length > 0 
                ? dialogues[Math.floor(Math.random() * dialogues.length)] 
                : 'åœ¨ç­‰å’Œä½ ä¸€èµ·å»æ—…è¡Œï½ âœ¨';
        };

        const p = getCurrentPersonality();
        const delay = p.reactionDelay || 0;
        
        // ç†æ€§äººæ ¼å¢åŠ â€œæ€è€ƒâ€å»¶è¿Ÿ
        if (delay > 0) {
            // å…ˆæ˜¾ç¤ºâ€œæ€è€ƒä¸­â€çš„çœç•¥å·ï¼Œå†åœ¨å»¶è¿Ÿåç»™å‡ºæ­£å¼å†…å®¹
            showPetMessage('...', { duration: delay + 500 });
            setTimeout(() => {
                showPetMessage(generateText());
            }, delay);
        } else {
            showPetMessage(generateText());
        }
    }

    // --- å® ç‰©åºåˆ—å¸§åŠ¨ç”»ï¼šå¤šçŠ¶æ€ç®¡ç† ---
    function makeFrames(folder, prefix, count) {
        const frames = [];
        for (let i = 1; i <= count; i++) {
            const index = i.toString().padStart(3, '0');
            frames.push(`æ¯”å¡ä¸˜åŠ¨ç”»å¯¼å‡º/${folder}/${prefix}_${index}.png`);
        }
        return frames;
    }

    const petAnimationStates = {
        idle_wait: makeFrames('ç­‰å¾…', 'flog_dengdai', 6),
        idle_breath: makeFrames('å‘¼å¸', 'frog_idle', 6),
        idle_observe: makeFrames('è§‚å¯Ÿ', 'flog_guancha', 6),
        interact: makeFrames('äº’åŠ¨', 'flog_hudong', 6),
        rest: makeFrames('ä¼‘æ¯', 'flog_xiuxi', 6),
        eat: makeFrames('äº’åŠ¨', 'flog_hudong', 6),
        door: makeFrames('äº’åŠ¨', 'flog_hudong', 6),
        plant: makeFrames('å‘¼å¸', 'frog_idle', 6)
    };

    const petAnimation = {
        currentState: 'idle_breath',
        index: 0,
        timer: null
    };

    function playPetAnimation(stateKey, options = {}) {
        if (!petAvatarSprite) return;

        const frames = petAnimationStates[stateKey] && petAnimationStates[stateKey].length
            ? petAnimationStates[stateKey]
            : petAnimationStates.idle_breath;

        if (!frames || !frames.length) return;

        const loop = options.loop !== undefined ? options.loop : stateKey === 'idle_breath';
        const pConfig = getCurrentPersonality();
        // æ ¹æ®äººæ ¼èƒ½é‡å€¼è°ƒæ•´åŸºç¡€å¸§ç‡ï¼šå¤–å‘(0.8)å¿«ï¼Œå†…å‘(1.5)æ…¢
        const baseInterval = stateKey === 'idle_breath' ? 800 : 200;
        const speedMultiplier = pConfig.animSpeed || 1.0;
        const frameInterval = options.frameInterval || Math.floor(baseInterval * speedMultiplier);
        
        const maxCycles = options.cycles || 2;

        // åˆ‡æ¢å›¾ç‰‡å¸§
        clearInterval(petAnimation.timer);
        petAnimation.currentState = stateKey;
        petAnimation.index = 0;
        petAvatarSprite.src = frames[0];

        let played = 0;
        petAnimation.timer = setInterval(() => {
            petAnimation.index = (petAnimation.index + 1) % frames.length;
            petAvatarSprite.src = frames[petAnimation.index];

            if (!loop) {
                played++;
                if (played >= frames.length * maxCycles) {
                    clearInterval(petAnimation.timer);
                    if (stateKey !== 'idle_breath') {
                        playPetAnimation('idle_breath', { loop: true, frameInterval: 800 });
                    }
                }
            }
        }, frameInterval);

        // åˆ‡æ¢å¯¹åº”çš„èº«ä½“åŠ¨æ•ˆ class
        const stateClassMap = {
            idle_wait: 'pet-anim-idle',
            idle_breath: 'pet-anim-idle',
            idle_observe: 'pet-anim-idle',
            interact: 'pet-anim-excited',
            rest: 'pet-anim-sleep',
            eat: 'pet-anim-eat',
            door: 'pet-anim-door',
            plant: 'pet-anim-plant'
        };

        Object.values(stateClassMap).forEach(cls => {
            petAvatarSprite.classList.remove(cls);
        });
        const cls = stateClassMap[stateKey] || stateClassMap.idle_breath;
        if (cls) {
            petAvatarSprite.classList.add(cls);
        }
    }

    function startIdleAnimation() {
        playPetAnimation('idle_breath', { loop: true, frameInterval: 800 });
    }

    function playExcitedAnimation() {
        setPetState(PET_STATES.INTERACT);
    }

    // åˆå§‹ä¸ä¸»åŠ¨å¯åŠ¨ï¼Œæ¯”å¡ä¸˜åœ¨é¦–æ¬¡è¿›å…¥å® ç‰©é¡µæ—¶å†æ¿€æ´»
    // ä½†å¦‚æœé»˜è®¤é¡µå°±æ˜¯å® ç‰©é¡µï¼ˆä¾‹å¦‚åç»­æ”¹åŠ¨ï¼‰ï¼Œåˆ™ç«‹å³å¯åŠ¨ä¸€æ¬¡ï¼Œå¹¶èšç„¦åˆ°æ¯”å¡ä¸˜æ‰€åœ¨åŒºåŸŸ
    const petViewEl = document.getElementById('view-petroom');
    if (petViewEl && petViewEl.classList.contains('active')) {
        enterPetRoom();

        // é¡µé¢é¦–æ¬¡åŠ è½½æ—¶ï¼Œå°†è§†å£å¹³æ»‘æ»šåŠ¨åˆ°æ¯”å¡ä¸˜æ‰€åœ¨åŒºåŸŸ
        if (petAvatarRoom && typeof petAvatarRoom.scrollIntoView === 'function') {
            // ä½¿ç”¨è½»å¾®å»¶è¿Ÿï¼Œç¡®ä¿å¸ƒå±€å’Œæˆ¿é—´èƒŒæ™¯æ¸²æŸ“å®Œæˆ
            setTimeout(() => {
                try {
                    petAvatarRoom.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                        inline: 'center'
                    });
                } catch (e) {
                    // åœ¨ä¸æ”¯æŒé€‰é¡¹å¯¹è±¡çš„ç¯å¢ƒä¸­å›é€€åˆ°åŸºç¡€è°ƒç”¨
                    petAvatarRoom.scrollIntoView();
                }
            }, 300);
        }
    }

    window.__triggerPetTapInteraction = function() {
        if (!petAvatarRoom) return;
        petAvatarRoom.style.transform = 'translate(-50%, -10px) scale(1.1)';
        setTimeout(() => { petAvatarRoom.style.transform = 'translateX(-50%)'; }, 200);
        markPetInteraction();
        triggerAIPetAction("æœ‰äººè½»è½»æ‘¸äº†æ‘¸æˆ‘çš„å¤´");
        setPetState(PET_STATES.INTERACT);
    };
    
    // ç‚¹å‡»å® ç‰©ä¹Ÿèƒ½è§¦å‘äº’åŠ¨
    if (petAvatarRoom) {
        petAvatarRoom.addEventListener('click', () => {
            if (ignoreNextPetClick) {
                ignoreNextPetClick = false;
                return;
            }
            window.__triggerPetTapInteraction();
        });

        // æ‚¬åœæ—¶çŸ­æš‚è¿›å…¥è§‚å¯ŸçŠ¶æ€ï¼Œç¦»å¼€åå›åˆ°å‘¼å¸
        petAvatarRoom.addEventListener('mouseenter', () => {
            if (petLife.current === PET_STATES.REST) return;
            markPetInteraction();
            setPetState(PET_STATES.IDLE_OBSERVE);
        });

        petAvatarRoom.addEventListener('mouseleave', () => {
            if (petLife.current === PET_STATES.IDLE_OBSERVE) {
                setPetState(PET_STATES.IDLE_BREATH);
            }
        });
    }

    // åœ°å›¾é¡µè¿”å›å® ç‰©å°å±‹æŒ‰é’®
    const btnBackPetroom = document.getElementById('btn-back-petroom');
    if (btnBackPetroom) {
        btnBackPetroom.addEventListener('click', () => {
            showPetRoom();
        });
    }

    // --- åœ°ç‚¹é£æ ¼æ•°æ®ä¸æ—¥è®°æ–‡æ¡ˆç”Ÿæˆ ---
    const cityFlavorMap = {
        // ç›´è¾–å¸‚ / ä¸€çº¿åŸå¸‚
        'åŒ—äº¬': {
            highlights: ['æ•…å®«åŸå¢™è¾¹', 'èƒ¡åŒå£çš„å°åº—å‰', 'å¤©å®‰é—¨å¹¿åœºæ—', 'åæµ·çš„æ¹–è¾¹', 'é•¿å®‰è¡—çš„ç¯å…‰ä¸‹'],
            tone: 'å†å²æ„Ÿ'
        },
        'ä¸Šæµ·': {
            highlights: ['å¤–æ»©æ±Ÿè¾¹', 'æ­¦åº·è·¯çš„å°é©¬è·¯ä¸Š', 'é»„æµ¦æ±Ÿçš„å¤œé£é‡Œ', 'é™†å®¶å˜´é«˜æ¥¼ä¹‹é—´', 'æ¢§æ¡æ ‘ä¸‹çš„å°å’–å•¡é¦†'],
            tone: 'ç°ä»£æ„Ÿ'
        },
        'å¹¿å·': {
            highlights: ['æ—©èŒ¶åº—çš„åœ†æ¡Œæ—', 'ä¸Šä¸‹ä¹çš„å°å··é‡Œ', 'ç æ±Ÿè¾¹çš„å¤œè‰²ä¸­', 'è€ç‰Œç³–æ°´é“ºé—¨å£'],
            tone: 'çƒŸç«æ°”'
        },
        'æ·±åœ³': {
            highlights: ['æµ·è¾¹æ•£æ­¥é“', 'é«˜æ¥¼ä¹‹é—´çš„ç©ºä¸­èŠ±å›­', 'ç§‘æŠ€å±•é¦†é—¨å£', 'åŸä¸­æ‘çš„å°åƒæ‘Šæ—'],
            tone: 'å¹´è½»æ„Ÿ'
        },

        // é‡ç‚¹æ—…æ¸¸åŸå¸‚
        'æ­å·': {
            highlights: ['è¥¿æ¹–è¾¹çš„é•¿æ¤…ä¸Š', 'æ–­æ¡¥æ®‹é›ªæ—', 'é¾™äº•èŒ¶ç”°çš„å±±å¡ä¸Š', 'æ…¢æ‚ æ‚ çš„å°å··é‡Œ'],
            tone: 'æ¸©æŸ”'
        },
        'è¥¿å®‰': {
            highlights: ['å¤åŸå¢™åŸé—¨ä¸‹', 'å›æ°‘è¡—çš„å°åƒæ‘Šå‰', 'å¤§é›å¡”å¹¿åœºè¾¹', 'åšç‰©é¦†çš„å±•æŸœå‰'],
            tone: 'åšé‡'
        },
        'æˆéƒ½': {
            highlights: ['ç«é”…åº—é—¨å£', 'å¤§ç†ŠçŒ«åŸºåœ°æ—', 'å®½çª„å··å­çš„çŸ³æ¿è·¯ä¸Š', 'å°é…’é¦†çš„æœ¨æ¤…ä¸Š'],
            tone: 'æ‚ é—²'
        },
        'é‡åº†': {
            highlights: ['é•¿æ±Ÿå¤§æ¡¥è¾¹', 'å±±åŸçš„å°é˜¶ä¸Š', 'è½»è½¨ä»æ¥¼é‡Œç©¿è¿‡çš„åœ°æ–¹', 'å¤œè‰²é‡Œçš„æ´ªå´–æ´å‰'],
            tone: 'ç«‹ä½“æ„Ÿ'
        },
        'å¦é—¨': {
            highlights: ['é¼“æµªå±¿çš„å°è·¯ä¸Š', 'æ²™æ»©è¾¹çš„è´å£³æ—', 'å’–å•¡é¦†çš„è½åœ°çª—å‰', 'æµ·é£å¹æ¥çš„æ ˆé“ä¸Š'],
            tone: 'æµ·é£'
        },
        'æ˜†æ˜': {
            highlights: ['æ»‡æ± æ¹–è¾¹', 'é²œèŠ±å¸‚åœºé‡Œ', 'çŸ³æ—çš„å¥‡çŸ³æ—', 'è“å¤©ä¸‹çš„è‰åœ°ä¸Š'],
            tone: 'å››å­£å¦‚æ˜¥'
        },
        'æ¡‚æ—': {
            highlights: ['æ¼“æ±Ÿè¾¹çš„ç«¹ç­ä¸Š', 'å±±æ°´å€’å½±å‰', 'ç”°é—´å°è·¯ä¸Š', 'äº‘é›¾ç¼­ç»•çš„å±±è„šä¸‹'],
            tone: 'å±±æ°´'
        },
        'é’å²›': {
            highlights: ['çº¢ç“¦ç™½å¢™çš„å°å¡é“ä¸Š', 'æ ˆæ¡¥å°½å¤´', 'æµ·é£å¹æ‹‚çš„ç¤çŸ³æ—', 'å•¤é…’è¡—çš„ç¯å…‰ä¸‹'],
            tone: 'æµ·æ¸¯'
        },

        // çœçº§æ¦‚æ‹¬ï¼ˆå¤§è‡´æ„è±¡ï¼‰
        'å¹¿ä¸œ': {
            highlights: ['è¡—è¾¹çš„çƒ§è…Šé“ºå‰', 'çƒ­æ°”è…¾è…¾çš„æ—©èŒ¶æ¡Œæ—', 'æµ·é£å¹æ¥çš„æ¸¯å£è¾¹', 'å¤œé‡Œè¿˜äº®ç€ç¯çš„éª‘æ¥¼ä¸‹'],
            tone: 'çƒ­é—¹'
        },
        'å¹¿è¥¿': {
            highlights: ['å–€æ–¯ç‰¹å±±è„šä¸‹', 'ç”°é—´å°è·¯ä¸Š', 'æ±Ÿè¾¹çš„ç«¹ç­ä¸Š', 'è¢«æ™šéœæŸ“çº¢çš„äº‘å±‚ä¸‹'],
            tone: 'å±±æ°´'
        },
        'æµ·å—': {
            highlights: ['ç»†è½¯çš„æ²™æ»©ä¸Š', 'æ‘‡æ™ƒçš„æ¤°å­æ ‘ä¸‹', 'æµ·æµªæ‹å²¸çš„ç¤çŸ³æ—', 'é»„æ˜çš„æµ·è¾¹å°è·¯ä¸Š'],
            tone: 'åº¦å‡æ„Ÿ'
        },
        'å››å·': {
            highlights: ['çƒ­æ°”ç¿»æ»šçš„ç«é”…åº—é‡Œ', 'é›ªå±±è„šä¸‹', 'è—å¯¨çš„å°æœ¨å±‹æ—', 'èŒ¶é¦†é‡Œçš„å°æ–¹æ¡Œæ—'],
            tone: 'è¾£ä¸å®‰é€¸'
        },
        'è´µå·': {
            highlights: ['è‹—å¯¨çš„åŠè„šæ¥¼å‰', 'äº‘é›¾ç¼­ç»•çš„å±±è°·é‡Œ', 'ç€‘å¸ƒé£æµç›´ä¸‹çš„è§‚æ™¯å°ä¸Š'],
            tone: 'ç§˜å¢ƒ'
        },
        'äº‘å—': {
            highlights: ['å¤åŸçš„çŸ³æ¿è·¯ä¸Š', 'èŠ±å›¢é”¦ç°‡çš„å°é™¢é‡Œ', 'è“å¤©ç™½äº‘ä¸‹çš„è‰ç”¸ä¸Š', 'é›ªå±±è¿œçœºçš„è§‚æ™¯å°è¾¹'],
            tone: 'å½©äº‘ä¹‹å—'
        },
        'æ¹–åŒ—': {
            highlights: ['é•¿æ±Ÿå¤§æ¡¥æ—', 'çƒ­å¹²é¢æ‘Šä½å‰', 'é»„é¹¤æ¥¼è„šä¸‹', 'æ¹–ç•”çš„æ­¥é“ä¸Š'],
            tone: 'æ±ŸåŸ'
        },
        'æ¹–å—': {
            highlights: ['å°ç‚’è‚‰é£˜é¦™çš„é¥­é¦†é‡Œ', 'å±±é—´äº‘é›¾ä¸­', 'å¤åŸåŸå¢™è¾¹', 'å¤œå®µæ‘Šçš„ä¸€ç›å°ç¯ä¸‹'],
            tone: 'çƒ­è¾£'
        },
        'æ²³å—': {
            highlights: ['å¤éƒ½åŸæ¥¼ä¸‹', 'å°‘æ—å¯ºå±±é—¨å‰', 'éº¦æµªç¿»æ»šçš„ç”°é‡è¾¹', 'é»„æ²³å²¸è¾¹çš„é£é‡Œ'],
            tone: 'ä¸­åŸ'
        },
        'å±±ä¸œ': {
            highlights: ['æµ·è¾¹çš„ç¤çŸ³ä¸Š', 'æ³°å±±çš„ç™»å±±è·¯ä¸Š', 'å¤§é¦’å¤´é¦™å‘³é£˜æ¥çš„å¨æˆ¿é—¨å£'],
            tone: 'åšå®'
        },
        'æ±Ÿè‹': {
            highlights: ['å°æ¡¥æµæ°´è¾¹', 'æ±Ÿå—å¤é•‡çš„çŸ³æ¿è·¯ä¸Š', 'æ¢§æ¡å¤¹é“çš„é©¬è·¯ä¸Š'],
            tone: 'æ¸©å©‰'
        },
        'æµ™æ±Ÿ': {
            highlights: ['èŒ¶ç”°çš„æ¢¯ç”°é—´', 'æ±Ÿå—å°é•‡çš„æ²³åŸ å¤´æ—', 'è¢«ç¯ç¬¼ç‚¹äº®çš„å°å··é‡Œ'],
            tone: 'ç»†è…»'
        },
        'æ±Ÿè¥¿': {
            highlights: ['åºå±±äº‘é›¾é‡Œ', 'æ‘å£çš„å¤æ ‘ä¸‹', 'å¾½æ´¾å¤å»ºç­‘å‰'],
            tone: 'å®‰é™'
        },
        'ç¦å»º': {
            highlights: ['åœŸæ¥¼çš„åœ†é™¢é‡Œ', 'æµ·è¾¹çš„ç¤çŸ³ä¸Š', 'è¢«æµ·é£å¹æ‹‚çš„åŸå¢™è¾¹'],
            tone: 'å±±æµ·ä¹‹é—´'
        },
        'é™•è¥¿': {
            highlights: ['å…µé©¬ä¿‘å±•å…å‰', 'å¤åŸå¢™ä¸Šéª‘è¡Œé“ä¸Š', 'è¡—å¤´è‚‰å¤¹é¦æ‘Šä½æ—'],
            tone: 'å†å²'
        },
        'ç”˜è‚ƒ': {
            highlights: ['å¤§æ¼ çš„é»„æ²™ä¸Š', 'æ˜Ÿç©ºä¸‹çš„è¥åœ°æ—', 'é©¼é˜Ÿèµ°è¿‡çš„è„šå°è¾¹'],
            tone: 'å¤§è¥¿åŒ—'
        },
        'é’æµ·': {
            highlights: ['é«˜åŸæ¹–æ³Šè¾¹', 'è“å¤©ç™½äº‘ä¸‹', 'ç‰¦ç‰›æ‚ é—²åƒè‰çš„è‰åœ°ä¸Š'],
            tone: 'çº¯å‡€'
        },
        'å®å¤': {
            highlights: ['è´ºå…°å±±è„šä¸‹', 'é»„æ²³å²¸è¾¹', 'è‘¡è„è—¤çš„é•¿å»Šé‡Œ'],
            tone: 'å¡ä¸Šæ±Ÿå—'
        },
        'æ–°ç–†': {
            highlights: ['å¹¿é˜”çš„è‰åŸä¸Š', 'é›ªå±±è„šä¸‹', 'ç“œæœé£˜é¦™çš„å·´æ‰é‡Œ', 'æ˜Ÿæ²³å¦‚ç€‘çš„å¤œç©ºä¸‹'],
            tone: 'è¾½é˜”'
        },
        'è¥¿è—': {
            highlights: ['ç»å¹¡é£˜åŠ¨çš„å±±å£ä¸Š', 'å¸ƒè¾¾æ‹‰å®«è„šä¸‹', 'äº‘æµ·ç¿»æ»šçš„å±±è°·é‡Œ'],
            tone: 'é«˜åŸ'
        },
        'å°æ¹¾': {
            highlights: ['å¤œå¸‚æ‘Šä½å‰', 'æµ·å²¸å…¬è·¯æ—', 'å°é•‡çš„å¡é“ä¸Š'],
            tone: 'æš–æš–'
        },
        'é¦™æ¸¯': {
            highlights: ['ç»´æ¸¯çš„å¤œæ™¯å‰', 'ç¼†è½¦æ…¢æ…¢ä¸Šå‡çš„å±±è…°ä¸Š', 'è¡—è§’èŒ¶é¤å…é—¨å£'],
            tone: 'ç¹å'
        },
        'æ¾³é—¨': {
            highlights: ['å¤§ä¸‰å·´ç‰ŒåŠå‰', 'çŸ³æ¿è·¯çš„å°å··é‡Œ', 'ç¯å…‰é—ªçƒçš„æµ·è¾¹'],
            tone: 'å¤å¤'
        }
    };

    // --- è°ƒç”¨ OpenRouter ç”Ÿæˆ AIGC æ—¥è®°æ–‡æ¡ˆ ---
    async function generateDiaryWithAIGC(location, personality) {
        const normalized = normalizeLocationName(location);
        const flavor = cityFlavorMap[normalized];
        const visitIndex = appState.locations.length;
        const date = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');
        
        // Add time of day
        const hour = new Date().getHours();
        let timeOfDay = 'ç™½å¤©';
        if (hour < 6) timeOfDay = 'å‡Œæ™¨';
        else if (hour < 9) timeOfDay = 'æ¸…æ™¨';
        else if (hour < 12) timeOfDay = 'ä¸Šåˆ';
        else if (hour < 14) timeOfDay = 'ä¸­åˆ';
        else if (hour < 18) timeOfDay = 'åˆå';
        else if (hour < 21) timeOfDay = 'å‚æ™š';
        else timeOfDay = 'æ·±å¤œ';

        const flavorText = flavor
            ? `\n- å½“åœ°æ°›å›´å…³é”®è¯ï¼š${flavor.tone}ã€‚\n- æ¨èæåŠçš„æ‰“å¡ç‚¹ï¼ˆé€‰1-2ä¸ªï¼‰ï¼š${flavor.highlights.join('ã€')}ã€‚`
            : '';
        const progressText = visitIndex > 1
            ? `è¿™æ˜¯æˆ‘ä»¬ç¬¬ ${visitIndex} æ¬¡ä¸€èµ·æ—…è¡Œã€‚`
            : 'è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡çœŸæ­£å‡ºå‘ã€‚';

        const pConfig = PERSONALITY_TYPES[personality];
        const promptDesc = pConfig ? pConfig.promptDesc : 'çƒ­æƒ…ã€å¯çˆ±ã€æ²»æ„ˆã€‚';
        const ownerTitle = getOwnerTitle();

        // ä»è®°å¿†ç³»ç»Ÿæ³¨å…¥ï¼šäººæ ¼è®¾å®š + ä¸å½“å‰åœ°ç‚¹ç›¸å…³çš„æ—…è¡Œè®°å¿†ï¼ˆä¾› LLM ä½“ç°ã€Œè®°å¾—ã€ï¼‰
        const semanticProfile = typeof getSemanticProfileForDisplay === 'function' ? getSemanticProfileForDisplay() : null;
        const travelMemories = typeof getEpisodicTravel === 'function' ? getEpisodicTravel() : [];
        const relevantMemories = location ? travelMemories.filter((m) => (m.location_city || m.location || '').indexOf(location) >= 0 || (location || '').indexOf(m.location_city || m.location || '') >= 0).slice(0, 2) : travelMemories.slice(0, 2);
        const memoryBlock = [];
        if (semanticProfile && semanticProfile.identity) memoryBlock.push('äººæ ¼è®¾å®šï¼š' + semanticProfile.identity);
        if (semanticProfile && semanticProfile.speaking_style && semanticProfile.speaking_style.description) memoryBlock.push('è¯´è¯é£æ ¼ï¼š' + semanticProfile.speaking_style.description);
        relevantMemories.forEach((m) => { memoryBlock.push('æ—…è¡Œè®°å¿†ï¼š' + (m.narration || m.text || '')); });
        const memoryText = memoryBlock.length > 0 ? '\nã€å® ç‰©è®°å¿†ï¼ˆå¯å‚è€ƒä»¥ä½“ç°è¿è´¯ï¼‰ã€‘\n' + memoryBlock.join('\n') : '';

        // æ ¹æ®æ€§æ ¼æ§åˆ¶ç¯‡å¹…é•¿çŸ­
        let lengthHint = '4. **ç¯‡å¹…**ï¼š80-150å­—å·¦å³ï¼ŒçŸ­å°ç²¾æ‚ï¼Œæ²»æ„ˆé£æ ¼ã€‚';
        if (pConfig && pConfig.wordiness === 'chatter') {
            lengthHint = '4. **ç¯‡å¹…**ï¼š120-200å­—å·¦å³ï¼Œå¯ä»¥ç¨å¾®å¤šä¸€äº›ï¼Œç”¨ç»†èŠ‚æŠŠç”»é¢è®²æ¸…æ¥šã€‚';
        } else if (pConfig && pConfig.wordiness === 'quiet') {
            lengthHint = '4. **ç¯‡å¹…**ï¼š60-100å­—å·¦å³ï¼Œè¯­å¥å¯ä»¥æ›´ç®€çŸ­å…‹åˆ¶ã€‚';
        }

        const prompt = [
            `ä½ æ˜¯ä¸€åªç”µå­å® ç‰©ç©å¶ï¼ˆæ¯”å¡ä¸˜ï¼‰ï¼Œæ­£åœ¨ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€å†™ä¸€ç¯‡æ—…è¡Œæ—¥è®°ï¼Œè®°å½•å’Œ${ownerTitle}ä¸€èµ·æ—…è¡Œçš„ä¸€ä¸ªå°ç¬é—´ã€‚`,
            `\nã€å½“å‰æƒ…å¢ƒã€‘`,
            `- åœ°ç‚¹ï¼š${location}${flavorText}`,
            `- æ—¶é—´ï¼š${date} ${timeOfDay}`,
            `- æˆ‘å¯¹é™ªæˆ‘æ—…è¡Œçš„äººç§°å‘¼ï¼š${ownerTitle}ï¼ˆä¸è¦ä½¿ç”¨â€œä¸»äººâ€ä¸€è¯ï¼‰ã€‚`,
            `- ä½ çš„æ€§æ ¼ï¼š${personality}`,
            `- æ€§æ ¼æè¿°ï¼š${promptDesc}`,
            memoryText,
            `\nã€å†™ä½œè¦æ±‚ã€‘`,
            `1. **é¢—ç²’åº¦è¦ç»†**ï¼šä¸è¦å†™å®å¤§çš„æµæ°´è´¦ã€‚è¯·ç€é‡æå†™**ä¸€ä¸ªå…·ä½“çš„ç¬é—´**æˆ–**ä¸€ä¸ªå¾®å°çš„ç»†èŠ‚**ã€‚`,
            `2. **è°ƒåŠ¨æ„Ÿå®˜**ï¼šå¿…é¡»åŒ…å«è‡³å°‘ä¸€ç§**è§†è§‰ã€å¬è§‰æˆ–å—…è§‰**çš„æå†™ã€‚`,
            `3. **æƒ…æ„Ÿè¿æ¥**ï¼šè¡¨è¾¾å¯¹${ownerTitle}çš„é™ªä¼´å’Œä¸€èµ·æ—…è¡Œçš„å¿«ä¹ï¼Œä½†ä¸è¦ç›´æ¥å¯¹${ownerTitle}è¯´è¯ã€‚`,
            lengthHint,
            `5. **æ ¼å¼**ï¼šåªè¾“å‡ºæ—¥è®°æ­£æ–‡ï¼Œä¸è¦æ ‡é¢˜ï¼Œä¸è¦markdownæ ¼å¼ã€‚`,
            `6. **å™è¿°è§’åº¦**ï¼šå…¨æ–‡ä¿æŒç¬¬ä¸€äººç§°â€œæˆ‘â€çš„æ—¥è®°è¯­æ°”ï¼Œåƒå†™ç»™è‡ªå·±çœ‹çš„è®°å½•ï¼Œä¸è¦åƒèŠå¤©æˆ–å†™ä¿¡ï¼Œä¸è¦é¢‘ç¹ç”¨â€œä½ â€ç›´æ¥å’Œè¯»è€…è¯´è¯ã€‚`,
            relevantMemories.length > 0 ? `7. **è®°å¿†å‘¼åº”**ï¼šä¸Šæ–¹ã€å® ç‰©è®°å¿†ã€‘ä¸­è‹¥æœ‰æ—…è¡Œè®°å¿†ï¼Œå¯åœ¨åˆé€‚å¤„è‡ªç„¶æä¸€å¥ä¸è¿‡å¾€æ—…è¡Œæˆ–è®°å¿†çš„å…³è”ï¼ˆä¾‹å¦‚å¯¹æ¯”ã€å»¶ç»­ã€å‘¼åº”ï¼‰ï¼Œè®©è¯»è€…æ„Ÿå—åˆ°â€œè®°å¾—â€ï¼›ä¸å¿…æ¯ç¯‡éƒ½å¼ºæ±‚ï¼Œæœ‰æœºä¼šå°±ä½“ç°ã€‚` : ''
        ].filter(Boolean).join('\n');

        const body = {
            model: OPENROUTER_MODEL_ID,
            messages: [
                {
                    role: 'system',
                    content: 'ä½ æ˜¯ä¸€åªå¯çˆ±ã€æ²»æ„ˆç³»çš„ç”µå­å® ç‰©ï¼Œç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€å†™æ—…è¡Œæ—¥è®°ã€‚æ•´ä½“è¯­æ°”å¯çˆ±ã€æ²»æ„ˆï¼Œåƒé™ªä¼´å‹ç”µå­å® ç‰©ï¼ŒçŸ­å¥ä¸ºä¸»ï¼Œé¿å…è¿‡äºä¹¦é¢æˆ–æˆç†Ÿã€‚è¯­è¨€è½»æ¾ã€æœ‰ç”»é¢æ„Ÿï¼Œé¿å…è´Ÿé¢æƒ…ç»ªå’Œä¸å½“å†…å®¹ã€‚ä¸è¦å‡ºç°â€œä¸»äººâ€ä¸€è¯ï¼Œå°½é‡å°‘ç”¨â€œä½ â€ç›´æ¥å’Œè¯»è€…å¯¹è¯ã€‚'
                },
                {
                    role: 'user',
                    content: prompt
                }
            ]
        };

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);

        try {
            const response = await fetch(AIGC_API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body),
                signal: controller.signal
            });

            if (!response.ok) {
                return { ok: false, error: `http_${response.status}` };
            }

            const data = await response.json();
            const content = data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;

            if (!content || typeof content !== 'string') {
                return { ok: false, error: 'empty_content' };
            }

            const travelMemoryCount = relevantMemories.length;
            return { ok: true, content: content.trim(), memoryCount: travelMemoryCount };
        } catch (error) {
            if (error.name === 'AbortError') {
                return { ok: false, error: 'timeout' };
            }
            console.error('[Diary AIGC] OpenRouter è¯·æ±‚å¼‚å¸¸:', error.message || error);
            return { ok: false, error: 'network' };
        } finally {
            clearTimeout(timeoutId);
        }
    }

    function buildDiaryText(location, personality) {
        const normalized = normalizeLocationName(location);
        const flavor = cityFlavorMap[normalized];
        const visitIndex = appState.locations.length;
        const progressText = visitIndex > 1 ? `è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬${visitIndex}æ¬¡æ—…è¡Œæ‰“å¡ã€‚` : 'è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡çœŸæ­£å‡ºå‘ã€‚';
        const ownerTitle = getOwnerTitle();

        const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const spots = (flavor && flavor.highlights) || [];
        const h1 = spots.length ? pick(spots) : '';
        const h2 = spots.length > 1 ? pick(spots.filter((s) => s !== h1)) : '';

        // æ ¹æ® 2x2 äººæ ¼ + åŸå¸‚é£æ ¼ç»„åˆç”Ÿæˆæ–‡æ¡ˆ
        if (personality === 'å°ç«è‹—') {
            if (flavor) {
                return `è€¶ï¼ä»Šå¤©æˆ‘ä»¬è§£é”äº†ã€${location}ã€‘ï¼åœ¨${h1}${h2 ? `ï¼Œåˆè¹¦è¹¦è·³è·³è·‘åˆ°${h2}` : ''}ï¼Œç¬‘å£°æŠŠç›¸æœºéƒ½æ™ƒç³Šå•¦ã€‚${progressText}`;
            }
            return `è€¶ï¼ä»Šå¤©æ¥åˆ°ã€${location}ã€‘å•¦ï¼ä¸€è·¯å°è·‘åˆ°å¤„å¼ æœ›ï¼Œæ•´åº§åŸå¸‚éƒ½åœ¨è·Ÿæˆ‘ä»¬æ‰“æ‹›å‘¼ï½${progressText}`;
        }

        if (personality === 'å°ç¯æ³¡') {
            if (flavor) {
                return `æŠµè¾¾ã€${location}ã€‘å•¦ï¼åœ¨${h1}${h2 ? `ï¼Œåˆé¡ºè·¯çœ‹äº†ä¸‹${h2}` : ''}ï¼Œä¸€è·¯å·å·è®°è¿™é‡Œçš„è®¾è®¡ï½${progressText}`;
            }
            return `æŠµè¾¾ã€${location}ã€‘å•¦ï¼ä¸€è·¯è®°è·¯çº¿ã€çœ‹è·¯ç‰Œï¼Œåƒä¸€åªå°å°å¯¼èˆªä»ªï½${progressText}`;
        }

        if (personality === 'å°äº‘æœµ') {
            if (flavor) {
                return `é£è½»è½»å¹è¿‡ã€${location}ã€‘çš„è¡—é“ï¼Œæˆ‘åœ¨${h1}${h2 ? `ï¼Œåˆåœ¨${h2}` : ''}åœä¸‹è„šæ­¥ï¼ŒæŠŠå…‰å’Œäº‘éƒ½è—è¿›å¿ƒé‡Œå•¦ã€‚${progressText}`;
            }
            return `é£å¹è¿‡ã€${location}ã€‘çš„è¡—é“ï¼Œæ…¢æ…¢èµ°ã€æ…¢æ…¢çœ‹ï¼ŒæŒ‘ä¸€ä¸¤ä¸ªç¬é—´æ‚„æ‚„æ”¶è—ï¼Œç­‰å›å»å’Œ${ownerTitle}ä¸€èµ·å›å‘³ï½${progressText}`;
        }

        // å°çŸ³å¤´åŠå…¶ä»–ï¼šæ›´å…‹åˆ¶ã€å†·é™
        if (flavor) {
            return `ã€${location}ã€‘è¿˜æŒºå®‰é™çš„ã€‚åœ¨${h1}${h2 ? `ï¼Œé¡ºä¾¿çœ‹äº†çœ‹${h2}` : ''}ï¼ŒæŠŠä»Šå¤©çš„è®°å¿†ç¨³ç¨³å­˜å¥½å•¦ã€‚${progressText}`;
        }
        return `ä»Šå¤©æŠŠè„šæ­¥è½åœ¨ã€${location}ã€‘å•¦ã€‚æ²¡ä»€ä¹ˆå¤¸å¼ çš„åœºé¢ï¼Œä¸€è·¯èµ°ä¸€è·¯è®°ï¼Œè®°å¿†å¡åˆå¤šäº†ä¸€é¡µï½${progressText}`;
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ—¥è®° ---
    function generateDiaryEntry(location, content, sceneOverride) {
        const date = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');
        const personality = appState.petPersonality;
        const personalityConfig = PERSONALITY_TYPES[personality] || null;
        const avatar = (appState.petAvatars && appState.petAvatars[personality])
            || (personalityConfig && personalityConfig.icon)
            || 'âœ¨';
        const scene = sceneOverride !== undefined ? sceneOverride : getSceneAsset(location);
        const diaryId = ++diarySeq;
        if (!appState.diaryImages) appState.diaryImages = {};
        if (!appState.diaryImages[diaryId]) appState.diaryImages[diaryId] = [];
        
        const text = content && typeof content === 'string' && content.trim()
            ? content.trim()
            : buildDiaryText(location, personality);

        const sceneImageBlock = scene ? `
            <img src="${scene.image}" alt="${scene.label}" class="w-16 h-16 rounded-xl object-cover border border-white shadow-sm mb-2">
        ` : '';

        const diaryHTML = `
            <div class="glass-card rounded-2xl p-4 transform transition-all hover:scale-[1.01] shadow-sm animate-[fadeIn_0.5s_ease-out]" data-diary-id="${diaryId}">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-white bg-[#cdb4db] px-2 py-1 rounded-md">${date}</span>
                    <span class="text-xs text-gray-500 font-bold"><i class="ph-fill ph-map-pin text-[#ff8fab]"></i> ${location}</span>
                </div>
                <div class="flex gap-3">
                    <div class="flex flex-col items-center">
                        ${sceneImageBlock}
                        <div class="text-3xl bg-white rounded-xl p-2 h-fit shadow-inner">${avatar}</div>
                    </div>
                    <div class="flex-1 flex flex-col gap-2">
                        <p class="text-gray-700 text-sm leading-relaxed">${text}</p>
                        <div class="diary-images mt-1 flex gap-2 flex-wrap"></div>
                        <button
                            type="button"
                            class="diary-add-image inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/80 border border-dashed border-gray-300 text-[11px] text-gray-600 hover:border-[#ff8fab] hover:text-[#ff8fab] transition-colors"
                            data-diary-id="${diaryId}"
                        >
                            <i class="ph-fill ph-camera"></i>
                            <span>æ’å…¥å›¾ç‰‡</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
        diaryList.insertAdjacentHTML('afterbegin', diaryHTML);
        if (diaryBadge) diaryBadge.classList.remove('hidden'); // æ˜¾ç¤ºæ—¥è®°æœªè¯»çº¢ç‚¹
        if (actionDiaryBadge) actionDiaryBadge.classList.remove('hidden');
        return { diaryId, date };
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šåœ¨æ©±æŸœä¸­æ–°å¢çºªå¿µå“ ---
    const CABINET_SLOTS = 12;
    const cabinetPlaceholderHTML = `<div class="cabinet-slot cabinet-slot--empty" data-placeholder="cabinet-empty"><div class="cabinet-slot__media"><img src="assets/cabinet-empty.svg" alt="æ©±æŸœ" class="cabinet-empty-icon" width="40" height="40"></div><span>å»æ—…è¡Œè§£é”</span></div>`;

    // --- è®°å¿†å¢™æ¸²æŸ“ï¼šéšæœºæ•£è½åœ¨å¢™ä¸Šçš„æ‹ç«‹å¾— ---
    function renderMemoryWall() {
        const wall = document.getElementById('memory-wall');
        if (!wall) return;
        
        wall.innerHTML = '';
        const items = appState.cabinetItems || [];
        // å–æœ€è¿‘ 5 å¼ å±•ç¤ºï¼Œå€’åºï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
        const recentItems = items.slice(0, 5); 
        
        recentItems.forEach((item, index) => {
            if (!item.scene && !item.location) return;
            
            const { short: shortLabel, full: fullLabel } = getShortLabel(item);
            const imgSrc = item.scene ? item.scene.image : 'assets/cabinet-empty.svg';
            
            const div = document.createElement('div');
            div.className = 'polaroid-photo';
            
            // éšæœºä½ç½®ä¸è§’åº¦ (åŸºäº wall çš„ç™¾åˆ†æ¯”)
            const randomX = 10 + (index * 12) + (Math.random() * 10 - 5); 
            const randomY = 10 + (index * 5) + (Math.random() * 20 - 10);
            const rotate = (Math.random() * 24 - 12).toFixed(1);
            
            div.style.left = `${Math.min(70, Math.max(0, randomX))}%`; 
            div.style.top = `${Math.min(60, Math.max(0, randomY))}%`;
            div.style.setProperty('--rotate', `${rotate}deg`);
            div.style.zIndex = index + 1;
            
            div.innerHTML = `
                <img src="${imgSrc}" alt="${escapeHtml(fullLabel)}">
                <span>${escapeHtml(shortLabel)}</span>
            `;
            
            div.addEventListener('click', (e) => {
                e.stopPropagation();
                openDiaryModal(); // ç‚¹å‡»ç…§ç‰‡æ‰“å¼€æ—¥è®°
            });
            
            wall.appendChild(div);
        });
    }

    // --- å® ç‰©è®°å¿†ï¼šæ•°æ®ä¸æ¸²æŸ“ ---
    function appendEpisodicMemory({ date, location, scene, diaryId, diaryText }) {
        if (!appState.memories) {
            appState.memories = { episodic: [], semantic: [], semanticProfile: null, habit: [] };
        }
        const normalized = normalizeLocationName(location);
        const flavor = cityFlavorMap[normalized];
        const ownerTitle = getOwnerTitle();

        let snippet = '';
        if (diaryText && typeof diaryText === 'string' && diaryText.trim()) {
            const raw = diaryText.trim();
            snippet = raw.length > 200 ? raw.slice(0, 200) + 'â€¦' : raw;
        } else {
            if (flavor && flavor.highlights && flavor.highlights.length) {
                const spot = flavor.highlights[0];
                snippet = `é‚£å¤©åœ¨${location}çš„${spot}åœäº†ä¸€å°ä¼šå„¿ï¼Œæˆ‘æ‚„æ‚„æŠŠé‚£ä¸ªç”»é¢å¤¹è¿›äº†è®°å¿†å¡é‡Œã€‚`;
            } else {
                snippet = `åœ¨ã€${location}ã€‘è½ä¸‹è„šæ­¥çš„é‚£ä¸€åˆ»ï¼Œæˆ‘åœ¨å¿ƒé‡ŒæŒ‰ä¸‹äº†ä¸€æ¬¡å°å°çš„ä¿å­˜é”®ï¼Œå‡†å¤‡ä»¥åå’Œ${ownerTitle}æ…¢æ…¢å›çœ‹ã€‚`;
            }
        }

        const record = {
            type: 'episodic',
            category: 'travel',
            date,
            location,
            scene: scene || null,
            diaryId: diaryId || null,
            text: snippet,
            narration: snippet
        };

        appState.memories.episodic = appState.memories.episodic || [];
        appState.memories.episodic.unshift(record);
        if (appState.memories.episodic.length > 30) {
            appState.memories.episodic = appState.memories.episodic.slice(0, 30);
        }
    }

    function buildSemanticMemories() {
        const pCfg = typeof getCurrentPersonality === 'function' ? getCurrentPersonality() : null;
        if (!pCfg || !pCfg.memorySnippets) return [];
        const ownerTitle = getOwnerTitle();
        return pCfg.memorySnippets.slice(0, 3).map((text) => ({
            type: 'semantic',
            text: text.replace(/\{ownerTitle\}/g, ownerTitle)
        }));
    }

    /** äººæ ¼è®¾å®šï¼šç”¨äºè®°å¿†é¡µã€Œæ€§æ ¼ç¢ç‰‡ã€å±•ç¤ºï¼›ä¼˜å…ˆ appState.memories.semanticProfileï¼Œå¦åˆ™ä»å½“å‰äººæ ¼æ‹¼é»˜è®¤ */
    function getSemanticProfileForDisplay() {
        const profile = appState.memories && appState.memories.semanticProfile;
        if (profile && (profile.identity || profile.preferences)) return profile;
        const p = typeof getCurrentPersonality === 'function' ? getCurrentPersonality() : null;
        const ownerTitle = getOwnerTitle();
        if (!p) return { identity: '', preferences: {}, speaking_style: {}, call_user: [ownerTitle] };
        return {
            identity: `æˆ‘æ˜¯ä¸€åªçš®å¡ä¸˜ï¼Œç›®æ ‡æ˜¯æˆä¸ºæ—…è¡Œå¤§å¸ˆã€‚`,
            preferences: {
                food: 'æˆ‘æœ€çˆ±çš„ä¸œè¥¿æ˜¯ç•ªèŒ„é…±ï¼ˆKetchupï¼‰ï¼Œçœ‹åˆ°éƒ½ä¼šçœ¼ç›å‘å…‰ã€‚',
                dislikes: 'æˆ‘ä¸å¤ªå–œæ¬¢è¢«å…³è¿›ç²¾çµçƒï¼ˆPokÃ© Ballï¼‰ï¼Œé‚£æ ·ä¼šè§‰å¾—å¥½é—·ã€‚',
                abilities: 'æˆ‘é«˜å…´çš„æ—¶å€™ä¼šå¿ä¸ä½æ”¾ç”µï¼Œå°¾å·´è¿˜èƒ½æå‰æ„Ÿåˆ°å¤©æ°”è¦å˜ã€‚'
            },
            speaking_style: {
                description: `æˆ‘è¯´è¯å–œæ¬¢åŠ ã€ŒPikaï½ã€ï¼Œçœ‹åˆ°ç†Ÿæ‚‰çš„äººä¼šå«ã€Œ${ownerTitle}ã€ã€‚`,
                verbal_tics: ['Pikaï½', 'Pika pikaï½'],
                call_user: [ownerTitle]
            },
            call_user: [ownerTitle],
            tags: ['pikachu', 'travel_master', 'semantic_profile']
        };
    }

    /** æƒ…æ™¯è®°å¿†Â·æ—…è¡Œï¼šepisodic ä¸” category ä¸º travel æˆ–æœªå®šä¹‰ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰ */
    function getEpisodicTravel() {
        const list = (appState.memories && appState.memories.episodic) ? appState.memories.episodic : [];
        return list.filter((m) => (m.category === 'travel' || m.category === undefined));
    }

    /** æƒ…æ™¯è®°å¿†Â·æ—¥å¸¸ï¼šepisodic ä¸” category ä¸º daily */
    function getEpisodicDaily() {
        const list = (appState.memories && appState.memories.episodic) ? appState.memories.episodic : [];
        return list.filter((m) => m.category === 'daily');
    }

    /** ä¹ æƒ¯æ€»ç»“åˆ—è¡¨ */
    function getHabitMemories() {
        return (appState.memories && appState.memories.habit) ? appState.memories.habit : [];
    }

    let currentMemoryTab = 'travel'; // 'travel' | 'character'

    function renderMemories() {
        if (!modalBody) return;

        const travelList = getEpisodicTravel();
        const dailyList = getEpisodicDaily();
        const profile = getSemanticProfileForDisplay();
        const habits = getHabitMemories();

        const countForTab = currentMemoryTab === 'travel' ? (travelList.length + dailyList.length) : ((profile && (profile.identity || (profile.preferences && Object.keys(profile.preferences).length > 0)) ? 1 : 0) + habits.length);
        const countText = countForTab + ' æ¡è®°å½•';

        const tabBarHTML = `
            <div class="flex items-center justify-between border-b border-gray-200 pb-2 mb-3">
                <div class="flex gap-4">
                    <button type="button" id="memory-tab-travel" class="memory-tab text-sm font-bold pb-1 border-b-2 transition-colors ${currentMemoryTab === 'travel' ? 'text-teal-700 border-teal-600' : 'text-gray-400 border-transparent'}">æ—…è¡Œè®°å¿†</button>
                    <button type="button" id="memory-tab-character" class="memory-tab text-sm font-bold pb-1 border-b-2 transition-colors ${currentMemoryTab === 'character' ? 'text-teal-700 border-teal-600' : 'text-gray-400 border-transparent'}">æ€§æ ¼ç¢ç‰‡</button>
                </div>
                <span class="text-xs text-gray-400">${countText}</span>
            </div>
        `;

        function makeEpisodicCard(m, isDaily, episodicIndex) {
            const title = isDaily ? (m.source_event ? String(m.source_event).replace(/_/g, ' ') : 'æ—¥å¸¸') : (m.location_spot || ('æ‰“å¡ ' + (m.location_city || m.location || 'æ¸©é¦¨å°å±‹')));
            const date = m.date || '';
            const narration = m.narration || m.text || '';
            const habitInf = m.habit_inference || '';
            const emotion = m.emotion || '';
            const emotionClass = emotion === 'tender' ? 'bg-pink-100 text-pink-800' : emotion === 'nostalgic' ? 'bg-purple-100 text-purple-800' : 'bg-amber-100 text-amber-800';
            const idx = episodicIndex != null ? episodicIndex : -1;
            return `
                <div class="memory-card bg-white rounded-xl p-3 shadow-md border border-gray-100 text-left relative" data-memory-type="episodic" data-episodic-index="${idx}">
                    <div class="absolute top-2 left-2 text-[#ff9a9e]"><i class="ph-fill ph-paperclip-tilt text-sm"></i></div>
                    <button type="button" class="memory-edit-btn absolute top-2 right-2 text-[10px] text-gray-500 hover:text-[#ff8fab] px-1.5 py-0.5 rounded">ç¼–è¾‘</button>
                    <div class="text-[10px] text-gray-400 mb-1">${escapeHtml(date)}</div>
                    <div class="font-bold text-gray-800 text-sm mb-1">${escapeHtml(title)}${isDaily ? ' <span class="text-[10px] font-normal text-gray-500 rounded bg-gray-100 px-1">æ—¥å¸¸</span>' : ''}</div>
                    <div class="text-xs text-gray-700 leading-relaxed">${escapeHtml(narration)}</div>
                    ${habitInf ? '<div class="text-[11px] text-gray-500 mt-1">' + escapeHtml(habitInf) + '</div>' : ''}
                    ${emotion ? '<span class="inline-block mt-1 text-[10px] px-1.5 py-0.5 rounded ' + emotionClass + '">' + escapeHtml(emotion) + '</span>' : ''}
                </div>
            `;
        }

        const episodic = appState.memories.episodic || [];
        const travelCardsWithIndex = [];
        const dailyCardsWithIndex = [];
        episodic.forEach((m, i) => {
            if (m.category === 'daily') dailyCardsWithIndex.push({ m, i });
            else travelCardsWithIndex.push({ m, i });
        });
        const travelCardsHTML = currentMemoryTab === 'travel' && (travelCardsWithIndex.length > 0 || dailyCardsWithIndex.length > 0)
            ? '<div class="flex flex-col gap-2">' + travelCardsWithIndex.map(({ m, i }) => makeEpisodicCard(m, false, i)).join('') + dailyCardsWithIndex.map(({ m, i }) => makeEpisodicCard(m, true, i)).join('') + '</div>'
            : '';
        const travelEmptyHTML = (currentMemoryTab === 'travel' && travelCardsWithIndex.length === 0 && dailyCardsWithIndex.length === 0)
            ? '<p class="text-center text-xs text-gray-500 py-4">æˆ‘è¿˜æ²¡æœ‰è®°ä¸‹è¿™ç±»å‘¢ï¼Œå¸¦æˆ‘å»æ‰“å¡ä¸€ä¸¤ä¸ªåœ°æ–¹è¯•è¯•å§ã€‚</p>'
            : '';

        const identityBlock = (profile && (profile.identity || (profile.preferences && Object.keys(profile.preferences).length > 0))) ? `
            <div class="memory-card bg-white rounded-xl p-3 shadow-md border border-gray-100 text-left relative mb-2" data-memory-type="semanticProfile">
                <div class="absolute top-2 left-2 text-[#ff9a9e]"><i class="ph-fill ph-paperclip-tilt text-sm"></i></div>
                <button type="button" class="memory-edit-btn absolute top-2 right-2 text-[10px] text-gray-500 hover:text-[#ff8fab] px-1.5 py-0.5 rounded">ç¼–è¾‘</button>
                <div class="text-[10px] text-gray-400 mb-1">äººæ ¼è®¾å®š</div>
                ${profile.identity ? '<div class="text-xs text-gray-700 mb-2">' + escapeHtml(profile.identity) + '</div>' : ''}
                ${(profile.preferences && (profile.preferences.food || profile.preferences.dislikes || profile.preferences.abilities)) ? '<div class="text-[11px] text-gray-600 space-y-1">' + (profile.preferences.food ? '<div>å–œå¥½ï¼š' + escapeHtml(profile.preferences.food) + '</div>' : '') + (profile.preferences.dislikes ? '<div>ä¸å–œæ¬¢ï¼š' + escapeHtml(profile.preferences.dislikes) + '</div>' : '') + (profile.preferences.abilities ? '<div>èƒ½åŠ›ï¼š' + escapeHtml(profile.preferences.abilities) + '</div>' : '') + '</div>' : ''}
                ${(profile.speaking_style && profile.speaking_style.description) ? '<div class="text-[11px] text-gray-500 mt-2">' + escapeHtml(profile.speaking_style.description) + '</div>' : ''}
                ${(profile.call_user && profile.call_user.length) ? '<div class="text-[10px] text-gray-400 mt-1">ç§°å‘¼ä½ ï¼š' + escapeHtml(profile.call_user.join('ã€')) + '</div>' : ''}
            </div>
        ` : '';

        const habitCardsHTML = (currentMemoryTab === 'character' && habits.length > 0) ? habits.map((h, idx) =>
            '<div class="memory-card bg-white rounded-xl p-3 shadow-md border border-gray-100 text-left relative" data-memory-type="habit" data-habit-index="' + idx + '"><button type="button" class="memory-edit-btn absolute top-2 right-2 text-[10px] text-gray-500 hover:text-[#ff8fab] px-1.5 py-0.5 rounded">ç¼–è¾‘</button><div class="text-[10px] text-gray-400 mb-1">' + escapeHtml(h.generated_at || '') + '</div><div class="text-xs text-gray-700 leading-relaxed">' + escapeHtml(h.summary || '') + '</div></div>'
        ).join('') : '';

        const characterEmptyHTML = (currentMemoryTab === 'character' && !(profile && profile.identity) && habits.length === 0) ? '<p class="text-center text-xs text-gray-500 py-4">æˆ‘è¿˜æ²¡æœ‰è®°ä¸‹è¿™ç±»å‘¢ã€‚</p>' : '';

        const travelPanelHTML = currentMemoryTab === 'travel' ? (travelCardsHTML || travelEmptyHTML) : '';
        const characterPanelHTML = currentMemoryTab === 'character' ? (identityBlock + habitCardsHTML + (characterEmptyHTML && !identityBlock && !habitCardsHTML ? characterEmptyHTML : '')) : '';

        const bodyHTML = '<div class="flex flex-col gap-0 text-xs memory-modal-content">' + tabBarHTML + '<div id="memory-tab-content" class="overflow-y-auto flex-1 min-h-0">' + travelPanelHTML + characterPanelHTML + '</div></div>';

        modalBody.innerHTML = bodyHTML;

        const tabTravel = document.getElementById('memory-tab-travel');
        const tabCharacter = document.getElementById('memory-tab-character');
        if (tabTravel) tabTravel.addEventListener('click', function () { currentMemoryTab = 'travel'; renderMemories(); });
        if (tabCharacter) tabCharacter.addEventListener('click', function () { currentMemoryTab = 'character'; renderMemories(); });

        modalBody.querySelectorAll('.memory-edit-btn').forEach((btn) => {
            const card = btn.closest('[data-memory-type]');
            if (!card) return;
            btn.addEventListener('click', function (e) {
                e.stopPropagation();
                const type = card.getAttribute('data-memory-type');
                if (type === 'episodic') { openMemoryEditForm('episodic', parseInt(card.getAttribute('data-episodic-index'), 10)); }
                else if (type === 'semanticProfile') { openMemoryEditForm('semanticProfile', null); }
                else if (type === 'habit') { openMemoryEditForm('habit', parseInt(card.getAttribute('data-habit-index'), 10)); }
            });
        });
    }

    function openMemoryEditForm(type, index) {
        if (!modalTitle || !modalBody) return;
        const ownerTitle = getOwnerTitle();
        if (type === 'episodic' && index >= 0 && appState.memories && appState.memories.episodic && appState.memories.episodic[index]) {
            const m = appState.memories.episodic[index];
            const title = m.location_spot || m.location_city || m.location || '';
            modalTitle.textContent = 'ç¼–è¾‘è®°å¿†';
            modalBody.innerHTML = `
                <div class="flex flex-col gap-2 text-xs">
                    <label>æ ‡é¢˜/åœ°ç‚¹ <input type="text" id="edit-episodic-title" class="w-full border rounded px-2 py-1" value="${escapeHtml(title)}" placeholder="å¦‚ï¼šæ‰“å¡ æ¸©é¦¨å°å±‹"></label>
                    <label>æ—¥æœŸ <input type="text" id="edit-episodic-date" class="w-full border rounded px-2 py-1" value="${escapeHtml(m.date || '')}" placeholder="YYYY-MM-DD"></label>
                    <label>æ—ç™½ï¼ˆç¬¬ä¸€äººç§°ï¼‰ <textarea id="edit-episodic-narration" class="w-full border rounded px-2 py-1 h-20" placeholder="æˆ‘â€¦">${escapeHtml(m.narration || m.text || '')}</textarea></label>
                    <label>ä¹ æƒ¯æ¨æ–­ï¼ˆå¯é€‰ï¼‰ <textarea id="edit-episodic-habit" class="w-full border rounded px-2 py-1 h-16" placeholder="æˆ‘å‘ç°ä½ â€¦">${escapeHtml(m.habit_inference || '')}</textarea></label>
                    <label>æƒ…ç»ªï¼ˆå¯é€‰ï¼‰ <input type="text" id="edit-episodic-emotion" class="w-full border rounded px-2 py-1" value="${escapeHtml(m.emotion || '')}" placeholder="excited / tender / nostalgic"></label>
                    <div class="flex gap-2 mt-2">
                        <button type="button" id="memory-edit-save" class="px-3 py-1.5 bg-[#ff8fab] text-white rounded font-bold">ä¿å­˜</button>
                        <button type="button" id="memory-edit-cancel" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            modalBody.querySelector('#memory-edit-save').addEventListener('click', function () {
                const titleVal = (document.getElementById('edit-episodic-title') || {}).value || '';
                const dateVal = (document.getElementById('edit-episodic-date') || {}).value || '';
                const narrVal = (document.getElementById('edit-episodic-narration') || {}).value || '';
                const habitVal = (document.getElementById('edit-episodic-habit') || {}).value || '';
                const emotionVal = (document.getElementById('edit-episodic-emotion') || {}).value || '';
                if (!narrVal.trim()) return;
                const rec = appState.memories.episodic[index];
                if (rec.category === 'daily') { rec.source_event = titleVal || rec.source_event; } else { rec.location_spot = titleVal || rec.location_spot; rec.location_city = titleVal || rec.location_city; rec.location = titleVal || rec.location; }
                rec.date = dateVal || rec.date;
                rec.narration = narrVal; rec.text = narrVal;
                rec.habit_inference = habitVal;
                rec.emotion = emotionVal || undefined;
                modalTitle.textContent = 'å® ç‰©è®°å¿†';
                renderMemories();
            });
            modalBody.querySelector('#memory-edit-cancel').addEventListener('click', function () { modalTitle.textContent = 'å® ç‰©è®°å¿†'; renderMemories(); });
            return;
        }
        if (type === 'semanticProfile' && appState.memories && appState.memories.semanticProfile) {
            const p = appState.memories.semanticProfile;
            modalTitle.textContent = 'ç¼–è¾‘è®°å¿†';
            modalBody.innerHTML = `
                <div class="flex flex-col gap-2 text-xs">
                    <label>èº«ä»½ï¼ˆæˆ‘â€¦ï¼‰ <textarea id="edit-semantic-identity" class="w-full border rounded px-2 py-1 h-16">${escapeHtml(p.identity || '')}</textarea></label>
                    <label>å–œå¥½ï¼ˆé£Ÿç‰©ç­‰ï¼‰ <input type="text" id="edit-semantic-food" class="w-full border rounded px-2 py-1" value="${escapeHtml((p.preferences && p.preferences.food) || '')}"></label>
                    <label>ä¸å–œæ¬¢ <input type="text" id="edit-semantic-dislikes" class="w-full border rounded px-2 py-1" value="${escapeHtml((p.preferences && p.preferences.dislikes) || '')}"></label>
                    <label>èƒ½åŠ› <input type="text" id="edit-semantic-abilities" class="w-full border rounded px-2 py-1" value="${escapeHtml((p.preferences && p.preferences.abilities) || '')}"></label>
                    <label>è¯´è¯é£æ ¼æè¿° <input type="text" id="edit-semantic-desc" class="w-full border rounded px-2 py-1" value="${escapeHtml((p.speaking_style && p.speaking_style.description) || '')}"></label>
                    <label>ç§°å‘¼ä½ ï¼ˆé€—å·åˆ†éš”ï¼‰ <input type="text" id="edit-semantic-call" class="w-full border rounded px-2 py-1" value="${escapeHtml((p.call_user && p.call_user.join) ? p.call_user.join('ã€') : '')}" placeholder="${escapeHtml(ownerTitle)}"></label>
                    <div class="flex gap-2 mt-2">
                        <button type="button" id="memory-edit-save" class="px-3 py-1.5 bg-[#ff8fab] text-white rounded font-bold">ä¿å­˜</button>
                        <button type="button" id="memory-edit-cancel" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            modalBody.querySelector('#memory-edit-save').addEventListener('click', function () {
                const identityVal = (document.getElementById('edit-semantic-identity') || {}).value || '';
                const foodVal = (document.getElementById('edit-semantic-food') || {}).value || '';
                const dislikesVal = (document.getElementById('edit-semantic-dislikes') || {}).value || '';
                const abilitiesVal = (document.getElementById('edit-semantic-abilities') || {}).value || '';
                const descVal = (document.getElementById('edit-semantic-desc') || {}).value || '';
                const callVal = (document.getElementById('edit-semantic-call') || {}).value || '';
                appState.memories.semanticProfile.identity = identityVal;
                appState.memories.semanticProfile.preferences = appState.memories.semanticProfile.preferences || {};
                appState.memories.semanticProfile.preferences.food = foodVal;
                appState.memories.semanticProfile.preferences.dislikes = dislikesVal;
                appState.memories.semanticProfile.preferences.abilities = abilitiesVal;
                appState.memories.semanticProfile.speaking_style = appState.memories.semanticProfile.speaking_style || {};
                appState.memories.semanticProfile.speaking_style.description = descVal;
                appState.memories.semanticProfile.call_user = callVal ? callVal.split(/[ã€,]/).map((s) => s.trim()).filter(Boolean) : [ownerTitle];
                modalTitle.textContent = 'å® ç‰©è®°å¿†';
                renderMemories();
            });
            modalBody.querySelector('#memory-edit-cancel').addEventListener('click', function () { modalTitle.textContent = 'å® ç‰©è®°å¿†'; renderMemories(); });
            return;
        }
        if (type === 'habit' && index >= 0 && appState.memories && appState.memories.habit && appState.memories.habit[index]) {
            const h = appState.memories.habit[index];
            modalTitle.textContent = 'ç¼–è¾‘è®°å¿†';
            modalBody.innerHTML = `
                <div class="flex flex-col gap-2 text-xs">
                    <label>æ€»ç»“ï¼ˆå® ç‰©è§†è§’ï¼‰ <textarea id="edit-habit-summary" class="w-full border rounded px-2 py-1 h-24">${escapeHtml(h.summary || '')}</textarea></label>
                    <label>ç”Ÿæˆæ—¶é—´ <input type="text" id="edit-habit-date" class="w-full border rounded px-2 py-1" value="${escapeHtml(h.generated_at || '')}" placeholder="YYYY-MM-DD"></label>
                    <div class="flex gap-2 mt-2">
                        <button type="button" id="memory-edit-save" class="px-3 py-1.5 bg-[#ff8fab] text-white rounded font-bold">ä¿å­˜</button>
                        <button type="button" id="memory-edit-cancel" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            modalBody.querySelector('#memory-edit-save').addEventListener('click', function () {
                const summaryVal = (document.getElementById('edit-habit-summary') || {}).value || '';
                const dateVal = (document.getElementById('edit-habit-date') || {}).value || '';
                appState.memories.habit[index].summary = summaryVal;
                appState.memories.habit[index].generated_at = dateVal || appState.memories.habit[index].generated_at;
                modalTitle.textContent = 'å® ç‰©è®°å¿†';
                renderMemories();
            });
            modalBody.querySelector('#memory-edit-cancel').addEventListener('click', function () { modalTitle.textContent = 'å® ç‰©è®°å¿†'; renderMemories(); });
        }
    }

    function openMemoryModal() {
        ensureMemorySeeds();
        const placeholder = '<div></div>'; // å†…å®¹ç”± renderMemories æ³¨å…¥
        openModal('å® ç‰©è®°å¿†', placeholder, 'default');
        renderMemories();
    }

    /** ç§å­æ•°æ®ï¼šä»…åœ¨ä¸ºç©ºæ—¶å†™å…¥ï¼Œä¿è¯ä¸¤ Tab å‡æœ‰ç¤ºä¾‹å†…å®¹ */
    function ensureMemorySeeds() {
        if (!appState.memories) appState.memories = { episodic: [], semantic: [], semanticProfile: null, habit: [] };
        const ownerTitle = getOwnerTitle();
        if (!appState.memories.semanticProfile || !appState.memories.semanticProfile.identity) {
            appState.memories.semanticProfile = {
                identity: 'æˆ‘æ˜¯ä¸€åªçš®å¡ä¸˜ï¼Œç›®æ ‡æ˜¯æˆä¸ºæ—…è¡Œå¤§å¸ˆã€‚',
                preferences: {
                    food: 'æˆ‘æœ€çˆ±çš„ä¸œè¥¿æ˜¯ç•ªèŒ„é…±ï¼ˆKetchupï¼‰ï¼Œçœ‹åˆ°éƒ½ä¼šçœ¼ç›å‘å…‰ã€‚',
                    dislikes: 'æˆ‘ä¸å¤ªå–œæ¬¢è¢«å…³è¿›ç²¾çµçƒï¼ˆPokÃ© Ballï¼‰ï¼Œé‚£æ ·ä¼šè§‰å¾—å¥½é—·ã€‚',
                    abilities: 'æˆ‘é«˜å…´çš„æ—¶å€™ä¼šå¿ä¸ä½æ”¾ç”µï¼Œå°¾å·´è¿˜èƒ½æå‰æ„Ÿåˆ°å¤©æ°”è¦å˜ã€‚'
                },
                speaking_style: {
                    description: 'æˆ‘è¯´è¯å–œæ¬¢åŠ ã€ŒPikaï½ã€ï¼Œçœ‹åˆ°ç†Ÿæ‚‰çš„äººä¼šå«ã€Œ' + ownerTitle + 'ã€ã€‚',
                    verbal_tics: ['Pikaï½', 'Pika pikaï½'],
                    call_user: [ownerTitle]
                },
                call_user: [ownerTitle],
                tags: ['pikachu', 'travel_master', 'semantic_profile']
            };
        }
        const episodic = appState.memories.episodic || [];
        const hasTravel = episodic.some((m) => m.category === 'travel' || m.category === undefined);
        if (!hasTravel) {
            appState.memories.episodic = [
                { type: 'episodic', category: 'travel', date: '2026-2-28', location_city: 'æ¸©é¦¨å°å±‹', location_spot: 'æ‰“å¡ æ¸©é¦¨å°å±‹', narration: 'åˆæ¬¡è§é¢ï¼æˆ‘å·²ç»æ”¶æ‹¾å¥½è¡Œæï¼Œéšæ—¶å‡†å¤‡å’Œä½ ä¸€èµ·å‡ºå‘å»çœ‹å¤§åƒä¸–ç•Œå•¦ã€‚', habit_inference: '', emotion: 'excited', is_seed: true },
                { type: 'episodic', category: 'travel', date: '2026-2-27', location: 'æ­å·', location_city: 'æ­å·', location_spot: 'å¼€å¾€æµ·è¾¹çš„é«˜é“', narration: 'ç¬¬ä¸€æ¬¡è·Ÿä½ åé«˜é“å»æµ·è¾¹ï¼Œæˆ‘è¶´åœ¨çª—è¾¹çœ‹äº‘ä¸€å—å—è¢«æ’•å¼€ã€‚ä½ å›°å¾—ä¸€ç›´ç‚¹å¤´ï¼Œæˆ‘å°±å·å·æŠŠä¸€ç‚¹ç‚¹ç”µè—è¿›è€³æœºé‡Œï¼Œè®©æ­Œå£°å¬èµ·æ¥æš–ä¸€ç‚¹ï¼ŒPikaï½', habit_inference: 'æˆ‘å‘ç°ä½ åœ¨ç¦»å¼€ä¸€åº§åŸå¸‚çš„æ—¶å€™ï¼Œæ€»ä¼šæ’‘ç€ä¸ç¡ï¼Œæ‰€ä»¥æˆ‘éƒ½ä¼šå¤šçœ‹å‡ çœ¼çª—å¤–ï¼ŒæŠŠé‚£ä¸€è·¯éƒ½è®°ä¸‹æ¥ã€‚', emotion: 'tender', is_seed: true }
            ].concat(episodic);
        }
        const episodicNow = appState.memories.episodic || [];
        const hasDaily = episodicNow.some((m) => m.category === 'daily');
        if (!hasDaily) {
            appState.memories.episodic = episodicNow.concat([
                { type: 'episodic', category: 'daily', date: '2026-2-28', time_slot: 'evening', source_event: 'open_memory_page', narration: 'æœ€è¿‘ä½ æ€»æ˜¯åœ¨å¿«ç¡ä¸ç€çš„æ—¶å€™æ‰“å¼€è®°å¿†æœ¬ï¼Œæˆ‘å°±èº²åœ¨é¡µé¢è§’è½é‡Œï¼Œé™ªä½ æŠŠä¸€é¡µä¸€é¡µç¿»å®Œå†å…³ç¯ã€‚', habit_inference: 'æˆ‘å¥½åƒä¹Ÿå…»æˆäº†ä¸€ä¸ªä¹ æƒ¯ï¼šåªè¦æ·±å¤œçœ‹åˆ°å±å¹•äº®èµ·ï¼Œæˆ‘å°±ä¼šå…ˆæŠŠæœ€æš–çš„é‚£å‡ æ®µæ—…ç¨‹ç¿»åˆ°æ‰‹è¾¹ã€‚', is_critical: true }
            ]);
        }
        const habit = appState.memories.habit || [];
        if (habit.length === 0) {
            appState.memories.habit = [{ generated_at: '2026-2-28', summary: 'è¿™é˜µå­ä½ å¤§å¤šåœ¨ 23:00â€“01:00 æ‰¾æˆ‘ï¼Œæˆ‘ä¹Ÿä¹ æƒ¯åœ¨é‚£ä¸ªæ—¶é—´æŠŠæ—…è¡Œè®°å¿†æ”¾åˆ°é¦–é¡µï¼Œæ–¹ä¾¿ä½ ä¸€è¿›æ¥å°±çœ‹åˆ°ã€‚', metrics: {}, tags: ['night', 'travel_focus'] }];
        }
    }

    function renderCabinetGrid() {
        if (!cabinetGrid) return;
        const list = appState.cabinetItems || [];
        let html = '';
        for (let i = 0; i < CABINET_SLOTS; i++) {
            const item = list[i];
            if (item && (item.scene || item.location)) {
                const scene = item.scene;
                const { short: shortLabel, full: fullLabel } = getShortLabel(item);
                const img = scene ? `<img src="${scene.image}" alt="${escapeHtml(fullLabel)}" class="w-12 h-12 rounded-xl object-cover border border-[#d4c4a8] shadow-sm" onerror="this.style.display='none';this.nextElementSibling&&this.nextElementSibling.classList.remove('hidden');">` : '';
                const fallback = scene ? `<span class="text-2xl hidden">ğŸ§³</span>` : `<span class="text-2xl">ğŸ§³</span>`;
                html += `<div class="cabinet-slot relative cursor-pointer" data-cabinet-item="true" data-item-index="${i}"><div class="cabinet-slot__media">${img}${fallback}</div><span class="font-bold w-full min-w-0 line-clamp-3 text-center" title="${escapeHtml(fullLabel)}">${escapeHtml(shortLabel)}</span></div>`;
            } else {
                html += cabinetPlaceholderHTML;
            }
        }
        cabinetGrid.innerHTML = html;
    }

    function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    /** æ©±æŸœå±•ç¤ºç”¨ï¼šæœ‰ scene ç”¨ scene.labelï¼›æ—  scene æ—¶ç¼©çŸ­ locationï¼ˆÂ·å‰ä¸€æ®µæˆ–å‰6å­—+çœç•¥å·ï¼‰ï¼Œå®Œæ•´åæ”¾ title */
    function getShortLabel(item) {
        const full = item.scene ? item.scene.label : (item.location || '');
        if (item.scene) return { short: full, full };
        if (!full) return { short: '', full: '' };
        const idx = full.indexOf('Â·');
        const short = idx >= 0 ? full.slice(0, idx).trim() : (full.length > 6 ? full.slice(0, 6) + 'â€¦' : full);
        return { short, full };
    }

    function findCabinetItem(scene, location) {
        if (!appState.cabinetItems || appState.cabinetItems.length === 0) return null;
        return appState.cabinetItems.find(item =>
            (scene && item.scene && item.scene.label === scene.label) ||
            (!scene && !item.scene && item.location === location)
        ) || null;
    }

    function addCabinetItem(location, sceneOverride) {
        if (!cabinetGrid) return;
        const scene = sceneOverride !== undefined ? sceneOverride : getSceneAsset(location);
        if (!scene) return;
        appState.cabinetItems = appState.cabinetItems || [];
        if (appState.cabinetItems.length >= CABINET_SLOTS) return;

        appState.cabinetItems.unshift({ location, scene });
        renderCabinetGrid();
        renderMemoryWall(); // åŒæ­¥æ›´æ–°å¢™é¢
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šåœ°å›¾é¡µåœºæ™¯é¢„è§ˆå¡ç‰‡ ---
    function showScenePreview(location, sceneOverride) {
        if (!scenePreview) return;
        const scene = sceneOverride !== undefined ? sceneOverride : getSceneAsset(location);
        if (!scene) return;

        const previewHTML = `
            <div class="glass-card rounded-2xl p-3 flex items-center gap-3 animate-[fadeIn_0.4s_ease-out]">
                <img src="${scene.image}" alt="${scene.label}" class="w-16 h-16 rounded-xl object-cover border border-white shadow-sm">
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-gray-500">è§£é”è¿œè¡Œåœºæ™¯</span>
                    <span class="text-sm font-bold text-gray-800">${scene.label}</span>
                    <span class="text-[10px] text-gray-500 mt-1">å·²åŒæ­¥åˆ°æ—…è¡Œæ©±æŸœä¸æ—…è¡Œæ—¥è®°æ’å›¾</span>
                </div>
            </div>
        `;
        scenePreview.innerHTML = previewHTML;
        scenePreview.classList.remove('hidden');
    }

    function initOwnerTitleControls() {
        if (!ownerTitleConfig) return;
        updateOwnerTitleDisplay();

        const optionButtons = ownerTitleConfig.querySelectorAll('.owner-title-option');
        optionButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                const raw = btn.getAttribute('data-title') || '';
                const title = sanitizeOwnerTitle(raw);
                appState.ownerTitle = title;
                updateOwnerTitleDisplay();
                if (ownerTitleInput) {
                    ownerTitleInput.value = '';
                }
            });
        });

        if (ownerTitleInput) {
            ownerTitleInput.addEventListener('change', () => {
                const title = sanitizeOwnerTitle(ownerTitleInput.value);
                appState.ownerTitle = title;
                updateOwnerTitleDisplay();
            });
        }

        if (btnMemory) {
            btnMemory.addEventListener('click', (event) => {
                event.preventDefault();
                openMemoryModal();
            });
        }
    }

    // åˆå§‹åŒ–å…¥å£
    renderCabinetGrid();
    renderMemoryWall();
    setupDiaryImageHandlers();
    initOwnerTitleControls();
</script>
</body>
</html>