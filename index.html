<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPä¼´æ¸¸å® ç‰© - MVP (å‡çº§ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
        
        body {
            background-color: #f0f4f8; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }

        #app-container {
            width: 100%;
            max-width: 414px; 
            height: 100vh;
            max-height: 896px;
            background-color: #fffaf0; 
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        @media (min-width: 420px) {
            #app-container {
                height: 850px;
                border-radius: 40px;
                border: 8px solid #333;
            }
        }

        .cute-font { font-family: 'ZCOOL KuaiLe', cursive; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 2px solid white;
            box-shadow: 0 8px 16px rgba(0,0,0,0.05);
        }

        .cabinet-modal {
            background: linear-gradient(135deg, #e8dcc8 0%, #dfd0b8 50%, #e5d9c4 100%);
            color: #5c4a3a;
        }
        .cabinet-modal .text-gray-800,
        .cabinet-modal .text-gray-500 { color: #5c4a3a; }
        .cabinet-modal .text-gray-400 { color: #6b5b4f; }
        .cabinet-shelf {
            background: rgba(212, 196, 168, 0.35);
            border: 1px solid #c4a882;
            border-radius: 1rem;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.06);
            padding: 0.5rem;
        }
        .cabinet-slot {
            background: #f0e9df;
            border: 1px solid #d4c4a8;
            border-radius: 1rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
            color: #5c4a3a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 72px;
            padding: 0.5rem;
            font-size: 11px;
        }
        .cabinet-slot--empty { color: #6b5b4f; font-size: 12px; }
        .cabinet-empty-icon {
            width: 2.5rem;
            height: 2.5rem;
            margin-bottom: 0.25rem;
            opacity: 0.85;
            color: #6b5b4f;
        }
        .cabinet-slot img { border-color: #d4c4a8; }

        /* å¯¼èˆªåˆ‡æ¢åŠ¨ç”» */
        .nav-item { transition: all 0.3s ease; }
        .nav-item.active {
            color: #ff8fab;
            transform: translateY(-4px) scale(1.1);
        }

        /* è§†å›¾åˆ‡æ¢åŠ¨ç”» */
        .page-view {
            display: none;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            visibility: hidden;
            pointer-events: none;
        }
        .page-view.active {
            display: flex;
            flex-direction: column;
            visibility: visible;
            pointer-events: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* åœ°å›¾å›¾é’‰æ‰è½åŠ¨ç”» */
        @keyframes dropPin {
            0% { transform: translateY(-30px) scale(2); opacity: 0; }
            70% { transform: translateY(5px) scale(0.9); opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        .pin-drop { animation: dropPin 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* åœ°å›¾å®¹å™¨ï¼šåŒ—â€”å—æ¸å˜åº•è‰²åŒºåˆ† */
        #china-map-container {
            background: linear-gradient(to bottom,
                #e8f4fc 0%,
                #f0f9ff 35%,
                #f5fcf9 70%,
                #fefce8 100%);
        }

        /* åœ°å›¾çœä»½çƒ­ç‚¹ï¼šåŠ¨æ¼«é£å¯ç‚¹å‡»åŒºåŸŸï¼Œé»˜è®¤ä¸æ˜¾ç¤ºé¿å…åƒå¸¸é©»å›¾é’‰ */
        .map-hotspot {
            position: absolute;
            width: 8%;
            height: 8%;
            min-width: 24px;
            min-height: 24px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            cursor: pointer;
            background: transparent;
            opacity: 0;
            transition: background 0.2s ease, transform 0.2s ease, opacity 0.2s ease;
        }
        .map-hotspot:hover,
        .map-hotspot:focus {
            opacity: 1;
            background: rgba(255, 143, 171, 0.4);
            transform: translate(-50%, -50%) scale(1.15);
        }
        .map-hotspot:active {
            transform: translate(-50%, -50%) scale(0.98);
        }

        /* å® ç‰©åœ¨æˆ¿é—´çš„è½»å¾®å‘¼å¸åŠ¨ç”» */
        @keyframes breathe {
            0%, 100% { transform: translate(-50%, 0) scale(1); }
            50% { transform: translate(-50%, -4px) scale(1.02); }
        }
        .pet-breathe { animation: breathe 3s ease-in-out infinite; }
        
        /* å® ç‰©ä¸åŒçŠ¶æ€çš„èº«ä½“åŠ¨æ•ˆï¼ˆä½œç”¨äºå›¾ç‰‡æœ¬èº«ï¼‰ */
        @keyframes petIdleMotion {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-3px) scale(1.02); }
        }
        .pet-anim-idle {
            animation: petIdleMotion 1.4s ease-in-out infinite;
        }

        @keyframes petExcitedMotion {
            0%, 100% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-8px) scale(1.1) rotate(-4deg); }
            50% { transform: translateY(-4px) scale(1.04) rotate(3deg); }
            75% { transform: translateY(-10px) scale(1.08) rotate(-2deg); }
        }
        .pet-anim-excited {
            animation: petExcitedMotion 0.7s ease-out infinite;
            transform-origin: center bottom;
        }

        @keyframes petSleepMotion {
            0%, 100% { transform: translateY(4px) scale(0.94) rotate(-8deg); opacity: 0.9; }
            50% { transform: translateY(6px) scale(0.94) rotate(-10deg); opacity: 0.8; }
        }
        .pet-anim-sleep {
            animation: petSleepMotion 1.6s ease-in-out infinite;
            transform-origin: center bottom;
        }

        @keyframes petEatMotion {
            0%, 100% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-4px) scale(1.02); }
            50% { transform: translateY(1px) scale(0.98); }
            75% { transform: translateY(-3px) scale(1.04); }
        }
        .pet-anim-eat {
            animation: petEatMotion 0.8s ease-in-out infinite;
            transform-origin: center bottom;
        }

        @keyframes petDoorMotion {
            0% { transform: translateX(0) scale(1); }
            30% { transform: translateX(6px) scale(1.02); }
            60% { transform: translateX(10px) scale(1.05); }
            100% { transform: translateX(14px) scale(1.05); }
        }
        .pet-anim-door {
            animation: petDoorMotion 0.6s ease-out forwards;
            transform-origin: center bottom;
        }

        @keyframes petPlantMotion {
            0%, 100% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-3px) scale(1.03); }
            50% { transform: translateY(-6px) scale(1.06); }
            75% { transform: translateY(-3px) scale(1.03); }
        }
        .pet-anim-plant {
            animation: petPlantMotion 1.2s ease-in-out infinite;
        }
        
        /* æ°”æ³¡æµ®åŠ¨åŠ¨ç”» */
        @keyframes bubbleFloat {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-50%, -6px); }
        }
        .bubble-float { animation: bubbleFloat 4s ease-in-out infinite; }

        /* å® ç‰©ç§»åŠ¨ä¸æˆ¿é—´çƒ­ç‚¹æ ·å¼ */
        .pet-can-move {
            transition: bottom 0.4s ease, left 0.4s ease, transform 0.4s ease;
        }

        .room-hotspot {
            position: absolute;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            font-weight: 700;
            color: #374151;
        }

        .room-hotspot-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 6px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.85);
            border: 1.5px solid #ffffff;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(8px);
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        .room-hotspot-button span:first-child {
            font-size: 1.25rem;
            margin-bottom: 2px;
        }

        .room-hotspot-button:hover,
        .room-hotspot-button:active {
            transform: translateY(-2px) scale(1.06);
            box-shadow: 0 10px 18px rgba(0, 0, 0, 0.12);
        }

        @keyframes hotspotWiggle {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-2px) rotate(-6deg); }
            50% { transform: translateY(0) rotate(4deg); }
            75% { transform: translateY(-1px) rotate(-3deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        .room-hotspot-wiggle {
            animation: hotspotWiggle 0.4s ease-out;
        }

        /* å¯äº¤äº’çƒ­ç‚¹é«˜äº®ï¼ˆåºŠã€æ©±æŸœã€æ—¥è®°ï¼‰- æ˜æ˜¾å¯ç‚¹å‡» */
        .room-hotspot-highlight .room-hotspot-button {
            box-shadow: 0 0 0 3px rgba(255, 182, 167, 0.95), 0 0 16px rgba(255, 143, 171, 0.6), 0 4px 12px rgba(0,0,0,0.12);
        }
        .room-hotspot-highlight .room-hotspot-button:hover,
        .room-hotspot-highlight .room-hotspot-button:active {
            box-shadow: 0 0 0 3px rgba(255, 182, 167, 1), 0 0 24px rgba(255, 143, 171, 0.8), 0 6px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px) scale(1.06);
            animation-play-state: paused;
        }
        /* çƒ­ç‚¹è½»å¾®å‘¼å¸é«˜äº®ï¼Œæç¤ºå¯ç‚¹å‡» */
        @keyframes hotspotGlow {
            0%, 100% { box-shadow: 0 0 0 3px rgba(255, 182, 167, 0.9), 0 0 14px rgba(255, 143, 171, 0.5); }
            50% { box-shadow: 0 0 0 3px rgba(255, 182, 167, 1), 0 0 20px rgba(255, 143, 171, 0.7); }
        }
        .room-hotspot-highlight .room-hotspot-button {
            animation: hotspotGlow 2.5s ease-in-out infinite;
        }

        /* çš®å¡ä¸˜åˆ°è¾¾ç›®æ ‡æ—¶çš„è·³è·ƒåŠ¨æ•ˆ */
        @keyframes petJumpLand {
            0% { transform: translateX(-50%) translateY(0) scale(1); }
            40% { transform: translateX(-50%) translateY(-18px) scale(1.08); }
            70% { transform: translateX(-50%) translateY(-4px) scale(1.02); }
            100% { transform: translateX(-50%) translateY(0) scale(1); }
        }
        .pet-anim-jump {
            animation: petJumpLand 0.45s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* æ€§æ ¼èƒ¶å›Šï¼šæœªé€‰ä¸­ / é€‰ä¸­ */
        .personality-pill {
            background: rgba(255, 255, 255, 0.8);
            border: 1.5px solid #e5e7eb;
            color: #6b7280;
        }
        .personality-pill:hover {
            border-color: #ffb5a7;
            color: #374151;
        }
        .personality-pill.active {
            background: rgba(255, 143, 171, 0.35);
            border-color: #ff8fab;
            color: #be185d;
        }

        /* æ°”æ³¡å°å°¾å·´ä¸æ°”æ³¡åŒæ­¥æ˜¾éš */
        .bubble-tail { pointer-events: none; }

        /* å® ç‰©é¡µå…¥åœºï¼šæˆ¿é—´å¡ç‰‡ä¸å® ç‰©è½»å¾®åŠ¨ç”» */
        .page-view#view-petroom.entrance .room-viewport-entrance {
            animation: roomEntrance 0.4s ease-out forwards;
        }
        .page-view#view-petroom.entrance #pet-avatar-room {
            animation: petEntrance 0.35s ease-out forwards;
        }
        @keyframes roomEntrance {
            from { opacity: 0.85; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes petEntrance {
            from { opacity: 0; transform: translate(-50%, 0) scale(0.92); }
            to { opacity: 1; transform: translate(-50%, 0) scale(1); }
        }

        /* å® ç‰© Tab å…¨é¡µåº•å›¾é“ºæ»¡ */
        #room-scene {
            /* ç§»é™¤èƒŒæ™¯å›¾æ ·å¼ï¼Œæ”¹ç”¨ img æ ‡ç­¾ */
        }
        #view-petroom .petroom-top-bar {
            background: linear-gradient(to bottom, rgba(255,248,235,0.92) 0%, rgba(255,248,235,0.75) 100%);
            backdrop-filter: blur(8px);
        }
        #view-petroom .petroom-bottom-hint {
            background: linear-gradient(to top, rgba(255,248,235,0.9), transparent);
        }
    </style>
</head>
<body>

<div id="app-container">
    <!-- å†…å®¹æ§½ï¼šä¸¤ä¸ª Tab å…±ç”¨åŒä¸€é«˜åº¦ï¼Œäº’ä¸æŒ¤å‹ -->
    <div id="main-content-slot" class="flex-1 min-h-0 flex flex-col overflow-hidden">
    <!-- ===== è§†å›¾ 1ï¼šé¦–é¡µåœ°å›¾ (Tab 1) ===== -->
    <div id="view-home" class="page-view active bg-[#fffaf0] p-6 h-full min-h-0 overflow-hidden">
        <header class="text-center mb-4 pt-4 flex-shrink-0">
            <h1 class="text-2xl cute-font text-gray-800 flex justify-center items-center gap-2">
                <i class="ph-fill ph-compass text-[#a2d2ff]"></i> æ—…è¡Œè¶³è¿¹
            </h1>
        </header>

        <!-- åŠ¨æ¼«é£æ ¼å¯äº¤äº’ä¸­å›½åœ°å›¾ï¼ˆä½¿ç”¨ Wikimedia å…¬æœ‰é¢†åŸŸ SVGï¼‰ -->
        <div id="china-map-container" class="relative w-full flex-1 min-h-[200px] rounded-[40px] border-[6px] border-[#e0f7fa] shadow-[0_8px_32px_rgba(162,210,255,0.35)] overflow-hidden mb-4 flex items-center justify-center transition-all duration-300 hover:shadow-[0_12px_40px_rgba(162,210,255,0.4)]">
            
            <!-- ç°æˆä¸­å›½çœä»½åœ°å›¾ï¼ˆç½‘ä¸Š SVGï¼Œå…¬æœ‰é¢†åŸŸï¼‰ -->
            <img src="https://upload.wikimedia.org/wikipedia/commons/f/fe/China_blank_province_map.svg" alt="ä¸­å›½åœ°å›¾" id="china-map-img" class="absolute w-full h-full object-contain p-3 z-10 opacity-95"
                 onerror="this.style.display='none'; document.getElementById('map-fallback').style.display='flex';">
            
            <!-- åœ¨çº¿é¢„è§ˆæ—¶çš„ä¼˜é›…å ä½ç¬¦ï¼ˆå½“å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰ -->
            <div id="map-fallback" class="absolute inset-0 flex flex-col items-center justify-center bg-[#f8fdfd] text-[#4a7c59] z-0" style="display: none;">
                <i class="ph-fill ph-image text-5xl mb-2 text-[#a2d2ff] opacity-70"></i>
                <span class="font-bold text-sm">åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</span>
                <span class="text-xs mt-1 text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm mt-2">ä½¿ç”¨ assets/map/china-kawaii-map.png ä½œä¸ºæœ¬åœ°å¤‡ç”¨</span>
            </div>
            
            <!-- å¯ç‚¹å‡»çœä»½çƒ­ç‚¹å±‚ï¼ˆç‚¹å‡»å³å¡«å…¥åœ°ç‚¹å¹¶æ‰“å¡ï¼‰ -->
            <div id="map-hotspots" class="absolute inset-0 z-15"></div>
            
            <!-- åŠ¨æ€æ‰“å¡å›¾é’‰å®¹å™¨ -->
            <div id="map-pins-container" class="absolute inset-0 z-20 pointer-events-none">
                <!-- æ‰“å¡åå›¾é’‰ä¼šåŠ¨æ€æ’å…¥æ­¤å¤„ -->
            </div>
        </div>

        <!-- ç‰¹æ®Šç›®çš„åœ°åœºæ™¯é¢„è§ˆï¼ˆä¾‹å¦‚ï¼šåŸƒåŠé‡‘å­—å¡”ï¼‰ -->
        <div id="scene-preview" class="mt-2 hidden flex-shrink-0">
            <!-- ç”± JS åœ¨æ‰“å¡ç‰¹å®šåœ°ç‚¹åå¡«å……å¡ç‰‡å†…å®¹ -->
        </div>

        <!-- æ‰“å¡æ§åˆ¶é¢æ¿ -->
        <div class="glass-card rounded-3xl p-5 min-w-0 overflow-hidden flex-shrink-0">
            <h3 class="text-gray-700 font-bold mb-3 flex items-center gap-2 text-sm">
                <i class="ph-fill ph-map-pin text-[#ff8fab]"></i> è®°å½•æ–°æ—…ç¨‹
            </h3>
            <div class="flex gap-2 min-w-0">
                <input type="text" id="location-input" placeholder="è¾“å…¥åœ°ç‚¹ï¼Œå¦‚ï¼šæ­¦æ±‰" class="flex-1 min-w-0 bg-white border-2 border-transparent focus:border-[#ff8fab] rounded-2xl px-4 py-3 outline-none shadow-sm text-gray-700 transition-all">
                <button id="btn-checkin" class="flex-shrink-0 bg-[#ff8fab] hover:bg-[#ff7b9c] text-white font-bold rounded-2xl px-4 py-3 transition-colors shadow-md whitespace-nowrap text-sm">
                    å»æ‰“å¡
                </button>
            </div>
        </div>
    </div>

    <!-- ===== è§†å›¾ 2ï¼šå® ç‰©é¡µï¼ˆå® ç‰©ä¹‹å®¶ + æ©±æŸœ + æ—¥è®°ï¼‰ ===== -->
    <div id="view-petroom" class="page-view relative p-0 h-full min-h-0 overflow-hidden">
        <!-- é¡¶éƒ¨æ ï¼šæ ‡é¢˜ + çŠ¶æ€ + æ€§æ ¼ï¼ŒåŠé€æ˜ä¾¿äºåº•å›¾é€å‡º -->
        <div class="petroom-top-bar absolute top-0 left-0 w-full z-10 pointer-events-none px-4 pt-4 pb-2 flex-shrink-0">
            <header class="text-center">
                <h1 class="text-2xl cute-font text-gray-800 flex justify-center items-center gap-2">
                    <i class="ph-fill ph-house text-[#ffb5a7]"></i> å® ç‰©å°å±‹
                </h1>
            </header>
            <div id="pet-status-bar" class="mt-1 mb-2 text-center text-xs font-bold text-gray-600">
                æ¯”å¡ä¸˜æ­£åœ¨å‡†å¤‡å‡ºå‘ä¸­â€¦
            </div>
            <div id="personality-pills" class="flex justify-center gap-2 pointer-events-auto">
                <button type="button" class="personality-pill px-4 py-2 rounded-full text-xs font-bold transition-all duration-200" data-value="æ´»æ³¼">æ´»æ³¼</button>
                <button type="button" class="personality-pill px-4 py-2 rounded-full text-xs font-bold transition-all duration-200" data-value="è´ªåƒ">è´ªåƒ</button>
                <button type="button" class="personality-pill px-4 py-2 rounded-full text-xs font-bold transition-all duration-200" data-value="æ–‡è‰º">æ–‡è‰º</button>
            </div>
        </div>
        <select id="pet-personality" class="hidden" aria-hidden="true">
            <option value="æ´»æ³¼" selected>æ´»æ³¼</option>
            <option value="è´ªåƒ">è´ªåƒ</option>
            <option value="æ–‡è‰º">æ–‡è‰º</option>
        </select>

        <!-- æˆ¿é—´åŒºåŸŸï¼šé“ºæ»¡å‰©ä½™ç©ºé—´ï¼Œåº•å›¾ç”± view-petroom èƒŒæ™¯æä¾› -->
        <div id="room-viewport" class="absolute inset-0 w-full h-full overflow-hidden flex items-center justify-center touch-none room-viewport-entrance z-0">
            <div id="room-scene" class="absolute top-0 left-0 h-full w-auto flex justify-center items-center" style="transform-origin: 0 0;">
                <!-- æˆ¿é—´èƒŒæ™¯å›¾ï¼šé«˜åº¦è‡ªé€‚åº”ï¼Œå®½åº¦å…è®¸è¶…å‡º -->
                <img src="img_v3_02v9_e5e8fa0c-9998-4db2-954f-3108a59180bg.png" alt="æˆ¿é—´èƒŒæ™¯" class="h-full w-auto max-w-none block select-none pointer-events-none object-cover">

                <!-- å® ç‰©ä¸»ä½“ -->
                <div id="pet-avatar-room" class="absolute bottom-[25%] left-[50%] drop-shadow-2xl z-40 pet-breathe pet-can-move cursor-pointer pointer-events-auto" style="transform: translateX(-50%);">
                    <img id="pet-avatar-sprite" src="æ¯”å¡ä¸˜åŠ¨ç”»å¯¼å‡º/è§‚å¯Ÿ/flog_guancha_002.png" alt="æ—…è¡Œå® ç‰©" class="w-24 h-24 object-contain pointer-events-none select-none">
                </div>
                
                <!-- äº’åŠ¨æ°”æ³¡ -->
                <div id="pet-action-bubble" class="absolute bottom-[48%] left-[50%] bubble-float bg-white/95 backdrop-blur-sm px-4 py-2 rounded-2xl shadow-xl text-sm font-bold text-gray-700 whitespace-nowrap z-50 border-2 border-[#ff8fab] transition-all duration-300 pointer-events-none opacity-0" style="transform: translateX(-50%);">
                    æ­£åœ¨æœŸå¾…æ—…è¡Œ... âœ¨
                </div>
                <div class="absolute bottom-[46%] left-[50%] w-3 h-3 bg-white border-r-2 border-b-2 border-[#ff8fab] z-40 pointer-events-none bubble-tail opacity-0 transition-opacity duration-300" style="transform: translateX(-50%) rotate(45deg);"></div>

                <!-- å¯ç‚¹å‡»çƒ­ç‚¹ï¼šä¹¦æ¡Œæ—¥è®°ã€æ©±æŸœã€åºŠï¼ˆé«˜äº®æ˜¾ç¤ºï¼‰ -->
                <div id="room-hotspots-layer" class="absolute inset-0 z-30 pointer-events-none">
                    <button type="button" id="hotspot-bed" class="room-hotspot room-hotspot-highlight pointer-events-auto" style="top: 18%; left: 28%;" aria-label="ä¼‘æ¯">
                        <div class="room-hotspot-button">
                            <span>ğŸ›ï¸</span>
                            <span>ä¼‘æ¯</span>
                        </div>
                    </button>
                    <button type="button" id="hotspot-diary" class="room-hotspot room-hotspot-highlight pointer-events-auto" style="bottom: 20%; right: 18%;" aria-label="æ‰“å¼€æ—…è¡Œæ—¥è®°">
                        <div class="room-hotspot-button">
                            <span>ğŸ“š</span>
                            <span>æ—¥è®°</span>
                        </div>
                    </button>
                    <button type="button" id="hotspot-cabinet" class="room-hotspot room-hotspot-highlight pointer-events-auto" style="top: 20%; right: 8%;" aria-label="æ‰“å¼€æ—…è¡Œæ©±æŸœ">
                        <div class="room-hotspot-button">
                            <span>ğŸ</span>
                            <span>æ©±æŸœ</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- é¦–æ¬¡è¿›å…¥å¼•å¯¼ -->
        <p id="room-hint" class="absolute top-28 left-0 w-full z-10 text-center text-[10px] text-gray-500 mt-1 transition-opacity duration-500 flex-shrink-0 pointer-events-none" style="text-shadow: 0 1px 2px rgba(255,255,255,0.8);">å·¦å³æ»‘åŠ¨ã€åŒæŒ‡ç¼©æ”¾å¯æŸ¥çœ‹å°å±‹</p>

        <!-- å¤–ç½®æ“ä½œæ ï¼ˆä¿ç•™ï¼Œä¸åœºæ™¯å†…çƒ­ç‚¹äºŒé€‰ä¸€æˆ–å¹¶ç”¨ï¼‰ -->
        <div id="petroom-action-bar" class="absolute bottom-16 left-4 right-4 z-10 glass-card rounded-2xl p-3 mx-4 mt-2 mb-2 flex justify-around items-center gap-2 flex-shrink-0 pointer-events-auto">
            <button type="button" id="action-rest" class="petroom-action-btn flex flex-col items-center gap-1 min-h-[44px] justify-center flex-1 rounded-xl py-2 transition-transform active:scale-95" aria-label="ä¼‘æ¯">
                <span class="text-xl">ğŸ›ï¸</span>
                <span class="text-[11px] font-bold text-gray-700">ä¼‘æ¯</span>
            </button>
            <button type="button" id="action-cabinet" class="petroom-action-btn flex flex-col items-center gap-1 min-h-[44px] justify-center flex-1 rounded-xl py-2 relative transition-transform active:scale-95" aria-label="æ‰“å¼€æ—…è¡Œæ©±æŸœ">
                <span class="text-xl relative"><span id="action-cabinet-badge" class="absolute -top-1 -right-1 w-2 h-2 bg-[#9bdeac] rounded-full hidden"></span>ğŸ</span>
                <span class="text-[11px] font-bold text-gray-700">æ©±æŸœ</span>
            </button>
            <button type="button" id="action-diary" class="petroom-action-btn flex flex-col items-center gap-1 min-h-[44px] justify-center flex-1 rounded-xl py-2 relative transition-transform active:scale-95" aria-label="æ‰“å¼€æ—…è¡Œæ—¥è®°">
                <span class="text-xl relative"><span id="action-diary-badge" class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full hidden"></span>ğŸ“š</span>
                <span class="text-[11px] font-bold text-gray-700">æ—¥è®°</span>
            </button>
        </div>

        <p class="petroom-bottom-hint absolute bottom-0 left-0 w-full z-10 text-center text-[10px] text-gray-600 py-2 px-4 pointer-events-none"><i class="ph-fill ph-info"></i> å® ç‰©çŠ¶æ€ä¼šæ ¹æ®ä½ çš„æ—…è¡Œå’Œå®ƒçš„æ€§æ ¼å˜åŒ–å“¦~</p>

        <!-- éšè—å®¹å™¨ï¼šæ‰¿è½½æ—…è¡Œæ©±æŸœä¸æ—…è¡Œæ—¥è®°å†…å®¹ï¼Œæ­£å¸¸è§†å›¾ä¸­ä¸å±•ç¤º -->
        <div id="petroom-hidden-containers" class="hidden">
            <div id="cabinet-grid" class="cabinet-shelf grid grid-cols-4 grid-rows-3 gap-2 min-h-[240px]">
                <!-- 12 æ ¼ç”± JS renderCabinetGrid() æ¸²æŸ“ -->
            </div>

            <div id="diary-list" class="flex flex-col gap-4">
                <!-- é»˜è®¤æ—¥è®° -->
                <div class="glass-card rounded-2xl p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-[#cdb4db] bg-white px-2 py-1 rounded-md shadow-sm">ä»Šå¤©</span>
                        <span class="text-xs text-gray-500 font-bold"><i class="ph-fill ph-map-pin text-[#ff8fab]"></i> æ¸©é¦¨å°å±‹</span>
                    </div>
                    <div class="flex gap-3">
                        <div class="text-3xl bg-white rounded-xl p-2 h-fit shadow-sm">ğŸ°</div>
                        <p class="text-gray-700 text-sm leading-relaxed">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±ä¼´æ¸¸å® ç‰©ã€‚æˆ‘å·²ç»å‡†å¤‡å¥½å’Œä½ ä¸€èµ·èµ°éä¸­å›½å•¦ï¼Œå¿«å¸¦æˆ‘å»æ‰“å¡å§ï¼</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- /main-content-slot -->

    <!-- ===== åº•éƒ¨å¯¼èˆªæ ï¼ˆå‚ä¸æ–‡æ¡£æµï¼Œå›ºå®šé«˜åº¦ï¼‰ ===== -->
    <nav class="flex-shrink-0 w-full h-20 bg-white/95 backdrop-blur-md rounded-t-[30px] shadow-[0_-15px_30px_rgba(0,0,0,0.04)] flex justify-around items-center px-6 pb-2 z-10 border-t border-gray-100">
        <button class="nav-item active flex flex-col items-center gap-1" data-target="view-home">
            <i class="ph-fill ph-map-trifold text-2xl"></i>
            <span class="text-[10px] font-bold">åœ°å›¾</span>
        </button>
        <button class="nav-item flex flex-col items-center gap-1 text-gray-400" data-target="view-petroom">
            <i class="ph-fill ph-house text-2xl relative">
                <span id="pet-room-badge" class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-[#9bdeac] rounded-full hidden"></span>
                <span id="diary-badge" class="absolute -bottom-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full hidden"></span>
            </i>
            <span class="text-[10px] font-bold">å® ç‰©</span>
        </button>
    </nav>

    <!-- é€šç”¨æ”¾å¤§æŸ¥çœ‹å¼¹å±‚ï¼šç”¨äºæ©±æŸœ / æ—¥è®° -->
    <div id="modal-overlay" class="absolute inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
        <div id="modal-panel" class="bg-[#fffaf0] rounded-3xl w-[90%] max-h-[75%] p-4 flex flex-col shadow-2xl">
            <div class="flex items-center justify-between mb-3">
                <h2 id="modal-title" class="text-sm font-bold text-gray-800"></h2>
                <button id="modal-close" class="text-gray-400 hover:text-gray-600 text-xl leading-none" data-modal-close aria-label="å…³é—­">&times;</button>
            </div>
            <div id="modal-body" class="flex-1 overflow-y-auto no-scrollbar space-y-3 text-xs"></div>
        </div>
    </div>
</div>

<script>
    // --- çŠ¶æ€ç®¡ç† ---
    const appState = {
        locations: [],
        cabinetItems: [],
        petPersonality: 'æ´»æ³¼',
        petAvatars: { 'æ´»æ³¼': 'ğŸ°', 'è´ªåƒ': 'ğŸ»', 'æ–‡è‰º': 'ğŸ±' },
        currentActionInterval: null
    };

    // --- OpenRouter AIGC é…ç½®ï¼ˆé€šè¿‡ /api/chat ä»£ç†ï¼ŒKey åœ¨æœåŠ¡ç«¯ç¯å¢ƒå˜é‡ä¸­ï¼‰ ---
    const AIGC_API_ENDPOINT = '/api/chat';
    const OPENROUTER_MODEL_ID = 'google/gemini-2.0-flash-001';

    let isCheckinInProgress = false;
    let ignoreNextPetClick = false;

    // --- DOM å…ƒç´ å¼•ç”¨ ---
    const views = document.querySelectorAll('.page-view');
    const navItems = document.querySelectorAll('.nav-item');
    
    const locationInput = document.getElementById('location-input');
    const btnCheckin = document.getElementById('btn-checkin');
    const mapPinsContainer = document.getElementById('map-pins-container');
    
    const petPersonalitySelect = document.getElementById('pet-personality');
    const personalityPills = document.querySelectorAll('.personality-pill');
    const petAvatarRoom = document.getElementById('pet-avatar-room');
    const petAvatarSprite = document.getElementById('pet-avatar-sprite');
    const petActionBubble = document.getElementById('pet-action-bubble');
    const petActionBubbleTail = document.querySelector('.bubble-tail');
    const petStatusBar = document.getElementById('pet-status-bar');
    const btnPetTouch = document.getElementById('btn-pet-touch');
    const btnPetGreet = document.getElementById('btn-pet-greet');
    const btnPetRestToggle = document.getElementById('btn-pet-rest-toggle');
    const actionRest = document.getElementById('action-rest');
    const actionCabinet = document.getElementById('action-cabinet');
    const actionDiary = document.getElementById('action-diary');
    const actionCabinetBadge = document.getElementById('action-cabinet-badge');
    const actionDiaryBadge = document.getElementById('action-diary-badge');
    const roomHint = document.getElementById('room-hint');
    
    const diaryList = document.getElementById('diary-list');
    const cabinetGrid = document.getElementById('cabinet-grid');
    const diaryBadge = document.getElementById('diary-badge');
    const petRoomBadge = document.getElementById('pet-room-badge');
    const scenePreview = document.getElementById('scene-preview');

    const modalOverlay = document.getElementById('modal-overlay');
    const modalPanel = document.getElementById('modal-panel');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalClose = document.getElementById('modal-close');
    const hotspotCabinet = document.getElementById('hotspot-cabinet');
    const hotspotDiary = document.getElementById('hotspot-diary');
    const hotspotBed = document.getElementById('hotspot-bed');
    const hotspotPot = document.getElementById('hotspot-pot');
    const hotspotDoor = document.getElementById('hotspot-door');
    const hotspotPlant = document.getElementById('hotspot-plant');

    const roomViewport = document.getElementById('room-viewport');
    const roomScene = document.getElementById('room-scene');

    const defaultPetPosition = {
        bottom: '25%',
        left: '50%'
    };

    // --- æˆ¿é—´åœºæ™¯æ‹–æ‹½ä¸ç¼©æ”¾ ---
    (function initRoomPanZoom() {
        if (!roomViewport || !roomScene) return;
        let sceneTranslateX = 0, sceneTranslateY = 0, sceneScale = 1;
        let lastPointerX = 0, lastPointerY = 0;
        let isPanning = false;
        let lastPinchDist = 0, lastPinchCenterX = 0, lastPinchCenterY = 0;
        const MIN_SCALE = 0.6, MAX_SCALE = 3;

        function applySceneTransform() {
            roomScene.style.transform = `translate(${sceneTranslateX}px, ${sceneTranslateY}px) scale(${sceneScale})`;
        }

        function isInteractiveTarget(el) {
            if (!el || !el.closest) return false;
            return el.closest('.room-hotspot');
        }

        function isOnPet(el) {
            return el && el.closest && el.closest('#pet-avatar-room');
        }

        const TAP_THRESHOLD_PX = 5;
        let pointerDownOnPet = false;
        let didPanThisGesture = false;
        let startPointerX = 0, startPointerY = 0;

        roomViewport.addEventListener('pointerdown', (e) => {
            if (e.button !== 0 && e.button !== undefined) return;
            if (isInteractiveTarget(e.target)) return;
            pointerDownOnPet = isOnPet(e.target);
            didPanThisGesture = false;
            startPointerX = e.clientX;
            startPointerY = e.clientY;
            isPanning = true;
            lastPointerX = e.clientX;
            lastPointerY = e.clientY;
            try { roomViewport.setPointerCapture(e.pointerId); } catch (_) {}
            e.preventDefault();
        });

        roomViewport.addEventListener('pointermove', (e) => {
            if (!isPanning) return;
            const dx = e.clientX - lastPointerX;
            const dy = e.clientY - lastPointerY;
            if (!didPanThisGesture && (Math.abs(e.clientX - startPointerX) > TAP_THRESHOLD_PX || Math.abs(e.clientY - startPointerY) > TAP_THRESHOLD_PX)) {
                didPanThisGesture = true;
            }
            lastPointerX = e.clientX;
            lastPointerY = e.clientY;
            sceneTranslateX += dx;
            sceneTranslateY += dy;
            applySceneTransform();
            e.preventDefault();
        });

        roomViewport.addEventListener('pointerup', () => {
            if (pointerDownOnPet && !didPanThisGesture && typeof window.__triggerPetTapInteraction === 'function') {
                ignoreNextPetClick = true;
                window.__triggerPetTapInteraction();
            }
            isPanning = false;
        });
        roomViewport.addEventListener('pointercancel', () => { isPanning = false; });
        roomViewport.addEventListener('pointerleave', () => { isPanning = false; });

        roomViewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.08 : 0.08;
            const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, sceneScale + delta));
            if (newScale === sceneScale) return;
            sceneScale = newScale;
            applySceneTransform();
        }, { passive: false });

        roomViewport.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                lastPinchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                lastPinchCenterX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                lastPinchCenterY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            }
        }, { passive: true });

        roomViewport.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                e.preventDefault();
                const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                const scaleFactor = dist / lastPinchDist;
                const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, sceneScale * scaleFactor));
                sceneScale = newScale;
                sceneTranslateX += centerX - lastPinchCenterX;
                sceneTranslateY += centerY - lastPinchCenterY;
                lastPinchDist = dist;
                lastPinchCenterX = centerX;
                lastPinchCenterY = centerY;
                applySceneTransform();
            }
        }, { passive: false });

        applySceneTransform();
    })();

    // --- æ¯”å¡ä¸˜å® ç‰©ç”Ÿå‘½çŠ¶æ€æœº ---
    const PET_STATES = {
        IDLE_WAIT: 'idle_wait',        // å…¥åœº / è¢«å«é†’åçš„çŸ­æš‚ç­‰å¾…
        IDLE_BREATH: 'idle_breath',    // æ­£å¸¸å‘¼å¸å‘å‘†
        IDLE_OBSERVE: 'idle_observe',  // å¥½å¥‡è§‚å¯Ÿ
        INTERACT: 'interact',          // ä¸ç”¨æˆ·äº’åŠ¨
        REST: 'rest'                   // ä¼‘æ¯/ç¡è§‰
    };

    const petLife = {
        current: PET_STATES.IDLE_WAIT,
        previous: PET_STATES.IDLE_BREATH,
        transientTimer: null,
        inactivityTimer: null
    };

    function updatePetStatus(text) {
        if (!petStatusBar) return;
        petStatusBar.textContent = text;
    }

    function clearPetTimers() {
        if (petLife.transientTimer) {
            clearTimeout(petLife.transientTimer);
            petLife.transientTimer = null;
        }
        if (petLife.inactivityTimer) {
            clearTimeout(petLife.inactivityTimer);
            petLife.inactivityTimer = null;
        }
    }

    function schedulePetTransition(targetState, delayMs) {
        if (!delayMs || !targetState) return;
        if (petLife.transientTimer) {
            clearTimeout(petLife.transientTimer);
        }
        petLife.transientTimer = setTimeout(() => {
            setPetState(targetState, { skipInactivityReset: true });
        }, delayMs);
    }

    function scheduleInactivityFlow() {
        // 15 ç§’æ— äº¤äº’ï¼šä»å‘¼å¸ -> è§‚å¯Ÿï¼›å† 15 ç§’ï¼šè§‚å¯Ÿ -> ä¼‘æ¯
        if (petLife.inactivityTimer) {
            clearTimeout(petLife.inactivityTimer);
        }
        petLife.inactivityTimer = setTimeout(() => {
            if (petLife.current === PET_STATES.REST) return;
            if (petLife.current === PET_STATES.IDLE_BREATH) {
                setPetState(PET_STATES.IDLE_OBSERVE, { skipInactivityReset: true });
                petLife.inactivityTimer = setTimeout(() => {
                    if (petLife.current !== PET_STATES.REST) {
                        setPetState(PET_STATES.REST, { skipInactivityReset: true });
                    }
                }, 15000);
            } else if (petLife.current === PET_STATES.IDLE_OBSERVE) {
                setPetState(PET_STATES.REST, { skipInactivityReset: true });
            }
        }, 15000);
    }

    function setPetState(nextState, options = {}) {
        if (!nextState) return;
        const prev = petLife.current;
        petLife.previous = prev;
        petLife.current = nextState;

        if (!options.keepOtherTimers) {
            clearPetTimers();
        }

        switch (nextState) {
            case PET_STATES.IDLE_WAIT:
                updatePetStatus('æ¯”å¡ä¸˜æ­£åœ¨ä¼¸æ‡’è…°å‡†å¤‡å‡ºå‘â€¦');
                playPetAnimation('idle_wait', { loop: false, frameInterval: 120, cycles: 2 });
                schedulePetTransition(PET_STATES.IDLE_BREATH, 2800);
                break;
            case PET_STATES.IDLE_BREATH:
                updatePetStatus('æ¯”å¡ä¸˜åœ¨å®‰é™åœ°å‘¼å¸æ”¾ç©ºä¸­');
                playPetAnimation('idle_breath', { loop: true, frameInterval: 130 });
                break;
            case PET_STATES.IDLE_OBSERVE:
                updatePetStatus('æ¯”å¡ä¸˜å¥½å¥‡åœ°ç›¯ç€ä½ çœ‹');
                playPetAnimation('idle_observe', { loop: false, frameInterval: 120, cycles: 2 });
                schedulePetTransition(PET_STATES.IDLE_BREATH, 4000);
                break;
            case PET_STATES.INTERACT:
                updatePetStatus('æ¯”å¡ä¸˜æ­£å¼€å¿ƒåœ°å’Œä½ äº’åŠ¨');
                playPetAnimation('interact', { loop: false, frameInterval: 90, cycles: 2 });
                schedulePetTransition(PET_STATES.IDLE_BREATH, 3200);
                break;
            case PET_STATES.REST:
                updatePetStatus('æ¯”å¡ä¸˜èœ·æˆä¸€å›¢ç¡ç€äº†â€¦');
                playPetAnimation('rest', { loop: true, frameInterval: 150 });
                break;
            default:
                playPetAnimation('idle_breath', { loop: true, frameInterval: 130 });
        }

        if (!options.skipInactivityReset && nextState !== PET_STATES.REST) {
            scheduleInactivityFlow();
        }

        if (btnPetRestToggle) {
            if (petLife.current === PET_STATES.REST) {
                btnPetRestToggle.textContent = 'å«é†’å®ƒ';
            } else {
                btnPetRestToggle.textContent = 'å»ä¼‘æ¯';
            }
        }
        if (actionRest) {
            if (petLife.current === PET_STATES.REST) {
                actionRest.querySelector('span:last-child').textContent = 'å«é†’å®ƒ';
            } else {
                actionRest.querySelector('span:last-child').textContent = 'ä¼‘æ¯';
            }
        }
    }

    function markPetInteraction() {
        // ç”¨æˆ·ä¸»åŠ¨äº¤äº’ä¼šé‡ç½®æ— æ“ä½œè®¡æ—¶
        if (petLife.current === PET_STATES.REST) {
            setPetState(PET_STATES.IDLE_WAIT);
        } else {
            scheduleInactivityFlow();
        }
    }

    // --- åœºæ™¯ç´ æï¼šä¸­å›½åœ°ç‚¹å›ºå®šæ˜ å°„ + éä¸­å›½åœ°ç‚¹éšè—æ¬¾éšæœº ---
    // ä¸­å›½åœ°ç‚¹ï¼ˆkey æŒ‰å…·ä½“ä¼˜å…ˆï¼Œå…ˆåŒ¹é…å¹¿å·å†åŒ¹é…å¹¿ä¸œï¼‰
    const sceneAssets = {
        'åŒ—äº¬':   { image: 'åœºæ™¯/åŒ—äº¬-ç³–è‘«èŠ¦.png',   label: 'åŒ—äº¬Â·ç³–è‘«èŠ¦' },
        'å¹¿å·':   { image: 'åœºæ™¯/å¹¿å·-æ—©èŒ¶.png',    label: 'å¹¿å·Â·æ—©èŒ¶' },
        'å¹¿ä¸œ':   { image: 'åœºæ™¯/å¹¿å·-æ—©èŒ¶.png',    label: 'å¹¿å·Â·æ—©èŒ¶' },
        'ä¸Šæµ·':   { image: 'åœºæ™¯/ä¸Šæµ·â€”å¤§ç™½å…”.png', label: 'ä¸Šæµ·Â·å¤§ç™½å…”' },
        'æ·±åœ³':   { image: 'åœºæ™¯/æ·±åœ³â€”ç°•æœé¹ƒ.png',  label: 'æ·±åœ³Â·ç°•æœé¹ƒ' },
        'æˆéƒ½':   { image: 'åœºæ™¯/å››å·â€”ç†ŠçŒ«.png',  label: 'å››å·Â·ç†ŠçŒ«' },
        'å››å·':   { image: 'åœºæ™¯/å››å·â€”ç†ŠçŒ«.png',  label: 'å››å·Â·ç†ŠçŒ«' },
        'æ­å·':   { image: 'åœºæ™¯/æµ™æ±Ÿâ€”é›„é»„é…’.png', label: 'æµ™æ±ŸÂ·é›„é»„é…’' },
        'æµ™æ±Ÿ':   { image: 'åœºæ™¯/æµ™æ±Ÿâ€”é›„é»„é…’.png', label: 'æµ™æ±ŸÂ·é›„é»„é…’' }
    };
    const sceneAssetsKeyOrder = ['åŒ—äº¬', 'å¹¿å·', 'å¹¿ä¸œ', 'ä¸Šæµ·', 'æ·±åœ³', 'æˆéƒ½', 'å››å·', 'æ­å·', 'æµ™æ±Ÿ'];

    const hiddenSceneAssets = [
        { image: 'åœºæ™¯/åŸƒåŠé‡‘å­—å¡”.png',   label: 'éšè—æ¬¾ Â· åŸƒåŠé‡‘å­—å¡”' },
        { image: 'åœºæ™¯/åŸƒè²å°”é“å¡”.png',   label: 'éšè—æ¬¾ Â· åŸƒè²å°”é“å¡”' },
        { image: 'åœºæ™¯/è‡ªç”±å¥³ç¥åƒ.png',   label: 'éšè—æ¬¾ Â· è‡ªç”±å¥³ç¥åƒ' }
    ];

    function getSceneAsset(location) {
        const normalized = typeof normalizeLocationName === 'function' ? normalizeLocationName(location) : String(location || '').trim();
        for (let i = 0; i < sceneAssetsKeyOrder.length; i++) {
            const key = sceneAssetsKeyOrder[i];
            if (normalized.includes(key) || (location && String(location).includes(key))) {
                return sceneAssets[key];
            }
        }
        if (typeof isChinaLocation === 'function' && !isChinaLocation(location)) {
            if (hiddenSceneAssets.length > 0) {
                return hiddenSceneAssets[Math.floor(Math.random() * hiddenSceneAssets.length)];
            }
        }
        return null;
    }

    // --- æ€§æ ¼é€‰æ‹©ï¼šèƒ¶å›Šé€‰é¡¹ ---
    function setPersonalityPillActive(value) {
        personalityPills.forEach((pill) => {
            if (pill.getAttribute('data-value') === value) {
                pill.classList.add('active');
            } else {
                pill.classList.remove('active');
            }
        });
    }
    setPersonalityPillActive(appState.petPersonality);

    personalityPills.forEach((pill) => {
        pill.addEventListener('click', () => {
            const value = pill.getAttribute('data-value');
            if (!value) return;
            appState.petPersonality = value;
            if (petPersonalitySelect) {
                petPersonalitySelect.value = value;
                petPersonalitySelect.dispatchEvent(new Event('change'));
            }
            setPersonalityPillActive(value);
        });
    });

    // --- æˆ¿é—´å†…å® ç‰©ç§»åŠ¨ä¸çƒ­ç‚¹åŠ¨æ•ˆ ---
    function movePetToSpot(position, contextOverride, stayMs = 2600, animationState = null) {
        if (!petAvatarRoom) return;

        if (position && typeof position.bottom === 'string' && typeof position.left === 'string') {
            petAvatarRoom.style.bottom = position.bottom;
            petAvatarRoom.style.left = position.left;
        }

        if (contextOverride) {
            triggerAIPetAction(contextOverride);
        } else {
            triggerAIPetAction();
        }

        if (animationState) {
            playPetAnimation(animationState, { loop: false, frameInterval: 220 });
        }

        // åˆ°è¾¾ç›®æ ‡æ—¶æ’­æ”¾è·³è·ƒè½åœ°åŠ¨æ•ˆ
        petAvatarRoom.classList.remove('pet-anim-jump');
        void petAvatarRoom.offsetWidth;
        petAvatarRoom.classList.add('pet-anim-jump');
        setTimeout(() => petAvatarRoom.classList.remove('pet-anim-jump'), 450);

        if (stayMs > 0) {
            setTimeout(() => {
                petAvatarRoom.style.bottom = defaultPetPosition.bottom;
                petAvatarRoom.style.left = defaultPetPosition.left;
            }, stayMs);
        }
    }

    function wiggleHotspot(buttonEl) {
        if (!buttonEl) return;
        const visual = buttonEl.querySelector('.room-hotspot-button') || buttonEl;
        visual.classList.remove('room-hotspot-wiggle');
        // è¯» offsetWidth ä»¥é‡æ–°è§¦å‘ CSS åŠ¨ç”»
        void visual.offsetWidth;
        visual.classList.add('room-hotspot-wiggle');
    }

    // --- å¼¹å±‚ï¼šé€šç”¨æ”¾å¤§æŸ¥çœ‹ ---
    function openModal(title, contentHTML, variant = 'default') {
        if (!modalOverlay || !modalTitle || !modalBody || !modalPanel) return;
        modalTitle.textContent = title;
        modalBody.innerHTML = contentHTML;

        if (variant === 'diary') {
            modalPanel.className = 'bg-[#fffaf0] rounded-3xl w-[94%] h-[82%] p-4 flex flex-col shadow-2xl';
        } else if (variant === 'cabinet') {
            modalPanel.className = 'cabinet-modal rounded-3xl w-[90%] max-h-[75%] p-4 flex flex-col shadow-2xl';
        } else {
            modalPanel.className = 'bg-[#fffaf0] rounded-3xl w-[90%] max-h-[75%] p-4 flex flex-col shadow-2xl';
        }

        modalOverlay.classList.remove('hidden');
    }

    function closeModal() {
        if (!modalOverlay) return;
        modalOverlay.classList.add('hidden');
        if (modalBody) modalBody.innerHTML = '';
    }

    function openCabinetModal() {
        if (!cabinetGrid) return;
        const count = (appState.cabinetItems && appState.cabinetItems.length) || cabinetGrid.querySelectorAll('[data-cabinet-item]').length;
        const emptyHint = count === 0 ? '<p class="text-center text-[11px] text-gray-500 py-2">å¸¦æˆ‘å»æ‰“å¡ï¼Œè§£é”ç¬¬ä¸€ä»¶çºªå¿µå“å§~</p>' : '';
        const bodyHTML = `
            <div class="cabinet-modal-content space-y-3 text-xs">
                <div class="flex items-baseline justify-between text-[11px]" style="color:#5c4a3a">
                    <span class="font-bold">æˆ‘çš„æ—…è¡Œæ©±æŸœ</span>
                    <span>å·²æ”¶é›† <span class="font-semibold" style="color:#b85c6f">${count}</span> ä»¶å°ç‰©ä»¶</span>
                </div>
                ${emptyHint}
                <div class="cabinet-shelf grid grid-cols-4 gap-2">
                    ${cabinetGrid.innerHTML}
                </div>
                <p class="text-[10px] text-right" style="color:#6b5b4f">æ‰“å¡è¶Šå¤šï¼Œæ©±æŸœè¶Šæ»¡å“¦~</p>
            </div>
        `;
        openModal('æ—…è¡Œæ©±æŸœ', bodyHTML, 'cabinet');
    }

    function openDiaryModal() {
        if (!diaryList) return;
        const hasUserDiaries = (appState.locations && appState.locations.length) > 0;
        const diaryHint = !hasUserDiaries ? '<p class="text-center text-[11px] text-gray-500 py-2">å¸¦æˆ‘å»æ‰“å¡ï¼Œè§£é”ç¬¬ä¸€ç¯‡æ—…è¡Œæ—¥è®°å§~</p>' : '';
        const bodyHTML = `
            <div class="flex flex-col gap-3 text-xs">
                <div class="text-[11px] text-gray-500">æœ€æ–°æ‰“å¡ä¼šå‡ºç°åœ¨æœ€ä¸Šæ–¹</div>
                ${diaryHint}
                <div class="flex flex-col gap-3">
                    ${diaryList.innerHTML}
                </div>
            </div>
        `;
        openModal('æ—…è¡Œæ—¥è®°', bodyHTML, 'diary');
    }

    function enterPetRoom() {
        triggerAIPetAction();
        setPetState(PET_STATES.IDLE_WAIT);

        const petViewEl = document.getElementById('view-petroom');
        if (petViewEl) {
            petViewEl.classList.add('entrance');
            setTimeout(() => petViewEl.classList.remove('entrance'), 450);
        }

        if (roomHint && !sessionStorage.getItem('petroom-hint-seen')) {
            roomHint.style.opacity = '1';
            setTimeout(() => {
                roomHint.style.opacity = '0';
                sessionStorage.setItem('petroom-hint-seen', '1');
            }, 3000);
        } else if (roomHint) {
            roomHint.style.opacity = '0';
        }
    }

    function leavePetRoom() {
        // ç¦»å¼€å® ç‰© Tab æ—¶ï¼Œæš‚åœè®¡æ—¶å™¨ï¼Œé¿å…åå°ä¹±è·³çŠ¶æ€
        clearPetTimers();
        clearInterval(appState.currentActionInterval);
    }

    // --- å¯¼èˆªåˆ‡æ¢é€»è¾‘ ---
    navItems.forEach(item => {
        item.addEventListener('click', () => {
            navItems.forEach(nav => {
                nav.classList.remove('active');
                nav.classList.add('text-gray-400');
            });
            item.classList.add('active');
            item.classList.remove('text-gray-400');
            
            const targetId = item.getAttribute('data-target');
            views.forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(targetId);
            if (targetView) targetView.classList.add('active');

            if (targetId === 'view-petroom') {
                diaryBadge.classList.add('hidden');
                petRoomBadge.classList.add('hidden');
                if (actionDiaryBadge) actionDiaryBadge.classList.add('hidden');
                if (actionCabinetBadge) actionCabinetBadge.classList.add('hidden');
                enterPetRoom();
            } else {
                leavePetRoom();
            }
            if (targetView && targetView.scrollTop !== undefined) targetView.scrollTop = 0;
        });
    });

    if (modalOverlay) {
        modalOverlay.addEventListener('click', (event) => {
            if (event.target === modalOverlay || event.target.hasAttribute('data-modal-close')) {
                closeModal();
            }
        });
    }

    if (hotspotCabinet) {
        hotspotCabinet.addEventListener('click', (event) => {
            event.stopPropagation();
            openCabinetModal();
        });
    }

    if (hotspotDiary) {
        hotspotDiary.addEventListener('click', (event) => {
            event.stopPropagation();
            openDiaryModal();
        });
    }

    if (actionCabinet) {
        actionCabinet.addEventListener('click', () => openCabinetModal());
    }
    if (actionDiary) {
        actionDiary.addEventListener('click', () => openDiaryModal());
    }
    if (actionRest) {
        actionRest.addEventListener('click', () => {
            if (petLife.current === PET_STATES.REST) {
                triggerAIPetAction('è¢«ä¸»äººå«é†’ï¼Œè¿·è¿·ç³Šç³Šåœ°çå¼€äº†çœ¼ç›');
                setPetState(PET_STATES.IDLE_WAIT);
            } else {
                triggerAIPetAction('å†³å®šå…ˆå°ç¡ä¸€ä¼šå„¿ï¼Œæ¢å¤ä½“åŠ›');
                setPetState(PET_STATES.REST);
            }
        });
    }

    // æˆ¿é—´çƒ­ç‚¹ï¼šåºŠ / é”… / é—¨ / æ¤ç‰©
    if (hotspotBed) {
        hotspotBed.addEventListener('click', (event) => {
            event.stopPropagation();
            wiggleHotspot(hotspotBed);
            markPetInteraction();
            movePetToSpot(
                { bottom: '32%', left: '50%' },
                'åœ¨è½¯è½¯çš„åºŠä¸Šä¼¸äº†ä¸ªå¤§å¤§çš„æ‡’è…°',
                2600,
                'rest'
            );
            setPetState(PET_STATES.REST);
        });
    }

    if (hotspotPot) {
        hotspotPot.addEventListener('click', (event) => {
            event.stopPropagation();
            wiggleHotspot(hotspotPot);
            markPetInteraction();
            movePetToSpot(
                { bottom: '26%', left: '30%' },
                'è·‘åˆ°é”…è¾¹å·å·é—»äº†ä¸€å¤§å£é¦™å‘³',
                2600,
                'eat'
            );
            setPetState(PET_STATES.INTERACT);
        });
    }

    if (hotspotDoor) {
        hotspotDoor.addEventListener('click', (event) => {
            event.stopPropagation();
            wiggleHotspot(hotspotDoor);
            markPetInteraction();
            movePetToSpot(
                { bottom: '30%', left: '70%' },
                'è·‘åˆ°é—¨å£ï¼Œå‡†å¤‡å’Œä¸»äººä¸€èµ·å‡ºé—¨æ¢ç´¢',
                800,
                'door'
            );
            setPetState(PET_STATES.INTERACT);

            setTimeout(() => {
                const homeNav = Array.from(navItems).find(
                    (item) => item.getAttribute('data-target') === 'view-home'
                );
                if (homeNav) {
                    homeNav.click();
                }
            }, 350);
        });
    }

    if (hotspotPlant) {
        hotspotPlant.addEventListener('click', (event) => {
            event.stopPropagation();
            wiggleHotspot(hotspotPlant);
            markPetInteraction();
            triggerAIPetAction('é åœ¨ç»¿æ¤æ—è¾¹å®‰é™åœ°å‘¼å¸æ–°é²œç©ºæ°”');
            playPetAnimation('plant', { loop: false, frameInterval: 220, cycles: 3 });
            setPetState(PET_STATES.IDLE_BREATH);
        });
    }

    // --- å® ç‰©æ€§æ ¼åˆ‡æ¢ ---
    petPersonalitySelect.addEventListener('change', (e) => {
        appState.petPersonality = e.target.value;

        // åŠ¨ç”»åé¦ˆ
        if (petAvatarRoom) {
            petAvatarRoom.style.transform = 'translate(-50%, 0) scale(1.2) rotate(10deg)';
            setTimeout(() => { petAvatarRoom.style.transform = 'translateX(-50%)'; }, 300);
        }
        
        markPetInteraction();
        triggerAIPetAction(); // åˆ‡æ¢æ€§æ ¼ç«‹åˆ»ç”Ÿæˆæ–°çŠ¶æ€
        setPetState(PET_STATES.INTERACT);
    });

    // --- æ¯”å¡ä¸˜å® ç‰©æŒ‰é’®äº¤äº’ ---
    if (btnPetTouch) {
        btnPetTouch.addEventListener('click', () => {
            markPetInteraction();
            triggerAIPetAction('ä¸»äººè½»è½»æ‘¸äº†æ‘¸æˆ‘çš„å¤´');
            setPetState(PET_STATES.INTERACT);
        });
    }

    if (btnPetGreet) {
        btnPetGreet.addEventListener('click', () => {
            markPetInteraction();
            triggerAIPetAction('ä¸»äººå¯¹æˆ‘æŒ¥æ‰‹æ‰“äº†ä¸ªæ‹›å‘¼');
            setPetState(PET_STATES.IDLE_OBSERVE);
        });
    }

    if (btnPetRestToggle) {
        btnPetRestToggle.addEventListener('click', () => {
            if (petLife.current === PET_STATES.REST) {
                // ä»ä¼‘æ¯ä¸­è¢«å«é†’
                triggerAIPetAction('è¢«ä¸»äººå«é†’ï¼Œè¿·è¿·ç³Šç³Šåœ°çå¼€äº†çœ¼ç›');
                setPetState(PET_STATES.IDLE_WAIT);
            } else {
                triggerAIPetAction('å†³å®šå…ˆå°ç¡ä¸€ä¼šå„¿ï¼Œæ¢å¤ä½“åŠ›');
                setPetState(PET_STATES.REST);
            }
        });
    }

    // --- æ ¸å¿ƒï¼šæ‰“å¡è”åŠ¨ ---
    btnCheckin.addEventListener('click', async () => {
        if (isCheckinInProgress) return;

        const location = locationInput.value.trim();
        if (!location) return;

        isCheckinInProgress = true;

        appState.locations.push(location);
        
        // 1. åœ¨åœ°å›¾ä¸Šéšæœºä½ç½®ç”Ÿæˆæ‰“å¡å›¾é’‰
        addMapPin(location);

        const originalText = btnCheckin.innerText;
        btnCheckin.disabled = true;
        btnCheckin.innerText = 'å†™æ—¥è®°ä¸­â€¦';
        
        let diaryText = '';
        let usedFallback = false;

        console.log('[Diary AIGC] æ­£åœ¨é€šè¿‡ /api/chat è¯·æ±‚ç”Ÿæˆæ—¥è®°â€¦');
        const result = await generateDiaryWithAIGC(location, appState.petPersonality);
        if (result && result.ok && result.content) {
            diaryText = result.content;
        } else {
            usedFallback = true;
            console.warn('[Diary AIGC] ä½¿ç”¨æœ¬åœ°æ¨¡æ¿æ—¥è®°ä½œä¸ºå…œåº•ã€‚åŸå› :', result && result.error ? result.error : 'è¿”å›å†…å®¹ä¸ºç©º');
        }

        if (!diaryText) {
            diaryText = buildDiaryText(location, appState.petPersonality);
        }

        const scene = getSceneAsset(location);

        // 2. ç”Ÿæˆæ—¥è®°
        generateDiaryEntry(location, diaryText, scene);

        // 3. æ”¹å˜å® ç‰©æˆ¿é—´çŠ¶æ€ä¸æ©±æŸœ
        triggerAIPetAction(`åˆšæ‰å»äº†${location}`);
        setPetState(PET_STATES.INTERACT);
        petRoomBadge.classList.remove('hidden'); // æç¤ºå® ç‰©æˆ¿é—´æœ‰æ–°åŠ¨æ€
        if (actionCabinetBadge) actionCabinetBadge.classList.remove('hidden');
        diaryBadge.classList.remove('hidden');   // æç¤ºå® ç‰©é¡µæœ‰æ–°æ—¥è®°
        if (actionDiaryBadge) actionDiaryBadge.classList.remove('hidden');
        addCabinetItem(location, scene);         // åœ¨æ©±æŸœä¸­æ–°å¢ä¸€ä¸ªçºªå¿µå“ï¼ˆåŒä¸€ scene ä¿è¯éšè—æ¬¾ä¸€è‡´ï¼‰
        showScenePreview(location, scene);      // å¦‚æœ‰ç‰¹æ®Šåœºæ™¯ï¼Œå±•ç¤ºåœºæ™¯é¢„è§ˆå¡ç‰‡
        playExcitedAnimation();                 // å® ç‰©æ’­æ”¾ä¸€æ¬¡å…´å¥‹åŠ¨ç”»

        if (usedFallback) {
            console.warn('[Diary AIGC] ä½¿ç”¨æœ¬åœ°æ¨¡æ¿æ—¥è®°ä½œä¸ºå…œåº•ã€‚');
        }
        
        // æŒ‰é’®è§†è§‰åé¦ˆ
        locationInput.value = '';
        btnCheckin.innerText = 'æ‰“å¡æˆåŠŸ!';
        btnCheckin.classList.replace('bg-[#ff8fab]', 'bg-[#9bdeac]');
        setTimeout(() => {
            btnCheckin.innerText = originalText || 'å»æ‰“å¡';
            btnCheckin.classList.replace('bg-[#9bdeac]', 'bg-[#ff8fab]');
            btnCheckin.disabled = false;
            isCheckinInProgress = false;
        }, 1500);
    });

    // --- åœ°ç‚¹æ ‡å‡†åŒ–ä¸ä¸­å›½åœ°å›¾åæ ‡æ˜ å°„ ---
    function normalizeLocationName(raw) {
        if (!raw) return '';
        let text = String(raw)
            .trim()
            .replace(/[\s\u3000]+/g, ''); // å»æ‰åŠè§’/å…¨è§’ç©ºæ ¼

        const aliasMap = {
            'åŒ—äº¬å¸‚': 'åŒ—äº¬',
            'å¤©æ´¥å¸‚': 'å¤©æ´¥',
            'ä¸Šæµ·å¸‚': 'ä¸Šæµ·',
            'é‡åº†å¸‚': 'é‡åº†',
            'å†…è’™': 'å†…è’™å¤',
            'å†…è’™å¤è‡ªæ²»åŒº': 'å†…è’™å¤',
            'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': 'å¹¿è¥¿',
            'å®å¤å›æ—è‡ªæ²»åŒº': 'å®å¤',
            'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': 'æ–°ç–†',
            'è¥¿è—è‡ªæ²»åŒº': 'è¥¿è—',
            'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº': 'é¦™æ¸¯',
            'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº': 'æ¾³é—¨'
        };

        if (aliasMap[text]) return aliasMap[text];

        text = text
            .replace(/çœ$/g, '')
            .replace(/å¸‚$/g, '')
            .replace(/ç‰¹åˆ«è¡Œæ”¿åŒº$/g, '')
            .replace(/å£®æ—è‡ªæ²»åŒº$/g, '')
            .replace(/å›æ—è‡ªæ²»åŒº$/g, '')
            .replace(/ç»´å¾å°”è‡ªæ²»åŒº$/g, '')
            .replace(/è‡ªæ²»åŒº$/g, '');

        if (aliasMap[text]) return aliasMap[text];
        return text;
    }

    // çœçº§è¡Œæ”¿åŒº + è‹¥å¹²çƒ­é—¨åŸå¸‚åœ¨å½“å‰å¡é€šåœ°å›¾ä¸Šçš„å¤§è‡´åæ ‡ï¼ˆåŸºäºå®¹å™¨ç™¾åˆ†æ¯”ï¼‰
    const locationMap = {
        // ç›´è¾–å¸‚ / ååŒ—
        'åŒ—äº¬':   { top: '28%', left: '62%' },
        'å¤©æ´¥':   { top: '30%', left: '66%' },
        'æ²³åŒ—':   { top: '32%', left: '59%' },
        'å±±è¥¿':   { top: '34%', left: '54%' },
        'å†…è’™å¤': { top: '26%', left: '50%' },

        // ä¸œåŒ—
        'è¾½å®':   { top: '26%', left: '69%' },
        'å‰æ—':   { top: '23%', left: '74%' },
        'é»‘é¾™æ±Ÿ': { top: '19%', left: '78%' },

        // åä¸œ
        'ä¸Šæµ·':   { top: '46%', left: '74%' },
        'æ±Ÿè‹':   { top: '42%', left: '70%' },
        'æµ™æ±Ÿ':   { top: '50%', left: '71%' },
        'å±±ä¸œ':   { top: '38%', left: '67%' },
        'å®‰å¾½':   { top: '46%', left: '63%' },
        'æ±Ÿè¥¿':   { top: '56%', left: '60%' },
        'ç¦å»º':   { top: '58%', left: '66%' },

        // åä¸­
        'æ²³å—':   { top: '42%', left: '58%' },
        'æ¹–åŒ—':   { top: '48%', left: '55%' },
        'æ¹–å—':   { top: '54%', left: '55%' },

        // åå—
        'å¹¿ä¸œ':   { top: '64%', left: '58%' },
        'å¹¿è¥¿':   { top: '66%', left: '50%' },
        'æµ·å—':   { top: '76%', left: '58%' },
        'é¦™æ¸¯':   { top: '67%', left: '61%' },
        'æ¾³é—¨':   { top: '68%', left: '58%' },
        'å°æ¹¾':   { top: '63%', left: '74%' },

        // è¥¿å—
        'é‡åº†':   { top: '55%', left: '54%' },
        'å››å·':   { top: '51%', left: '48%' },
        'è´µå·':   { top: '58%', left: '50%' },
        'äº‘å—':   { top: '63%', left: '45%' },
        'è¥¿è—':   { top: '60%', left: '28%' },

        // è¥¿åŒ—
        'é™•è¥¿':   { top: '41%', left: '50%' },
        'ç”˜è‚ƒ':   { top: '37%', left: '40%' },
        'é’æµ·':   { top: '38%', left: '34%' },
        'å®å¤':   { top: '35%', left: '46%' },
        'æ–°ç–†':   { top: '27%', left: '24%' },

        // çƒ­é—¨åŸå¸‚ï¼ˆåœ¨çœä»½å†…å¤§è‡´ä½ç½®ï¼‰
        'æ­¦æ±‰':   { top: '48%', left: '56%' },
        'å—äº¬':   { top: '44%', left: '71%' },
        'æ­å·':   { top: '50%', left: '72%' },
        'æˆéƒ½':   { top: '52%', left: '46%' },
        'è¥¿å®‰':   { top: '42%', left: '51%' },
        'é’å²›':   { top: '36%', left: '69%' },
        'å¦é—¨':   { top: '60%', left: '67%' },
        'æ·±åœ³':   { top: '66%', left: '59%' },
        'å¹¿å·':   { top: '65%', left: '58%' },
        'è‹å·':   { top: '44%', left: '72%' },
        'é•¿æ²™':   { top: '54%', left: '56%' },
        'éƒ‘å·':   { top: '42%', left: '57%' },
        'æµå—':   { top: '38%', left: '65%' },
        'å“ˆå°”æ»¨': { top: '20%', left: '78%' },
        'æ²ˆé˜³':   { top: '26%', left: '70%' },
        'æ˜†æ˜':   { top: '64%', left: '42%' },
        'å¤§ç†':   { top: '62%', left: '38%' },
        'ä¸½æ±Ÿ':   { top: '60%', left: '36%' },
        'æ´›é˜³':   { top: '42%', left: '55%' },
        'æ¡‚æ—':   { top: '64%', left: '52%' },
        'ç æµ·':   { top: '67%', left: '58%' },
        'å¤§è¿':   { top: '24%', left: '72%' },
        'å®æ³¢':   { top: '50%', left: '73%' },
        'æ— é”¡':   { top: '44%', left: '71%' },
        'åˆè‚¥':   { top: '46%', left: '64%' },
        'ç¦å·':   { top: '58%', left: '66%' },
        'å—æ˜Œ':   { top: '56%', left: '61%' },
        'çŸ³å®¶åº„': { top: '32%', left: '60%' },
        'å¤ªåŸ':   { top: '34%', left: '54%' },
        'å‘¼å’Œæµ©ç‰¹': { top: '28%', left: '48%' },
        'ä¹Œé²æœ¨é½': { top: '30%', left: '22%' },
        'æ‹‰è¨':   { top: '62%', left: '26%' },
        'ä¸‰äºš':   { top: '78%', left: '56%' }
    };

    // åŸå¸‚ â†’ çœä»½ï¼ˆç”¨äºæœªåœ¨ locationMap ä¸­çš„åœ°åå…œåº•ï¼Œè½åœ¨å¯¹åº”çœä»½ä¸­å¿ƒï¼‰
    const cityToProvince = {
        'å®œæ˜Œ': 'æ¹–åŒ—', 'è¥„é˜³': 'æ¹–åŒ—', 'è†å·': 'æ¹–åŒ—', 'é»„å†ˆ': 'æ¹–åŒ—',
        'å¾å·': 'æ±Ÿè‹', 'å—é€š': 'æ±Ÿè‹', 'å¸¸å·': 'æ±Ÿè‹', 'æ‰¬å·': 'æ±Ÿè‹', 'é•‡æ±Ÿ': 'æ±Ÿè‹', 'æ— é”¡': 'æ±Ÿè‹',
        'æ¸©å·': 'æµ™æ±Ÿ', 'ç»å…´': 'æµ™æ±Ÿ', 'å˜‰å…´': 'æµ™æ±Ÿ', 'é‡‘å': 'æµ™æ±Ÿ', 'å°å·': 'æµ™æ±Ÿ',
        'çƒŸå°': 'å±±ä¸œ', 'å¨æµ·': 'å±±ä¸œ', 'æ½åŠ': 'å±±ä¸œ', 'æ·„åš': 'å±±ä¸œ', 'ä¸´æ²‚': 'å±±ä¸œ',
        'å”å±±': 'æ²³åŒ—', 'ä¿å®š': 'æ²³åŒ—', 'é‚¯éƒ¸': 'æ²³åŒ—', 'ç§¦çš‡å²›': 'æ²³åŒ—',
        'ä½›å±±': 'å¹¿ä¸œ', 'ä¸œè': 'å¹¿ä¸œ', 'æ±•å¤´': 'å¹¿ä¸œ', 'æ¹›æ±Ÿ': 'å¹¿ä¸œ', 'ä¸­å±±': 'å¹¿ä¸œ', 'æƒ å·': 'å¹¿ä¸œ',
        'æ³‰å·': 'ç¦å»º', 'æ¼³å·': 'ç¦å»º', 'ç¦å·': 'ç¦å»º', 'è†ç”°': 'ç¦å»º',
        'æŸ³å·': 'å¹¿è¥¿', 'åŒ—æµ·': 'å¹¿è¥¿', 'å—å®': 'å¹¿è¥¿',
        'éµä¹‰': 'è´µå·', 'è´µé˜³': 'è´µå·', 'å…­ç›˜æ°´': 'è´µå·',
        'ç»µé˜³': 'å››å·', 'ä¹å±±': 'å››å·', 'å¾·é˜³': 'å››å·', 'å®œå®¾': 'å››å·', 'å—å……': 'å››å·',
        'å¼€å°': 'æ²³å—', 'å—é˜³': 'æ²³å—', 'å®‰é˜³': 'æ²³å—', 'æ–°ä¹¡': 'æ²³å—', 'å•†ä¸˜': 'æ²³å—',
        'å²³é˜³': 'æ¹–å—', 'æ ªæ´²': 'æ¹–å—', 'æ¹˜æ½­': 'æ¹–å—', 'è¡¡é˜³': 'æ¹–å—', 'å¼ å®¶ç•Œ': 'æ¹–å—',
        'èµ£å·': 'æ±Ÿè¥¿', 'ä¹æ±Ÿ': 'æ±Ÿè¥¿', 'ä¸Šé¥¶': 'æ±Ÿè¥¿',
        'èŠœæ¹–': 'å®‰å¾½', 'èšŒåŸ ': 'å®‰å¾½', 'å®‰åº†': 'å®‰å¾½', 'é»„å±±': 'å®‰å¾½',
        'åŒ…å¤´': 'å†…è’™å¤', 'é„‚å°”å¤šæ–¯': 'å†…è’™å¤',
        'å¤§åº†': 'é»‘é¾™æ±Ÿ', 'é½é½å“ˆå°”': 'é»‘é¾™æ±Ÿ', 'ç‰¡ä¸¹æ±Ÿ': 'é»‘é¾™æ±Ÿ',
        'å‰æ—å¸‚': 'å‰æ—', 'é•¿æ˜¥': 'å‰æ—',
        'ç§¦çš‡å²›': 'æ²³åŒ—', 'æ‰¿å¾·': 'æ²³åŒ—'
    };

    function isChinaLocation(location) {
        const n = normalizeLocationName(location);
        if (locationMap[n] || cityToProvince[n]) return true;
        const allKeys = [...Object.keys(locationMap), ...Object.keys(cityToProvince)];
        for (const k of allKeys) {
            if (n.includes(k) || (k && n.indexOf(k) !== -1)) return true;
        }
        return false;
    }

    // --- åœ°å›¾çœä»½çƒ­ç‚¹å±‚ï¼šå¯ç‚¹å‡»çœä»½ï¼Œå¡«å…¥åœ°ç‚¹å¹¶æ‰“å¡ ---
    const mapHotspotsEl = document.getElementById('map-hotspots');
    if (mapHotspotsEl) {
        Object.entries(locationMap).forEach(([name, pos]) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'map-hotspot';
            btn.setAttribute('aria-label', `åœ¨${name}æ‰“å¡`);
            btn.style.top = pos.top;
            btn.style.left = pos.left;
            btn.dataset.location = name;
            btn.title = `ç‚¹å‡»åœ¨ ${name} æ‰“å¡`;
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                if (!locationInput) return;
                locationInput.value = name;
                if (btnCheckin && !isCheckinInProgress) btnCheckin.click();
            });
            mapHotspotsEl.appendChild(btn);
        });
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ åœ°å›¾å›¾é’‰ ---
    function addMapPin(location) {
        const key = normalizeLocationName(location);
        let mapping = locationMap[key];

        if (!mapping && cityToProvince[key]) {
            const province = cityToProvince[key];
            mapping = locationMap[province];
        }

        let top;
        let left;
        if (mapping) {
            top = mapping.top;
            left = mapping.left;
        } else {
            // åœ¨è§„å®šèŒƒå›´å†…éšæœºç”Ÿæˆåæ ‡ (é¿å¼€è¾¹ç¼˜) ä½œä¸ºå…œåº•
            const randomX = Math.floor(Math.random() * 60) + 20;
            const randomY = Math.floor(Math.random() * 60) + 20;
            left = `${randomX}%`;
            top = `${randomY}%`;
        }
        
        const pinHTML = `
            <div class="absolute pin-drop flex flex-col items-center" style="top: ${top}; left: ${left};">
                <div class="bg-white/90 text-xs font-bold px-2 py-0.5 rounded-full shadow-md text-[#ff8fab] mb-1 whitespace-nowrap border border-[#ff8fab]">
                    ${location}
                </div>
                <div class="text-2xl drop-shadow-md">ğŸ“</div>
            </div>
        `;
        mapPinsContainer.insertAdjacentHTML('beforeend', pinHTML);
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šAIæ¨¡æ‹Ÿå® ç‰©äº’åŠ¨çŠ¶æ€ç”Ÿæˆ ---
    function triggerAIPetAction(contextOverride = null) {
        clearInterval(appState.currentActionInterval);

        const showBubbleShort = (text) => {
            if (petActionBubble) {
                petActionBubble.innerHTML = text;
                petActionBubble.style.opacity = '1';
                if (petActionBubbleTail) petActionBubbleTail.style.opacity = '1';
            }
            setTimeout(() => {
                if (petActionBubble) petActionBubble.style.opacity = '0';
                if (petActionBubbleTail) petActionBubbleTail.style.opacity = '0';
            }, 2500);
        };

        const generateText = () => {
            const personality = appState.petPersonality;
            const hasTraveled = appState.locations.length > 0;
            const lastLocation = hasTraveled ? appState.locations[appState.locations.length - 1] : '';

            const aiTemplates = {
                'æ´»æ³¼': [
                    "æ­£åœ¨æˆ¿é—´é‡Œè¹¦è¹¦è·³è·³ ğŸµ",
                    "æ­£åœ¨æ”¶æ‹¾èƒŒåŒ…ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡å‡ºå‘ï¼",
                    hasTraveled ? `å¥½æƒ³å†å»ä¸€æ¬¡ã€${lastLocation}ã€‘ç©å•Šï¼` : "å¥½æƒ³å‡ºå»ç©å•Šï¼",
                    hasTraveled ? `åœ¨çœ‹ã€${lastLocation}ã€‘æ‹çš„ç…§ç‰‡~ ğŸ“·` : "åœ¨åšçƒ­èº«è¿åŠ¨..."
                ],
                'è´ªåƒ': [
                    "è‚šå­å’•å’•å«äº†ï¼Œæƒ³åƒé›¶é£Ÿ ğŸ”",
                    "æ­£åœ¨åšæ¢¦ï¼Œæ¢¦é‡Œå…¨æ˜¯å¥½åƒçš„ ğŸ’¤",
                    hasTraveled ? `ã€${lastLocation}ã€‘æœ‰ä»€ä¹ˆç‰¹äº§ç¾é£Ÿå‘¢ï¼ŸğŸ¤¤` : "åœ¨ç¿»å†°ç®±...",
                    hasTraveled ? `å›å‘³ç€åœ¨ã€${lastLocation}ã€‘åƒçš„å¤§é¤~` : "å–äº†ä¸€å¤§å£æœæ± ğŸ§ƒ"
                ],
                'æ–‡è‰º': [
                    "å®‰é™åœ°å‘å‘†ï¼Œæ€è€ƒæ—…è¡Œçš„æ„ä¹‰ ğŸƒ",
                    "æ­£åœ¨å†™éšç¬”æ—¥è®° âœï¸",
                    hasTraveled ? `ã€${lastLocation}ã€‘çš„é£æ™¯çœŸè®©æˆ‘éš¾å¿˜ã€‚` : "åœ¨å¬èˆ’ç¼“çš„éŸ³ä¹ ğŸ§",
                    hasTraveled ? `åœ¨ç”»ä¸€å¹…ã€${lastLocation}ã€‘çš„é£æ™¯ç”» ğŸ¨` : "ç¿»é˜…ç€åœ°ç†æ‚å¿—..."
                ]
            };

            if (contextOverride) {
                return `å“‡ï¼${contextOverride}ï¼Œå¤ªå¼€å¿ƒäº†ï¼âœ¨`;
            }
            const pool = aiTemplates[personality];
            return pool ? pool[Math.floor(Math.random() * pool.length)] : 'æ­£åœ¨æœŸå¾…æ—…è¡Œ... âœ¨';
        };

        showBubbleShort(generateText());
    }

    // --- å® ç‰©åºåˆ—å¸§åŠ¨ç”»ï¼šå¤šçŠ¶æ€ç®¡ç† ---
    function makeFrames(folder, prefix, count) {
        const frames = [];
        for (let i = 1; i <= count; i++) {
            const index = i.toString().padStart(3, '0');
            frames.push(`æ¯”å¡ä¸˜åŠ¨ç”»å¯¼å‡º/${folder}/${prefix}_${index}.png`);
        }
        return frames;
    }

    const petAnimationStates = {
        idle_wait: makeFrames('ç­‰å¾…', 'flog_dengdai', 6),
        idle_breath: makeFrames('å‘¼å¸', 'frog_idle', 6),
        idle_observe: makeFrames('è§‚å¯Ÿ', 'flog_guancha', 6),
        interact: makeFrames('äº’åŠ¨', 'flog_hudong', 6),
        rest: makeFrames('ä¼‘æ¯', 'flog_xiuxi', 6),
        eat: makeFrames('äº’åŠ¨', 'flog_hudong', 6),
        door: makeFrames('äº’åŠ¨', 'flog_hudong', 6),
        plant: makeFrames('å‘¼å¸', 'frog_idle', 6)
    };

    const petAnimation = {
        currentState: 'idle_breath',
        index: 0,
        timer: null
    };

    function playPetAnimation(stateKey, options = {}) {
        if (!petAvatarSprite) return;

        const frames = petAnimationStates[stateKey] && petAnimationStates[stateKey].length
            ? petAnimationStates[stateKey]
            : petAnimationStates.idle_breath;

        if (!frames || !frames.length) return;

        const loop = options.loop !== undefined ? options.loop : stateKey === 'idle_breath';
        const frameInterval = options.frameInterval || (stateKey === 'idle_breath' ? 800 : 200);
        const maxCycles = options.cycles || 2;

        // åˆ‡æ¢å›¾ç‰‡å¸§
        clearInterval(petAnimation.timer);
        petAnimation.currentState = stateKey;
        petAnimation.index = 0;
        petAvatarSprite.src = frames[0];

        let played = 0;
        petAnimation.timer = setInterval(() => {
            petAnimation.index = (petAnimation.index + 1) % frames.length;
            petAvatarSprite.src = frames[petAnimation.index];

            if (!loop) {
                played++;
                if (played >= frames.length * maxCycles) {
                    clearInterval(petAnimation.timer);
                    if (stateKey !== 'idle_breath') {
                        playPetAnimation('idle_breath', { loop: true, frameInterval: 800 });
                    }
                }
            }
        }, frameInterval);

        // åˆ‡æ¢å¯¹åº”çš„èº«ä½“åŠ¨æ•ˆ class
        const stateClassMap = {
            idle_wait: 'pet-anim-idle',
            idle_breath: 'pet-anim-idle',
            idle_observe: 'pet-anim-idle',
            interact: 'pet-anim-excited',
            rest: 'pet-anim-sleep',
            eat: 'pet-anim-eat',
            door: 'pet-anim-door',
            plant: 'pet-anim-plant'
        };

        Object.values(stateClassMap).forEach(cls => {
            petAvatarSprite.classList.remove(cls);
        });
        const cls = stateClassMap[stateKey] || stateClassMap.idle_breath;
        if (cls) {
            petAvatarSprite.classList.add(cls);
        }
    }

    function startIdleAnimation() {
        playPetAnimation('idle_breath', { loop: true, frameInterval: 800 });
    }

    function playExcitedAnimation() {
        setPetState(PET_STATES.INTERACT);
    }

    // åˆå§‹ä¸ä¸»åŠ¨å¯åŠ¨ï¼Œæ¯”å¡ä¸˜åœ¨é¦–æ¬¡è¿›å…¥å® ç‰©é¡µæ—¶å†æ¿€æ´»
    // ä½†å¦‚æœé»˜è®¤é¡µå°±æ˜¯å® ç‰©é¡µï¼ˆä¾‹å¦‚åç»­æ”¹åŠ¨ï¼‰ï¼Œåˆ™ç«‹å³å¯åŠ¨ä¸€æ¬¡
    const petViewEl = document.getElementById('view-petroom');
    if (petViewEl && petViewEl.classList.contains('active')) {
        enterPetRoom();
    }

    window.__triggerPetTapInteraction = function() {
        if (!petAvatarRoom) return;
        petAvatarRoom.style.transform = 'translate(-50%, -10px) scale(1.1)';
        setTimeout(() => { petAvatarRoom.style.transform = 'translateX(-50%)'; }, 200);
        markPetInteraction();
        triggerAIPetAction("ä¸»äººæ‘¸äº†æ‘¸æˆ‘çš„å¤´");
        setPetState(PET_STATES.INTERACT);
    };
    
    // ç‚¹å‡»å® ç‰©ä¹Ÿèƒ½è§¦å‘äº’åŠ¨
    if (petAvatarRoom) {
        petAvatarRoom.addEventListener('click', () => {
            if (ignoreNextPetClick) {
                ignoreNextPetClick = false;
                return;
            }
            window.__triggerPetTapInteraction();
        });

        // æ‚¬åœæ—¶çŸ­æš‚è¿›å…¥è§‚å¯ŸçŠ¶æ€ï¼Œç¦»å¼€åå›åˆ°å‘¼å¸
        petAvatarRoom.addEventListener('mouseenter', () => {
            if (petLife.current === PET_STATES.REST) return;
            markPetInteraction();
            setPetState(PET_STATES.IDLE_OBSERVE);
        });

        petAvatarRoom.addEventListener('mouseleave', () => {
            if (petLife.current === PET_STATES.IDLE_OBSERVE) {
                setPetState(PET_STATES.IDLE_BREATH);
            }
        });
    }

    // --- åœ°ç‚¹é£æ ¼æ•°æ®ä¸æ—¥è®°æ–‡æ¡ˆç”Ÿæˆ ---
    const cityFlavorMap = {
        // ç›´è¾–å¸‚ / ä¸€çº¿åŸå¸‚
        'åŒ—äº¬': {
            highlights: ['æ•…å®«åŸå¢™è¾¹', 'èƒ¡åŒå£çš„å°åº—å‰', 'å¤©å®‰é—¨å¹¿åœºæ—', 'åæµ·çš„æ¹–è¾¹', 'é•¿å®‰è¡—çš„ç¯å…‰ä¸‹'],
            tone: 'å†å²æ„Ÿ'
        },
        'ä¸Šæµ·': {
            highlights: ['å¤–æ»©æ±Ÿè¾¹', 'æ­¦åº·è·¯çš„å°é©¬è·¯ä¸Š', 'é»„æµ¦æ±Ÿçš„å¤œé£é‡Œ', 'é™†å®¶å˜´é«˜æ¥¼ä¹‹é—´', 'æ¢§æ¡æ ‘ä¸‹çš„å°å’–å•¡é¦†'],
            tone: 'ç°ä»£æ„Ÿ'
        },
        'å¹¿å·': {
            highlights: ['æ—©èŒ¶åº—çš„åœ†æ¡Œæ—', 'ä¸Šä¸‹ä¹çš„å°å··é‡Œ', 'ç æ±Ÿè¾¹çš„å¤œè‰²ä¸­', 'è€ç‰Œç³–æ°´é“ºé—¨å£'],
            tone: 'çƒŸç«æ°”'
        },
        'æ·±åœ³': {
            highlights: ['æµ·è¾¹æ•£æ­¥é“', 'é«˜æ¥¼ä¹‹é—´çš„ç©ºä¸­èŠ±å›­', 'ç§‘æŠ€å±•é¦†é—¨å£', 'åŸä¸­æ‘çš„å°åƒæ‘Šæ—'],
            tone: 'å¹´è½»æ„Ÿ'
        },

        // é‡ç‚¹æ—…æ¸¸åŸå¸‚
        'æ­å·': {
            highlights: ['è¥¿æ¹–è¾¹çš„é•¿æ¤…ä¸Š', 'æ–­æ¡¥æ®‹é›ªæ—', 'é¾™äº•èŒ¶ç”°çš„å±±å¡ä¸Š', 'æ…¢æ‚ æ‚ çš„å°å··é‡Œ'],
            tone: 'æ¸©æŸ”'
        },
        'è¥¿å®‰': {
            highlights: ['å¤åŸå¢™åŸé—¨ä¸‹', 'å›æ°‘è¡—çš„å°åƒæ‘Šå‰', 'å¤§é›å¡”å¹¿åœºè¾¹', 'åšç‰©é¦†çš„å±•æŸœå‰'],
            tone: 'åšé‡'
        },
        'æˆéƒ½': {
            highlights: ['ç«é”…åº—é—¨å£', 'å¤§ç†ŠçŒ«åŸºåœ°æ—', 'å®½çª„å··å­çš„çŸ³æ¿è·¯ä¸Š', 'å°é…’é¦†çš„æœ¨æ¤…ä¸Š'],
            tone: 'æ‚ é—²'
        },
        'é‡åº†': {
            highlights: ['é•¿æ±Ÿå¤§æ¡¥è¾¹', 'å±±åŸçš„å°é˜¶ä¸Š', 'è½»è½¨ä»æ¥¼é‡Œç©¿è¿‡çš„åœ°æ–¹', 'å¤œè‰²é‡Œçš„æ´ªå´–æ´å‰'],
            tone: 'ç«‹ä½“æ„Ÿ'
        },
        'å¦é—¨': {
            highlights: ['é¼“æµªå±¿çš„å°è·¯ä¸Š', 'æ²™æ»©è¾¹çš„è´å£³æ—', 'å’–å•¡é¦†çš„è½åœ°çª—å‰', 'æµ·é£å¹æ¥çš„æ ˆé“ä¸Š'],
            tone: 'æµ·é£'
        },
        'æ˜†æ˜': {
            highlights: ['æ»‡æ± æ¹–è¾¹', 'é²œèŠ±å¸‚åœºé‡Œ', 'çŸ³æ—çš„å¥‡çŸ³æ—', 'è“å¤©ä¸‹çš„è‰åœ°ä¸Š'],
            tone: 'å››å­£å¦‚æ˜¥'
        },
        'æ¡‚æ—': {
            highlights: ['æ¼“æ±Ÿè¾¹çš„ç«¹ç­ä¸Š', 'å±±æ°´å€’å½±å‰', 'ç”°é—´å°è·¯ä¸Š', 'äº‘é›¾ç¼­ç»•çš„å±±è„šä¸‹'],
            tone: 'å±±æ°´'
        },
        'é’å²›': {
            highlights: ['çº¢ç“¦ç™½å¢™çš„å°å¡é“ä¸Š', 'æ ˆæ¡¥å°½å¤´', 'æµ·é£å¹æ‹‚çš„ç¤çŸ³æ—', 'å•¤é…’è¡—çš„ç¯å…‰ä¸‹'],
            tone: 'æµ·æ¸¯'
        },

        // çœçº§æ¦‚æ‹¬ï¼ˆå¤§è‡´æ„è±¡ï¼‰
        'å¹¿ä¸œ': {
            highlights: ['è¡—è¾¹çš„çƒ§è…Šé“ºå‰', 'çƒ­æ°”è…¾è…¾çš„æ—©èŒ¶æ¡Œæ—', 'æµ·é£å¹æ¥çš„æ¸¯å£è¾¹', 'å¤œé‡Œè¿˜äº®ç€ç¯çš„éª‘æ¥¼ä¸‹'],
            tone: 'çƒ­é—¹'
        },
        'å¹¿è¥¿': {
            highlights: ['å–€æ–¯ç‰¹å±±è„šä¸‹', 'ç”°é—´å°è·¯ä¸Š', 'æ±Ÿè¾¹çš„ç«¹ç­ä¸Š', 'è¢«æ™šéœæŸ“çº¢çš„äº‘å±‚ä¸‹'],
            tone: 'å±±æ°´'
        },
        'æµ·å—': {
            highlights: ['ç»†è½¯çš„æ²™æ»©ä¸Š', 'æ‘‡æ™ƒçš„æ¤°å­æ ‘ä¸‹', 'æµ·æµªæ‹å²¸çš„ç¤çŸ³æ—', 'é»„æ˜çš„æµ·è¾¹å°è·¯ä¸Š'],
            tone: 'åº¦å‡æ„Ÿ'
        },
        'å››å·': {
            highlights: ['çƒ­æ°”ç¿»æ»šçš„ç«é”…åº—é‡Œ', 'é›ªå±±è„šä¸‹', 'è—å¯¨çš„å°æœ¨å±‹æ—', 'èŒ¶é¦†é‡Œçš„å°æ–¹æ¡Œæ—'],
            tone: 'è¾£ä¸å®‰é€¸'
        },
        'è´µå·': {
            highlights: ['è‹—å¯¨çš„åŠè„šæ¥¼å‰', 'äº‘é›¾ç¼­ç»•çš„å±±è°·é‡Œ', 'ç€‘å¸ƒé£æµç›´ä¸‹çš„è§‚æ™¯å°ä¸Š'],
            tone: 'ç§˜å¢ƒ'
        },
        'äº‘å—': {
            highlights: ['å¤åŸçš„çŸ³æ¿è·¯ä¸Š', 'èŠ±å›¢é”¦ç°‡çš„å°é™¢é‡Œ', 'è“å¤©ç™½äº‘ä¸‹çš„è‰ç”¸ä¸Š', 'é›ªå±±è¿œçœºçš„è§‚æ™¯å°è¾¹'],
            tone: 'å½©äº‘ä¹‹å—'
        },
        'æ¹–åŒ—': {
            highlights: ['é•¿æ±Ÿå¤§æ¡¥æ—', 'çƒ­å¹²é¢æ‘Šä½å‰', 'é»„é¹¤æ¥¼è„šä¸‹', 'æ¹–ç•”çš„æ­¥é“ä¸Š'],
            tone: 'æ±ŸåŸ'
        },
        'æ¹–å—': {
            highlights: ['å°ç‚’è‚‰é£˜é¦™çš„é¥­é¦†é‡Œ', 'å±±é—´äº‘é›¾ä¸­', 'å¤åŸåŸå¢™è¾¹', 'å¤œå®µæ‘Šçš„ä¸€ç›å°ç¯ä¸‹'],
            tone: 'çƒ­è¾£'
        },
        'æ²³å—': {
            highlights: ['å¤éƒ½åŸæ¥¼ä¸‹', 'å°‘æ—å¯ºå±±é—¨å‰', 'éº¦æµªç¿»æ»šçš„ç”°é‡è¾¹', 'é»„æ²³å²¸è¾¹çš„é£é‡Œ'],
            tone: 'ä¸­åŸ'
        },
        'å±±ä¸œ': {
            highlights: ['æµ·è¾¹çš„ç¤çŸ³ä¸Š', 'æ³°å±±çš„ç™»å±±è·¯ä¸Š', 'å¤§é¦’å¤´é¦™å‘³é£˜æ¥çš„å¨æˆ¿é—¨å£'],
            tone: 'åšå®'
        },
        'æ±Ÿè‹': {
            highlights: ['å°æ¡¥æµæ°´è¾¹', 'æ±Ÿå—å¤é•‡çš„çŸ³æ¿è·¯ä¸Š', 'æ¢§æ¡å¤¹é“çš„é©¬è·¯ä¸Š'],
            tone: 'æ¸©å©‰'
        },
        'æµ™æ±Ÿ': {
            highlights: ['èŒ¶ç”°çš„æ¢¯ç”°é—´', 'æ±Ÿå—å°é•‡çš„æ²³åŸ å¤´æ—', 'è¢«ç¯ç¬¼ç‚¹äº®çš„å°å··é‡Œ'],
            tone: 'ç»†è…»'
        },
        'æ±Ÿè¥¿': {
            highlights: ['åºå±±äº‘é›¾é‡Œ', 'æ‘å£çš„å¤æ ‘ä¸‹', 'å¾½æ´¾å¤å»ºç­‘å‰'],
            tone: 'å®‰é™'
        },
        'ç¦å»º': {
            highlights: ['åœŸæ¥¼çš„åœ†é™¢é‡Œ', 'æµ·è¾¹çš„ç¤çŸ³ä¸Š', 'è¢«æµ·é£å¹æ‹‚çš„åŸå¢™è¾¹'],
            tone: 'å±±æµ·ä¹‹é—´'
        },
        'é™•è¥¿': {
            highlights: ['å…µé©¬ä¿‘å±•å…å‰', 'å¤åŸå¢™ä¸Šéª‘è¡Œé“ä¸Š', 'è¡—å¤´è‚‰å¤¹é¦æ‘Šä½æ—'],
            tone: 'å†å²'
        },
        'ç”˜è‚ƒ': {
            highlights: ['å¤§æ¼ çš„é»„æ²™ä¸Š', 'æ˜Ÿç©ºä¸‹çš„è¥åœ°æ—', 'é©¼é˜Ÿèµ°è¿‡çš„è„šå°è¾¹'],
            tone: 'å¤§è¥¿åŒ—'
        },
        'é’æµ·': {
            highlights: ['é«˜åŸæ¹–æ³Šè¾¹', 'è“å¤©ç™½äº‘ä¸‹', 'ç‰¦ç‰›æ‚ é—²åƒè‰çš„è‰åœ°ä¸Š'],
            tone: 'çº¯å‡€'
        },
        'å®å¤': {
            highlights: ['è´ºå…°å±±è„šä¸‹', 'é»„æ²³å²¸è¾¹', 'è‘¡è„è—¤çš„é•¿å»Šé‡Œ'],
            tone: 'å¡ä¸Šæ±Ÿå—'
        },
        'æ–°ç–†': {
            highlights: ['å¹¿é˜”çš„è‰åŸä¸Š', 'é›ªå±±è„šä¸‹', 'ç“œæœé£˜é¦™çš„å·´æ‰é‡Œ', 'æ˜Ÿæ²³å¦‚ç€‘çš„å¤œç©ºä¸‹'],
            tone: 'è¾½é˜”'
        },
        'è¥¿è—': {
            highlights: ['ç»å¹¡é£˜åŠ¨çš„å±±å£ä¸Š', 'å¸ƒè¾¾æ‹‰å®«è„šä¸‹', 'äº‘æµ·ç¿»æ»šçš„å±±è°·é‡Œ'],
            tone: 'é«˜åŸ'
        },
        'å°æ¹¾': {
            highlights: ['å¤œå¸‚æ‘Šä½å‰', 'æµ·å²¸å…¬è·¯æ—', 'å°é•‡çš„å¡é“ä¸Š'],
            tone: 'æš–æš–'
        },
        'é¦™æ¸¯': {
            highlights: ['ç»´æ¸¯çš„å¤œæ™¯å‰', 'ç¼†è½¦æ…¢æ…¢ä¸Šå‡çš„å±±è…°ä¸Š', 'è¡—è§’èŒ¶é¤å…é—¨å£'],
            tone: 'ç¹å'
        },
        'æ¾³é—¨': {
            highlights: ['å¤§ä¸‰å·´ç‰ŒåŠå‰', 'çŸ³æ¿è·¯çš„å°å··é‡Œ', 'ç¯å…‰é—ªçƒçš„æµ·è¾¹'],
            tone: 'å¤å¤'
        }
    };

    // --- è°ƒç”¨ OpenRouter ç”Ÿæˆ AIGC æ—¥è®°æ–‡æ¡ˆ ---
    async function generateDiaryWithAIGC(location, personality) {
        const normalized = normalizeLocationName(location);
        const flavor = cityFlavorMap[normalized];
        const visitIndex = appState.locations.length;
        const date = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');

        const flavorText = flavor
            ? `\n- å½“åœ°æ°›å›´å…³é”®è¯ï¼š${flavor.tone}ã€‚\n- ä½ ä»¬å¯èƒ½ä¼šå‡ºç°åœ¨ï¼š${flavor.highlights.slice(0, 3).join('ã€')}ã€‚`
            : '';
        const progressText = visitIndex > 1
            ? `è¿™æ˜¯æˆ‘ä»¬ç¬¬ ${visitIndex} æ¬¡æ—…è¡Œæ‰“å¡ã€‚`
            : 'è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡çœŸæ­£å‡ºå‘ã€‚';

        const prompt = [
            'ä½ æ˜¯ä¸€åªç”µå­å® ç‰©ç©å¶ï¼Œç”¨ç¬¬ä¸€äººç§°ä¸ºä¸»äººå†™ä¸€æ®µæ—…è¡Œæ—¥è®°ã€‚',
            `- æˆ‘çš„æ€§æ ¼ï¼š${personality}ï¼ˆè¯·åœ¨è¯­æ°”å’Œç”¨è¯ä¸Šè‡ªç„¶ä½“ç°è¿™ç§æ€§æ ¼ç‰¹ç‚¹ï¼‰ã€‚`,
            `- æˆ‘ä»¬æ­£åœ¨ï¼š${location}ã€‚${flavorText}`,
            `- ä»Šå¤©çš„æ—¥æœŸï¼š${date}ã€‚${progressText}`,
            'è¦æ±‚ï¼š80ï½200 å­—ï¼Œæ²»æ„ˆã€è½»æ¾ï¼Œæœ‰ç”»é¢æ„Ÿï¼›ä¸è¦è™šæ„ä¸»äººæ²¡æœ‰è¾“å…¥çš„åœ°ç‚¹æˆ–ä»»ä½•éšç§ä¿¡æ¯ã€‚',
            'åªè¾“å‡ºæ—¥è®°æ­£æ–‡ï¼Œä¸è¦æ ‡é¢˜æˆ–é¢å¤–è§£é‡Šã€‚'
        ].join('\n');

        const body = {
            model: OPENROUTER_MODEL_ID,
            messages: [
                {
                    role: 'system',
                    content: 'ä½ æ˜¯ä¸€åªå¯çˆ±ã€æ²»æ„ˆç³»çš„ç”µå­å® ç‰©ï¼Œç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ç»™ä¸»äººå†™æ—…è¡Œæ—¥è®°ã€‚è¯­è¨€è½»æ¾ã€æœ‰ç”»é¢æ„Ÿï¼Œé¿å…è´Ÿé¢æƒ…ç»ªå’Œä¸å½“å†…å®¹ã€‚'
                },
                {
                    role: 'user',
                    content: prompt
                }
            ]
        };

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);

        try {
            const response = await fetch(AIGC_API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body),
                signal: controller.signal
            });

            if (!response.ok) {
                return { ok: false, error: `http_${response.status}` };
            }

            const data = await response.json();
            const content = data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;

            if (!content || typeof content !== 'string') {
                return { ok: false, error: 'empty_content' };
            }

            return { ok: true, content: content.trim() };
        } catch (error) {
            if (error.name === 'AbortError') {
                return { ok: false, error: 'timeout' };
            }
            console.error('[Diary AIGC] OpenRouter è¯·æ±‚å¼‚å¸¸:', error.message || error);
            return { ok: false, error: 'network' };
        } finally {
            clearTimeout(timeoutId);
        }
    }

    function buildDiaryText(location, personality) {
        const normalized = normalizeLocationName(location);
        const flavor = cityFlavorMap[normalized];
        const visitIndex = appState.locations.length;
        const progressText = visitIndex > 1 ? `è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬${visitIndex}æ¬¡æ—…è¡Œæ‰“å¡ã€‚` : 'è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡çœŸæ­£å‡ºå‘ã€‚';

        const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const spots = (flavor && flavor.highlights) || [];
        const h1 = spots.length ? pick(spots) : '';
        const h2 = spots.length > 1 ? pick(spots.filter((s) => s !== h1)) : '';

        // æ ¹æ®æ€§æ ¼ + åŸå¸‚é£æ ¼ç»„åˆç”Ÿæˆæ–‡æ¡ˆ
        if (personality === 'æ´»æ³¼') {
            if (flavor) {
                return `è€¶ï¼ä»Šå¤©æˆ‘ä»¬è§£é”äº†ã€${location}ã€‘ï¼åœ¨${h1}${h2 ? `ï¼Œåˆä¸€è·¯è¹¦è¹¦è·³è·³è·‘åˆ°${h2}` : ''}ï¼Œç¬‘å£°å·®ç‚¹æŠŠç›¸æœºéƒ½æ™ƒç³Šäº†ã€‚${progressText}`;
            }
            return `è€¶ï¼ä»Šå¤©æˆ‘ä»¬æ¥åˆ°äº†ã€${location}ã€‘ï¼ä¸€è·¯å°è·‘ç€åˆ°å¤„å¼ æœ›ï¼Œæ„Ÿè§‰æ•´åº§åŸå¸‚éƒ½åœ¨å‘æˆ‘ä»¬æ‰“æ‹›å‘¼ã€‚${progressText}`;
        }

        if (personality === 'è´ªåƒ') {
            if (flavor) {
                return `ç»ˆäºåˆ°ã€${location}ã€‘äº†ï¼é¼»å­åœ¨${h1}${h2 ? `å’Œ${h2}` : ''}ä¹‹é—´æ¥å›å·¡é€»ï¼Œç”Ÿæ€•é”™è¿‡ä¸€å£å¥½åƒçš„ã€‚${progressText}`;
            }
            return `ç»ˆäºæŠµè¾¾ã€${location}ã€‘ï¼æ¯”èµ·é£æ™¯ï¼Œæˆ‘æ›´ä¸“æ³¨è¡—è¾¹é£˜æ¥çš„å‘³é“ï¼Œå‡†å¤‡æŠŠè¿™é‡Œçš„ç¾é£Ÿè®°åˆ°ä¸“å±æ¸…å•é‡Œã€‚${progressText}`;
        }

        // æ–‡è‰ºæ€§æ ¼
        if (flavor) {
            return `é£è½»è½»å¹è¿‡ã€${location}ã€‘çš„è¡—é“ï¼Œæˆ‘åœ¨${h1}${h2 ? `ï¼Œåˆåœ¨${h2}` : ''}åœä¸‹è„šæ­¥ï¼ŒæŠŠä»Šå¤©çš„å…‰å½±éƒ½å†™è¿›å°å°çš„æ—…è¡Œæ—¥è®°ã€‚${progressText}`;
        }
        return `é£å¹è¿‡ã€${location}ã€‘çš„è¡—é“ï¼Œæˆ‘æ…¢æ…¢èµ°ã€æ…¢æ…¢çœ‹ï¼ŒæŠŠæ¯ä¸€æ¬¡å¿ƒè·³éƒ½æŠ˜æˆä¹¦ç­¾ï¼Œå¤¹åœ¨è®°å¿†çš„è¿™ä¸€é¡µã€‚${progressText}`;
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ—¥è®° ---
    function generateDiaryEntry(location, content, sceneOverride) {
        const date = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');
        const personality = appState.petPersonality;
        const avatar = appState.petAvatars[personality];
        const scene = sceneOverride !== undefined ? sceneOverride : getSceneAsset(location);
        
        const text = content && typeof content === 'string' && content.trim()
            ? content.trim()
            : buildDiaryText(location, personality);

        const sceneImageBlock = scene ? `
            <img src="${scene.image}" alt="${scene.label}" class="w-16 h-16 rounded-xl object-cover border border-white shadow-sm mb-2">
        ` : '';

        const diaryHTML = `
            <div class="glass-card rounded-2xl p-4 transform transition-all hover:scale-[1.01] shadow-sm animate-[fadeIn_0.5s_ease-out]">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-white bg-[#cdb4db] px-2 py-1 rounded-md">${date}</span>
                    <span class="text-xs text-gray-500 font-bold"><i class="ph-fill ph-map-pin text-[#ff8fab]"></i> ${location}</span>
                </div>
                <div class="flex gap-3">
                    <div class="flex flex-col items-center">
                        ${sceneImageBlock}
                        <div class="text-3xl bg-white rounded-xl p-2 h-fit shadow-inner">${avatar}</div>
                    </div>
                    <p class="text-gray-700 text-sm leading-relaxed">${text}</p>
                </div>
            </div>
        `;
        diaryList.insertAdjacentHTML('afterbegin', diaryHTML);
        diaryBadge.classList.remove('hidden'); // æ˜¾ç¤ºæ—¥è®°æœªè¯»çº¢ç‚¹
        if (actionDiaryBadge) actionDiaryBadge.classList.remove('hidden');
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šåœ¨æ©±æŸœä¸­æ–°å¢çºªå¿µå“ ---
    const CABINET_SLOTS = 12;
    const cabinetPlaceholderHTML = `<div class="cabinet-slot cabinet-slot--empty" data-placeholder="cabinet-empty"><img src="assets/cabinet-empty.svg" alt="æ©±æŸœ" class="cabinet-empty-icon mb-1" width="40" height="40"><span>å»æ—…è¡Œè§£é”</span></div>`;

    function renderCabinetGrid() {
        if (!cabinetGrid) return;
        const list = appState.cabinetItems || [];
        let html = '';
        for (let i = 0; i < CABINET_SLOTS; i++) {
            const item = list[i];
            if (item && (item.scene || item.location)) {
                const scene = item.scene;
                const label = scene ? scene.label : item.location;
                const img = scene ? `<img src="${scene.image}" alt="${scene.label}" class="w-12 h-12 rounded-xl object-cover mb-1 border border-[#d4c4a8] shadow-sm" onerror="this.style.display='none';this.nextElementSibling&&this.nextElementSibling.classList.remove('hidden');">` : '';
                const fallback = scene ? `<span class="text-2xl mb-1 hidden">ğŸ§³</span>` : `<span class="text-2xl mb-1">ğŸ§³</span>`;
                html += `<div class="cabinet-slot" data-cabinet-item="true">${img}${fallback}<span class="font-bold truncate max-w-[80px]">${escapeHtml(label)}</span></div>`;
            } else {
                html += cabinetPlaceholderHTML;
            }
        }
        cabinetGrid.innerHTML = html;
    }

    function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function addCabinetItem(location, sceneOverride) {
        if (!cabinetGrid) return;
        const scene = sceneOverride !== undefined ? sceneOverride : getSceneAsset(location);
        appState.cabinetItems = appState.cabinetItems || [];
        appState.cabinetItems.unshift({ location, scene });
        if (appState.cabinetItems.length > CABINET_SLOTS) {
            appState.cabinetItems = appState.cabinetItems.slice(0, CABINET_SLOTS);
        }
        renderCabinetGrid();
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šåœ°å›¾é¡µåœºæ™¯é¢„è§ˆå¡ç‰‡ ---
    function showScenePreview(location, sceneOverride) {
        if (!scenePreview) return;
        const scene = sceneOverride !== undefined ? sceneOverride : getSceneAsset(location);
        if (!scene) return;

        const previewHTML = `
            <div class="glass-card rounded-2xl p-3 flex items-center gap-3 animate-[fadeIn_0.4s_ease-out]">
                <img src="${scene.image}" alt="${scene.label}" class="w-16 h-16 rounded-xl object-cover border border-white shadow-sm">
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-gray-500">è§£é”è¿œè¡Œåœºæ™¯</span>
                    <span class="text-sm font-bold text-gray-800">${scene.label}</span>
                    <span class="text-[10px] text-gray-500 mt-1">å·²åŒæ­¥åˆ°æ—…è¡Œæ©±æŸœä¸æ—…è¡Œæ—¥è®°æ’å›¾</span>
                </div>
            </div>
        `;
        scenePreview.innerHTML = previewHTML;
        scenePreview.classList.remove('hidden');
    }

    renderCabinetGrid();
</script>
</body>
</html>